// Simple message function for initial use
        function showMessage(message, type = 'info') {
            // Create a simple message element if the container doesn't exist yet
            let messagesContainer = document.getElementById('messages');
            if (!messagesContainer) {
                messagesContainer = document.createElement('div');
                messagesContainer.id = 'messages';
                messagesContainer.className = 'fixed top-4 right-4 z-50';
                document.body.appendChild(messagesContainer);
            }
            
            const messageEl = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            
            messageEl.className = `${bgColor} text-white px-6 py-3 rounded-md shadow-lg mb-2 transform transition-all duration-300`;
            messageEl.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 5000);
        }        // Load developers
        async function loadDevelopers() {
            try {
                const { data: developers, error } = await supabase
                    .from('developers')
                    .select('id, name, description')
                    .eq('is_active', true)
                    .order('name');

                if (error) {
                    console.log('Error loading developers:', error);
                    return;
                }

                const select = document.getElementById('developer_id');
                select.innerHTML = '<option value="">Seleccionar desarrollador...</option>';
                
                developers.forEach(developer => {
                    const option = document.createElement('option');
                    option.value = developer.id;
                    option.textContent = developer.name;
                    select.appendChild(option);
                });
                
                console.log('Desarrolladores cargados:', developers.length);
            } catch (error) {
                console.error('Error loading developers:', error);
            }
        }<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Propiedades - CLIC Inmobiliaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .field-group { border-left: 4px solid #e5e7eb; padding-left: 1rem; }
        .field-group.required { border-left-color: #ef4444; }
        .field-group.project { border-left-color: #3b82f6; }
        .image-preview { max-width: 150px; max-height: 150px; object-fit: cover; }
        .gallery-item { position: relative; display: inline-block; margin: 0.5rem; }
        .gallery-item img { border-radius: 0.5rem; }
        .gallery-item .remove-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ef4444; 
            color: white; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-building mr-2 text-blue-600"></i>
                        Administrador de Propiedades
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button id="newPropertyBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nueva Propiedad
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Propiedad</label>
                    <input type="text" id="searchInput" placeholder="ID, código, nombre..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                    <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="Publicada">Publicada</option>
                        <option value="Borrador">Borrador</option>
                        <option value="Vendida">Vendida</option>
                        <option value="Alquilada">Alquilada</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="0">Solo Propiedades</option>
                        <option value="1">Solo Proyectos</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="searchBtn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>Buscar
                    </button>
                </div>
            </div>
        </div>

        <!-- Property List -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6 border-b">
                <h2 class="text-lg font-medium text-gray-900">Lista de Propiedades</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="propertyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Property Form -->
        <div id="propertyForm" class="bg-white rounded-lg shadow" style="display: none;">
            <div class="p-6 border-b">
                <h2 class="text-lg font-medium text-gray-900">
                    <span id="formTitle">Editar Propiedad</span>
                    <span id="propertyId" class="text-sm text-gray-500 ml-2"></span>
                </h2>
            </div>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex">
                    <button class="tab-btn active py-2 px-4 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="basic">
                        <i class="fas fa-info-circle mr-2"></i>Información Básica
                    </button>
                    <button class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="details">
                        <i class="fas fa-list-ul mr-2"></i>Detalles
                    </button>
                    <button class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="prices">
                        <i class="fas fa-dollar-sign mr-2"></i>Precios
                    </button>
                    <button class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="images">
                        <i class="fas fa-images mr-2"></i>Imágenes
                    </button>
                    <button class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="location">
                        <i class="fas fa-map-marker-alt mr-2"></i>Ubicación
                    </button>
                    <button class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="project">
                        <i class="fas fa-building mr-2"></i>Proyecto
                    </button>
                    <button class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="seo">
                        <i class="fas fa-search mr-2"></i>SEO
                    </button>
                </nav>
            </div>

            <form id="mainForm" class="p-6">
                <!-- Basic Information Tab -->
                <div id="basic" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-group required">
                            <h3 class="font-medium text-gray-900 mb-4">Información Principal</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Código *</label>
                                    <input type="number" name="code" id="code" required min="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Código Interno</label>
                                    <input type="text" name="internal_code" id="internal_code"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                                    <input type="text" name="name" id="name" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Privado</label>
                                    <input type="text" name="private_name" id="private_name"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Slug URL *</label>
                                    <div class="flex">
                                        <input type="text" name="slug_url" id="slug_url" required
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <button type="button" id="generateSlugBtn" 
                                                class="px-4 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md hover:bg-gray-200">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Estado y Tipo</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado de la Propiedad</label>
                                    <select name="property_status" id="property_status"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Borrador">Borrador</option>
                                        <option value="Publicada">Publicada</option>
                                        <option value="Vendida">Vendida</option>
                                        <option value="Alquilada">Alquilada</option>
                                        <option value="Retirada">Retirada</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Disponibilidad</label>
                                    <select name="availability" id="availability"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="1">Disponible</option>
                                        <option value="0">No Disponible</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="is_project" id="is_project" class="mr-2">
                                        <span class="text-sm font-medium text-gray-700">Es un Proyecto</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="featured" id="featured" class="mr-2">
                                        <span class="text-sm font-medium text-gray-700">Propiedad Destacada</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                        <textarea name="description" id="description" rows="6"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Details Tab -->
                <div id="details" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Características Físicas</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Habitaciones</label>
                                    <input type="number" name="bedrooms" id="bedrooms" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Baños</label>
                                    <input type="number" name="bathrooms" id="bathrooms" min="0" step="0.5"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parqueos</label>
                                    <input type="number" name="parking_spots" id="parking_spots" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Áreas</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Área Construida (m²)</label>
                                    <input type="number" name="built_area" id="built_area" min="0" step="0.01"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Área del Terreno (m²)</label>
                                    <input type="number" name="land_area" id="land_area" min="0" step="0.01"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Niveles</label>
                                    <input type="number" name="levels" id="levels" min="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Fechas</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Entrega</label>
                                    <input type="date" name="delivery_date" id="delivery_date"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Liberación</label>
                                    <input type="date" name="release_date" id="release_date"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Año de Construcción</label>
                                    <input type="number" name="construction_year" id="construction_year" min="1900" max="2050"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Relaciones</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                                    <select name="category_id" id="category_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Agente Asignado</label>
                                    <select name="agent_id" id="agent_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Sin agente asignado</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Información Adicional</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Condición</label>
                                    <select name="condition" id="condition"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar...</option>
                                        <option value="Nueva">Nueva</option>
                                        <option value="Excelente">Excelente</option>
                                        <option value="Buena">Buena</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Necesita Reparaciones">Necesita Reparaciones</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Orientación</label>
                                    <select name="orientation" id="orientation"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar...</option>
                                        <option value="Norte">Norte</option>
                                        <option value="Sur">Sur</option>
                                        <option value="Este">Este</option>
                                        <option value="Oeste">Oeste</option>
                                        <option value="Noreste">Noreste</option>
                                        <option value="Noroeste">Noroeste</option>
                                        <option value="Sureste">Sureste</option>
                                        <option value="Suroeste">Suroeste</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prices Tab -->
                <div id="prices" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Precios de Venta</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Precio de Venta</label>
                                    <div class="flex">
                                        <select name="sale_currency" id="sale_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="sale_price" id="sale_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Precio Original</label>
                                    <input type="number" name="original_price" id="original_price" min="0" step="0.01"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Precios de Alquiler</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alquiler Mensual</label>
                                    <div class="flex">
                                        <select name="rental_currency" id="rental_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="rental_price" id="rental_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alquiler Amueblado</label>
                                    <div class="flex">
                                        <select name="furnished_rental_currency" id="furnished_rental_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="furnished_rental_price" id="furnished_rental_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alquiler Temporal (por noche)</label>
                                    <div class="flex">
                                        <select name="temp_rental_currency" id="temp_rental_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="temp_rental_price" id="temp_rental_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Precios Adicionales</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Precio Amueblado (Venta)</label>
                                    <div class="flex">
                                        <select name="furnished_sale_currency" id="furnished_sale_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="furnished_sale_price" id="furnished_sale_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mantenimiento</label>
                                    <div class="flex">
                                        <select name="maintenance_currency" id="maintenance_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="maintenance_price" id="maintenance_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Separación</label>
                                    <div class="flex">
                                        <select name="separation_currency" id="separation_currency" class="px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="USD">USD</option>
                                            <option value="DOP">DOP</option>
                                        </select>
                                        <input type="number" name="separation_price" id="separation_price" min="0" step="0.01"
                                               class="flex-1 px-3 py-2 border border-l-0 border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Comisiones</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comisión Venta (%)</label>
                                    <input type="number" name="sale_commission" id="sale_commission" min="0" max="100" step="0.1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comisión Alquiler (%)</label>
                                    <input type="number" name="rental_commission" id="rental_commission" min="0" max="100" step="0.1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="shared_commission" id="shared_commission" class="mr-2">
                                        <span class="text-sm font-medium text-gray-700">Comisión Compartida</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Configuración Adicional</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Unidad</label>
                                    <input type="text" name="unit_number" id="unit_number"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">País</label>
                                    <select name="country_id" id="country_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar país...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Provincia</label>
                                    <select name="province_id" id="province_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar provincia...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Images Tab -->
                <div id="images" class="tab-content">
                    <div class="space-y-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Imagen Principal</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">URL de Imagen Principal</label>
                                    <input type="url" name="main_image_url" id="main_image_url"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div id="mainImagePreview" class="hidden">
                                    <img class="image-preview border rounded-md" alt="Vista previa de imagen principal">
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Galería de Imágenes</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">URLs de Galería (una por línea o separadas por comas)</label>
                                    <textarea name="gallery_images_url" id="gallery_images_url" rows="6"
                                              placeholder="https://ejemplo.com/imagen1.jpg&#10;https://ejemplo.com/imagen2.jpg"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <button type="button" id="previewGalleryBtn" class="bg-blue-100 text-blue-800 px-4 py-2 rounded-md hover:bg-blue-200">
                                        <i class="fas fa-eye mr-2"></i>Vista Previa de Galería
                                    </button>
                                </div>
                                <div id="galleryPreview" class="hidden border rounded-md p-4">
                                    <h4 class="font-medium text-gray-900 mb-3">Vista Previa de la Galería</h4>
                                    <div id="galleryContainer" class="flex flex-wrap"></div>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Imagen de Planos</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">URL de Planos</label>
                                    <input type="url" name="floor_plan_url" id="floor_plan_url"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Tab -->
                <div id="location" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Ubicación</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
                                    <select name="city_id" id="city_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar ciudad...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sector</label>
                                    <select name="sector_id" id="sector_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar sector...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dirección</label>
                                    <textarea name="address" id="address" rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Coordenadas</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Latitud</label>
                                    <input type="number" name="latitude" id="latitude" step="any"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Longitud</label>
                                    <input type="number" name="longitude" id="longitude" step="any"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <button type="button" id="getLocationBtn" class="bg-green-100 text-green-800 px-4 py-2 rounded-md hover:bg-green-200 w-full">
                                        <i class="fas fa-map-marker-alt mr-2"></i>Obtener Ubicación Actual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Información Adicional de Ubicación</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Código Postal</label>
                                    <input type="text" name="postal_code" id="postal_code"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Zona/Barrio</label>
                                    <input type="text" name="neighborhood" id="neighborhood"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Tab -->
                <div id="project" class="tab-content">
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
                        <p class="text-blue-800 text-sm">
                            <i class="fas fa-info-circle mr-2"></i>
                            Esta sección solo aplica si la propiedad es parte de un proyecto. Marque la casilla "Es un Proyecto" en la pestaña básica.
                        </p>
                    </div>

                    <div class="space-y-6">
                        <div class="field-group project">
                            <h3 class="font-medium text-gray-900 mb-4">Información del Proyecto</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ID del Detalle del Proyecto</label>
                                    <input type="number" name="project_detail_id" id="project_detail_id"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Proyecto</label>
                                    <input type="text" name="project_name" id="project_name"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Desarrollador</label>
                                    <select name="developer_id" id="developer_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar desarrollador...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fase del Proyecto</label>
                                    <select name="project_phase" id="project_phase"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar fase...</option>
                                        <option value="Planeación">Planeación</option>
                                        <option value="Construcción">En Construcción</option>
                                        <option value="Preventa">Pre-venta</option>
                                        <option value="Venta">En Venta</option>
                                        <option value="Entrega">En Entrega</option>
                                        <option value="Completado">Completado</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field-group project">
                            <h3 class="font-medium text-gray-900 mb-4">Detalles del Proyecto</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción del Proyecto</label>
                                    <textarea name="project_description" id="project_description" rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Total de Unidades</label>
                                        <input type="number" name="total_units" id="total_units" min="1"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Unidades Disponibles</label>
                                        <input type="number" name="available_units" id="available_units" min="0"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Progreso de Construcción (%)</label>
                                        <input type="number" name="construction_progress" id="construction_progress" min="0" max="100"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field-group project">
                            <h3 class="font-medium text-gray-900 mb-4">Relaciones del Proyecto</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fase del Proyecto</label>
                                    <select name="project_phase_id" id="project_phase_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar fase...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipología del Proyecto</label>
                                    <select name="project_typology_id" id="project_typology_id"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar tipología...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEO Tab -->
                <div id="seo" class="tab-content">
                    <div class="space-y-6">
                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">SEO Básico</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Título SEO</label>
                                    <input type="text" name="meta_title" id="meta_title" maxlength="60"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Máximo 60 caracteres. Si está vacío, se generará automáticamente.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción SEO</label>
                                    <textarea name="meta_description" id="meta_description" rows="3" maxlength="160"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    <p class="text-xs text-gray-500 mt-1">Máximo 160 caracteres. Si está vacío, se generará automáticamente.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Palabras Clave</label>
                                    <input type="text" name="meta_keywords" id="meta_keywords"
                                           placeholder="casa, venta, santiago, 3 habitaciones"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Separar con comas.</p>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">URL y Canonicalización</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">URL Canónica</label>
                                    <input type="url" name="canonical_url" id="canonical_url"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="index_page" id="index_page" class="mr-2" checked>
                                        <span class="text-sm font-medium text-gray-700">Permitir indexación en buscadores</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="follow_links" id="follow_links" class="mr-2" checked>
                                        <span class="text-sm font-medium text-gray-700">Seguir enlaces en esta página</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="field-group">
                            <h3 class="font-medium text-gray-900 mb-4">Schema.org / Datos Estructurados</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Schema</label>
                                    <select name="schema_type" id="schema_type"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="RealEstateListing">RealEstateListing</option>
                                        <option value="Apartment">Apartment</option>
                                        <option value="House">House</option>
                                        <option value="SingleFamilyResidence">SingleFamilyResidence</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Datos Estructurados Adicionales (JSON-LD)</label>
                                    <textarea name="custom_schema" id="custom_schema" rows="6"
                                              placeholder='{"@context": "https://schema.org", "@type": "RealEstateListing", ...}'
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="border-t pt-6 mt-6">
                    <div class="flex justify-between">
                        <button type="button" id="cancelBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <div class="space-x-2">
                            <button type="button" id="saveAsDraftBtn" class="bg-yellow-600 text-white px-6 py-2 rounded-md hover:bg-yellow-700 transition-colors">
                                <i class="fas fa-save mr-2"></i>Guardar como Borrador
                            </button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                <i class="fas fa-check mr-2"></i>Guardar y Publicar
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messages" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Wait for Supabase library to load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Supabase is loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded. Please check your internet connection.');
                showMessage('Error: No se pudo cargar la librería de Supabase. Verifique su conexión a internet.', 'error');
                return;
            }

            // Supabase Configuration
            const SUPABASE_URL = 'https://pacewqgypevfgjmdsorz.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhY2V3cWd5cGV2ZmdqbWRzb3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NjU4OTksImV4cCI6MjA2NDI0MTg5OX0.Qlg-UVy-sikr76GxYmTcfCz1EnAqPHxvFeLrdqnjuWs';
            
            // Initialize Supabase client
            try {
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase client initialized successfully');
                
                // Initialize the application
                initializeApp();
            } catch (error) {
                console.error('❌ Error initializing Supabase:', error);
                showMessage('Error inicializando Supabase: ' + error.message, 'error');
            }
        });

        // Global variables
        let currentProperty = null;
        let isEditing = false;

        // Initialize the application
        function initializeApp() {
            initializeTabs();
            initializeEventListeners();
            checkDatabaseSchema();
            loadInitialData();
            loadProperties();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // This is now handled in the main DOMContentLoaded listener above
        });

        // Check database schema to identify available fields
        async function checkDatabaseSchema() {
            try {
                console.log('🔍 Verificando esquema de la base de datos...');
                
                // Test query to see what fields are available
                const { data: testProperty, error } = await window.supabaseClient
                    .from('properties')
                    .select('*')
                    .limit(1)
                    .single();

                if (!error && testProperty) {
                    console.log('📊 Campos disponibles en properties:', Object.keys(testProperty));
                    
                    // Hide fields that don't exist
                    const optionalFields = [
                        'featured', 'levels', 'construction_year', 'original_price', 
                        'maintenance_fee', 'hoa_fee', 'min_price', 'min_down_payment',
                        'total_units', 'available_units', 'construction_progress',
                        'condition', 'orientation', 'postal_code', 'neighborhood',
                        'project_name', 'project_description', 'project_amenities'
                    ];
                    
                    optionalFields.forEach(fieldName => {
                        if (!testProperty.hasOwnProperty(fieldName)) {
                            const element = document.getElementById(fieldName);
                            if (element) {
                                const container = element.closest('.field-group') || element.parentElement;
                                if (container) {
                                    container.style.display = 'none';
                                    console.log(`⚠️ Campo no encontrado, ocultando: ${fieldName}`);
                                }
                            }
                        }
                    });
                } else {
                    console.log('ℹ️ No hay propiedades para verificar el esquema');
                }
            } catch (error) {
                console.error('Error verificando esquema:', error);
            }
        }

        // Tab functionality
        function initializeTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Remove active class from all tabs and contents
                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        b.classList.add('border-transparent', 'text-gray-500');
                    });
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active', 'border-blue-500', 'text-blue-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // Event listeners
        function initializeEventListeners() {
            // Search and filter
            document.getElementById('searchBtn').addEventListener('click', loadProperties);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loadProperties();
            });

            // Form actions
            document.getElementById('newPropertyBtn').addEventListener('click', createNewProperty);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            document.getElementById('saveBtn').addEventListener('click', saveProperty);
            document.getElementById('saveAsDraftBtn').addEventListener('click', () => saveProperty(true));
            document.getElementById('mainForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProperty();
            });

            // Slug generation
            document.getElementById('generateSlugBtn').addEventListener('click', generateSlug);
            document.getElementById('name').addEventListener('input', function() {
                if (!document.getElementById('slug_url').value) {
                    generateSlug();
                }
            });

            // Image previews
            document.getElementById('main_image_url').addEventListener('input', updateMainImagePreview);
            document.getElementById('previewGalleryBtn').addEventListener('click', updateGalleryPreview);

            // Location services
            document.getElementById('getLocationBtn').addEventListener('click', getCurrentLocation);
            document.getElementById('country_id').addEventListener('change', loadProvinces);
            document.getElementById('province_id').addEventListener('change', loadCitiesForProvince);
            document.getElementById('city_id').addEventListener('change', loadSectors);

            // Project checkbox
            document.getElementById('is_project').addEventListener('change', toggleProjectFields);
        }

        // Load initial data (categories, cities, agents, etc.)
        async function loadInitialData() {
            try {
                showMessage('Cargando datos iniciales...', 'info');
                
                await Promise.all([
                    loadCategories(),
                    loadCountries(),
                    loadCities(),
                    loadAgents(),
                    loadDevelopers()
                ]);
                
                console.log('Datos iniciales cargados exitosamente');
            } catch (error) {
                console.error('Error loading initial data:', error);
                showMessage('Error cargando datos iniciales: ' + error.message, 'error');
            }
        }

        // Load properties with filters
        async function loadProperties() {
            const searchTerm = document.getElementById('searchInput').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            try {
                showMessage('Cargando propiedades...', 'info');
                
                let query = window.supabaseClient
                    .from('properties')
                    .select(`
                        id, code, internal_code, name, private_name, slug_url, 
                        property_status, availability, is_project, 
                        sale_price, sale_currency, rental_price, rental_currency,
                        bedrooms, bathrooms, parking_spots, built_area, land_area,
                        main_image_url, delivery_date, release_date,
                        property_categories(id, name),
                        cities(id, name),
                        sectors(id, name),
                        users(id, first_name, last_name, email)
                    `)
                    .order('created_at', { ascending: false });

                // Apply filters
                if (searchTerm) {
                    if (!isNaN(searchTerm)) {
                        query = query.or(`id.eq.${searchTerm},code.eq.${searchTerm}`);
                    } else {
                        query = query.or(`name.ilike.%${searchTerm}%,private_name.ilike.%${searchTerm}%,internal_code.ilike.%${searchTerm}%`);
                    }
                }
                
                if (statusFilter) {
                    query = query.eq('property_status', statusFilter);
                }
                
                if (typeFilter !== '') {
                    query = query.eq('is_project', typeFilter === '1');
                }

                const { data: properties, error } = await query;

                if (error) {
                    throw error;
                }

                console.log('Propiedades cargadas:', properties);
                renderPropertyTable(properties || []);
                
            } catch (error) {
                console.error('Error loading properties:', error);
                showMessage('Error cargando propiedades: ' + error.message, 'error');
            }
        }

        // Render property table
        function renderPropertyTable(properties) {
            const tbody = document.getElementById('propertyTableBody');
            tbody.innerHTML = '';

            properties.forEach(property => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => editProperty(property.id);

                const price = property.sale_price 
                    ? `${property.sale_currency || 'USD'} ${parseFloat(property.sale_price).toLocaleString()}`
                    : property.rental_price 
                    ? `${property.rental_currency || 'USD'} ${parseFloat(property.rental_price).toLocaleString()}/mes`
                    : 'Consultar';

                const categoryName = property.property_categories?.name || 'Sin categoría';
                const cityName = property.cities?.name || 'Sin ciudad';
                const sectorName = property.sectors?.name || 'Sin sector';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${property.id.substring(0, 8)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${property.code || 'Sin código'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" title="${property.name}">
                        ${property.name.length > 30 ? property.name.substring(0, 30) + '...' : property.name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${property.is_project ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${property.is_project ? 'Proyecto' : 'Propiedad'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(property.property_status)}">
                            ${property.property_status || 'Sin estado'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${price}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="event.stopPropagation(); editProperty('${property.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteProperty('${property.id}')" class="text-red-600 hover:text-red-900" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Create new property
        function createNewProperty() {
            currentProperty = null;
            isEditing = false;
            document.getElementById('formTitle').textContent = 'Nueva Propiedad';
            document.getElementById('propertyId').textContent = '';
            document.getElementById('mainForm').reset();
            document.getElementById('propertyForm').style.display = 'block';
            document.querySelector('.tab-btn[data-tab="basic"]').click();
        }

        // Edit property
        async function editProperty(propertyId) {
            try {
                showMessage('Cargando propiedad...', 'info');
                
                const { data: property, error } = await window.supabaseClient
                    .from('properties')
                    .select(`
                        *,
                        property_categories(id, name),
                        cities(id, name),
                        sectors(id, name)
                    `)
                    .eq('id', propertyId)
                    .single();

                if (error) {
                    throw error;
                }

                if (!property) {
                    showMessage('Propiedad no encontrada', 'error');
                    return;
                }

                console.log('Propiedad cargada:', property);
                currentProperty = property;
                isEditing = true;
                document.getElementById('formTitle').textContent = 'Editar Propiedad';
                document.getElementById('propertyId').textContent = `#${property.id.substring(0, 8)}...`;
                
                await populateForm(property);
                document.getElementById('propertyForm').style.display = 'block';
                document.querySelector('.tab-btn[data-tab="basic"]').click();
                
            } catch (error) {
                console.error('Error loading property:', error);
                showMessage('Error cargando propiedad: ' + error.message, 'error');
            }
        }

        // Populate form with property data
        async function populateForm(property) {
            // Basic form population
            Object.keys(property).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = property[key];
                    } else if (element.type === 'date' && property[key]) {
                        // Format date for input
                        const date = new Date(property[key]);
                        element.value = date.toISOString().split('T')[0];
                    } else {
                        element.value = property[key] || '';
                    }
                }
            });

            // Handle related data
            if (property.property_categories) {
                document.getElementById('category_id').value = property.property_categories.id;
            }
            
            if (property.cities) {
                document.getElementById('city_id').value = property.cities.id;
                await loadSectors(); // Load sectors for this city
            }
            
            if (property.sectors) {
                document.getElementById('sector_id').value = property.sectors.id;
            }

            // Handle gallery images
            if (property.gallery_images_url) {
                if (Array.isArray(property.gallery_images_url)) {
                    document.getElementById('gallery_images_url').value = property.gallery_images_url.join('\n');
                } else if (typeof property.gallery_images_url === 'string') {
                    document.getElementById('gallery_images_url').value = property.gallery_images_url.replace(/,/g, '\n');
                }
            }

            // Update previews
            updateMainImagePreview();
            updateGalleryPreview();
            toggleProjectFields();
        }

        // Save property
        async function saveProperty(isDraft = false) {
            try {
                showMessage('Guardando propiedad...', 'info');
                
                const formData = new FormData(document.getElementById('mainForm'));
                const propertyData = Object.fromEntries(formData.entries());

                // Set status based on save type
                if (isDraft) {
                    propertyData.property_status = 'Borrador';
                }

                // Process gallery images
                if (propertyData.gallery_images_url) {
                    const urls = propertyData.gallery_images_url
                        .split('\n')
                        .map(url => url.trim())
                        .filter(url => url.length > 0);
                    propertyData.gallery_images_url = urls;
                }

                // Convert checkboxes (only for fields that exist)
                propertyData.is_project = document.getElementById('is_project').checked;
                propertyData.shared_commission = document.getElementById('shared_commission').checked;

                // Convert numeric fields (matching exact schema)
                const numericFields = [
                    'code', 'bedrooms', 'bathrooms', 'parking_spots', 'built_area', 'land_area',
                    'sale_price', 'rental_price', 'temp_rental_price', 'furnished_rental_price',
                    'furnished_sale_price', 'maintenance_price', 'separation_price',
                    'sale_commission', 'rental_commission', 'availability',
                    'category_id', 'country_id', 'province_id', 'city_id', 'sector_id', 'agent_id',
                    'project_phase_id', 'project_typology_id', 'project_detail_id'
                ];
                
                numericFields.forEach(field => {
                    if (propertyData[field] && propertyData[field] !== '') {
                        propertyData[field] = parseFloat(propertyData[field]) || null;
                    } else {
                        propertyData[field] = null;
                    }
                });

                // Validate required fields
                if (!propertyData.code || !propertyData.name || !propertyData.slug_url || !propertyData.category_id) {
                    showMessage('Por favor complete todos los campos requeridos (Código, Nombre, Slug, Categoría)', 'error');
                    return;
                }

                // Clean up empty fields
                Object.keys(propertyData).forEach(key => {
                    if (propertyData[key] === '' || propertyData[key] === 'null') {
                        propertyData[key] = null;
                    }
                });

                console.log('Saving property data:', propertyData);

                let result;
                if (isEditing && currentProperty) {
                    // Update existing property
                    const { data, error } = await window.supabaseClient
                        .from('properties')
                        .update(propertyData)
                        .eq('id', currentProperty.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    showMessage('Propiedad actualizada exitosamente', 'success');
                } else {
                    // Create new property
                    const { data, error } = await window.supabaseClient
                        .from('properties')
                        .insert(propertyData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    showMessage('Propiedad creada exitosamente', 'success');
                }

                console.log('Property saved:', result);

                // Refresh the property list
                await loadProperties();
                cancelEdit();

            } catch (error) {
                console.error('Error saving property:', error);
                showMessage('Error guardando propiedad: ' + error.message, 'error');
            }
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('propertyForm').style.display = 'none';
            currentProperty = null;
            isEditing = false;
            document.getElementById('mainForm').reset();
        }

        // Delete property
        async function deleteProperty(propertyId) {
            if (!confirm('¿Está seguro de que desea eliminar esta propiedad? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                showMessage('Eliminando propiedad...', 'info');
                
                const { error } = await window.supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', propertyId);

                if (error) {
                    throw error;
                }

                showMessage('Propiedad eliminada exitosamente', 'success');
                await loadProperties();
                
            } catch (error) {
                console.error('Error deleting property:', error);
                showMessage('Error eliminando propiedad: ' + error.message, 'error');
            }
        }

        // Generate slug from name
        function generateSlug() {
            const name = document.getElementById('name').value;
            if (!name) return;

            const slug = name
                .toLowerCase()
                .replace(/[áàäâ]/g, 'a')
                .replace(/[éèëê]/g, 'e')
                .replace(/[íìïî]/g, 'i')
                .replace(/[óòöô]/g, 'o')
                .replace(/[úùüû]/g, 'u')
                .replace(/[ñ]/g, 'n')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '');

            document.getElementById('slug_url').value = '/' + slug;
        }

        // Update main image preview
        function updateMainImagePreview() {
            const url = document.getElementById('main_image_url').value;
            const preview = document.getElementById('mainImagePreview');
            const img = preview.querySelector('img');

            if (url && isValidImageUrl(url)) {
                img.src = url;
                img.onload = () => preview.classList.remove('hidden');
                img.onerror = () => preview.classList.add('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // Update gallery preview
        function updateGalleryPreview() {
            const urls = document.getElementById('gallery_images_url').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            const preview = document.getElementById('galleryPreview');
            const container = document.getElementById('galleryContainer');

            if (urls.length === 0) {
                preview.classList.add('hidden');
                return;
            }

            container.innerHTML = '';
            let validImages = 0;

            urls.forEach((url, index) => {
                if (isValidImageUrl(url)) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.innerHTML = `
                        <img src="${url}" alt="Imagen ${index + 1}" class="image-preview">
                        <div class="remove-btn" onclick="removeGalleryImage(${index})">×</div>
                    `;
                    container.appendChild(galleryItem);
                    validImages++;
                }
            });

            if (validImages > 0) {
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // Remove gallery image
        function removeGalleryImage(index) {
            const urls = document.getElementById('gallery_images_url').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            urls.splice(index, 1);
            document.getElementById('gallery_images_url').value = urls.join('\n');
            updateGalleryPreview();
        }

        // Toggle project fields
        function toggleProjectFields() {
            const isProject = document.getElementById('is_project').checked;
            const projectTab = document.querySelector('.tab-btn[data-tab="project"]');
            const projectFields = document.querySelectorAll('.field-group.project input, .field-group.project select, .field-group.project textarea');

            if (isProject) {
                projectTab.style.display = 'block';
                projectFields.forEach(field => field.disabled = false);
            } else {
                projectTab.style.display = 'none';
                projectFields.forEach(field => {
                    field.disabled = true;
                    field.value = '';
                });
            }
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showMessage('Geolocalización no está disponible en este navegador', 'error');
                return;
            }

            const btn = document.getElementById('getLocationBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Obteniendo ubicación...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                    btn.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Ubicación obtenida';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Obtener Ubicación Actual';
                        btn.disabled = false;
                    }, 2000);
                },
                (error) => {
                    showMessage('Error obteniendo ubicación: ' + error.message, 'error');
                    btn.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Obtener Ubicación Actual';
                    btn.disabled = false;
                }
            );
        }

        // Load categories
        async function loadCategories() {
            try {
                const { data: categories, error } = await window.supabaseClient
                    .from('property_categories')
                    .select('id, name')
                    .eq('active', true)
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('category_id');
                select.innerHTML = '<option value="">Seleccionar categoría...</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
                
                console.log('Categorías cargadas:', categories.length);
            } catch (error) {
                console.error('Error loading categories:', error);
                showMessage('Error cargando categorías: ' + error.message, 'error');
            }
        }

        // Load cities
        async function loadCities() {
            try {
                const { data: cities, error } = await window.supabaseClient
                    .from('cities')
                    .select('id, name, provinces(name)')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('city_id');
                select.innerHTML = '<option value="">Seleccionar ciudad...</option>';
                
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = `${city.name}${city.provinces ? ` (${city.provinces.name})` : ''}`;
                    select.appendChild(option);
                });
                
                console.log('Ciudades cargadas:', cities.length);
            } catch (error) {
                console.error('Error loading cities:', error);
                showMessage('Error cargando ciudades: ' + error.message, 'error');
            }
        }

        // Load sectors based on city
        async function loadSectors() {
            const cityId = document.getElementById('city_id').value;
            const select = document.getElementById('sector_id');
            select.innerHTML = '<option value="">Seleccionar sector...</option>';

            if (!cityId) return;

            try {
                const { data: sectors, error } = await window.supabaseClient
                    .from('sectors')
                    .select('id, name')
                    .eq('city_id', cityId)
                    .order('name');

                if (error) throw error;

                sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector.id;
                    option.textContent = sector.name;
                    select.appendChild(option);
                });
                
                console.log('Sectores cargados para ciudad', cityId, ':', sectors.length);
            } catch (error) {
                console.error('Error loading sectors:', error);
                showMessage('Error cargando sectores: ' + error.message, 'error');
            }
        }

        // Load agents
        async function loadAgents() {
            try {
                const { data: agents, error } = await window.supabaseClient
                    .from('users')
                    .select('id, first_name, last_name, email')
                    .eq('active', true)
                    .order('first_name');

                if (error) throw error;

                const select = document.getElementById('agent_id');
                select.innerHTML = '<option value="">Sin agente asignado</option>';
                
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = `${agent.first_name} ${agent.last_name} (${agent.email})`;
                    select.appendChild(option);
                });
                
                console.log('Agentes cargados:', agents.length);
            } catch (error) {
                console.error('Error loading agents:', error);
                showMessage('Error cargando agentes: ' + error.message, 'error');
            }
        }

        // Load countries
        async function loadCountries() {
            try {
                const { data: countries, error } = await supabase
                    .from('countries')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('country_id');
                select.innerHTML = '<option value="">Seleccionar país...</option>';
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.id;
                    option.textContent = country.name;
                    select.appendChild(option);
                });
                
                console.log('Países cargados:', countries.length);
            } catch (error) {
                console.error('Error loading countries:', error);
                showMessage('Error cargando países: ' + error.message, 'error');
            }
        }

        // Load provinces based on country
        async function loadProvinces() {
            const countryId = document.getElementById('country_id').value;
            const select = document.getElementById('province_id');
            select.innerHTML = '<option value="">Seleccionar provincia...</option>';

            if (!countryId) return;

            try {
                const { data: provinces, error } = await supabase
                    .from('provinces')
                    .select('id, name')
                    .eq('country_id', countryId)
                    .order('name');

                if (error) throw error;

                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.id;
                    option.textContent = province.name;
                    select.appendChild(option);
                });
                
                console.log('Provincias cargadas para país', countryId, ':', provinces.length);
            } catch (error) {
                console.error('Error loading provinces:', error);
                showMessage('Error cargando provincias: ' + error.message, 'error');
            }
        }

        // Load cities based on province
        async function loadCitiesForProvince() {
            const provinceId = document.getElementById('province_id').value;
            const select = document.getElementById('city_id');
            select.innerHTML = '<option value="">Seleccionar ciudad...</option>';

            if (!provinceId) return;

            try {
                const { data: cities, error } = await supabase
                    .from('cities')
                    .select('id, name')
                    .eq('province_id', provinceId)
                    .order('name');

                if (error) throw error;

                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name;
                    select.appendChild(option);
                });
                
                console.log('Ciudades cargadas para provincia', provinceId, ':', cities.length);
            } catch (error) {
                console.error('Error loading cities for province:', error);
                showMessage('Error cargando ciudades: ' + error.message, 'error');
            }
        }

        // Utility functions
        function isValidImageUrl(url) {
            return url && (url.startsWith('http://') || url.startsWith('https://'));
        }

        function getStatusColor(status) {
            const colors = {
                'Publicada': 'bg-green-100 text-green-800',
                'Borrador': 'bg-yellow-100 text-yellow-800',
                'Vendida': 'bg-red-100 text-red-800',
                'Alquilada': 'bg-blue-100 text-blue-800',
                'Retirada': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function showMessage(message, type = 'info') {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            const messageEl = document.createElement('div');
            
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            
            messageEl.className = `${bgColor} text-white px-6 py-3 rounded-md shadow-lg mb-2 transform transition-all duration-300`;
            messageEl.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 5000);
        }

        // Mock data
        function getMockProperties() {
            // This function is no longer needed since we're using real data
            return [];
        }
    </script>
</body>
</html>