---
// src/components/property/AgentPropertiesCarousel.astro
export interface Props {
  data: any;
  language?: string;
}

const { data, language } = Astro.props;

// Try to get language from multiple sources
const currentLanguage = language || 
                       data.language || 
                       data.globalConfig?.language || 
                       'es';

// Multilingual translations
const translations = {
  es: {
    morePropertiesOf: 'M√°s Propiedades de',
    thisAdvisor: 'Este Asesor',
    propertyAvailable: 'propiedad disponible',
    propertiesAvailable: 'propiedades disponibles',
    propertiesShown: 'propiedades mostradas',
    viewAllProperties: 'Ver todas las',
    propertiesOf: 'propiedades de',
    thisAdvisorLower: 'este asesor',
    consultPrice: 'Consultar precio'
  },
  en: {
    morePropertiesOf: 'More Properties by',
    thisAdvisor: 'This Advisor',
    propertyAvailable: 'property available',
    propertiesAvailable: 'properties available', 
    propertiesShown: 'properties shown',
    viewAllProperties: 'View all',
    propertiesOf: 'properties by',
    thisAdvisorLower: 'this advisor',
    consultPrice: 'Price on request'
  },
  fr: {
    morePropertiesOf: 'Plus de Propri√©t√©s de',
    thisAdvisor: 'Ce Conseiller',
    propertyAvailable: 'propri√©t√© disponible',
    propertiesAvailable: 'propri√©t√©s disponibles',
    propertiesShown: 'propri√©t√©s affich√©es', 
    viewAllProperties: 'Voir toutes les',
    propertiesOf: 'propri√©t√©s de',
    thisAdvisorLower: 'ce conseiller',
    consultPrice: 'Prix sur demande'
  }
};

// Operation translations
const operationTranslations = {
  es: {
    'Venta': 'Venta',
    'Venta Amueblada': 'Venta Amueblada',
    'Alquiler': 'Alquiler', 
    'Alquiler Amueblado': 'Alquiler Amueblado',
    'Temporal': 'Temporal',
    'Consultar': 'Consultar'
  },
  en: {
    'Venta': 'Sale',
    'Venta Amueblada': 'Furnished Sale',
    'Alquiler': 'Rental',
    'Alquiler Amueblado': 'Furnished Rental', 
    'Temporal': 'Short-term',
    'Consultar': 'Inquire'
  },
  fr: {
    'Venta': 'Vente',
    'Venta Amueblada': 'Vente Meubl√©e',
    'Alquiler': 'Location',
    'Alquiler Amueblado': 'Location Meubl√©e',
    'Temporal': 'Temporaire', 
    'Consultar': 'Consulter'
  }
};

const t = translations[currentLanguage] || translations.es;

const agent = data.agent || {};
const agentProperties = data.agentProperties || [];
const agentPropertiesInfo = data.agentPropertiesInfo || {};

// Solo mostrar si hay propiedades del asesor
const showCarousel = agentPropertiesInfo.has_agent_properties && agentProperties.length > 0;

// Get localized property title
function getLocalizedTitle(property, targetLang) {
  if (targetLang === 'en' && property.content_en?.name) {
    return property.content_en.name;
  }
  
  if (targetLang === 'fr' && property.content_fr?.name) {
    return property.content_fr.name;
  }
  
  return property.titulo || property.name || 'Propiedad';
}

// Get localized operation
function getLocalizedOperation(operation, targetLang) {
  const opTranslations = operationTranslations[targetLang] || operationTranslations.es;
  return opTranslations[operation] || operation;
}

// Get localized category
function getLocalizedCategory(property, targetLang) {
  if (!property.property_categories) {
    return property.tipo || 'Propiedad';
  }
  
  const category = property.property_categories;
  
  if (targetLang === 'en' && category.name_en) {
    return category.name_en;
  }
  
  if (targetLang === 'fr' && category.name_fr) {
    return category.name_fr;
  }
  
  return category.name || property.tipo || 'Propiedad';
}

// Funci√≥n para determinar precio y etiqueta de operaci√≥n - CORREGIDA
function getPriceAndOperation(property) {
  // Funci√≥n helper para validar si un precio es v√°lido
  function isValidPrice(price) {
    return price !== null && price !== undefined && price !== 0 && price !== '';
  }

  // Prioridad: venta -> venta amueblada -> alquiler -> alquiler amueblado -> temporal
  if (isValidPrice(property.sale_price)) {
    return {
      precio: formatPrice(property.sale_price, property.sale_currency),
      operacion: 'Venta'
    };
  } else if (isValidPrice(property.furnished_sale_price)) {
    return {
      precio: formatPrice(property.furnished_sale_price, property.furnished_sale_currency),
      operacion: 'Venta Amueblada'
    };
  } else if (isValidPrice(property.rental_price)) {
    return {
      precio: formatPrice(property.rental_price, property.rental_currency),
      operacion: 'Alquiler'
    };
  } else if (isValidPrice(property.furnished_rental_price)) {
    return {
      precio: formatPrice(property.furnished_rental_price, property.furnished_rental_currency),
      operacion: 'Alquiler Amueblado'
    };
  } else if (isValidPrice(property.temp_rental_price)) {
    return {
      precio: formatPrice(property.temp_rental_price, property.temp_rental_currency),
      operacion: 'Temporal'
    };
  } else {
    // Si ya tiene precio formateado del layout, usarlo
    return {
      precio: property.precio || t.consultPrice,
      operacion: property.operacion || 'Venta'
    };
  }
}

// Alternativa: Tambi√©n puedes mejorar la funci√≥n formatPrice para ser m√°s robusta
function formatPrice(price, currency) {
  // Validar que el precio sea un n√∫mero v√°lido y mayor que 0
  if (!price || isNaN(price) || price <= 0) {
    return t.consultPrice;
  }
  
  const symbol = currency === 'USD' ? 'US$' : 'RD$';
  
  // Convertir a n√∫mero si es string
  const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
  
  if (isNaN(numericPrice) || numericPrice <= 0) {
    return t.consultPrice;
  }
  
  return `${symbol}${numericPrice.toLocaleString()}`;
}

// Funci√≥n helper para generar URL del asesor con idioma correcto
function getAdvisorUrl(slug, language, trackingString = '') {
  const translations = {
    'es': 'asesores',
    'en': 'en/advisors', 
    'fr': 'fr/conseillers'
  };
  
  const localizedPath = translations[language] || 'asesores';
  const baseUrl = `/${localizedPath}/${slug}`;
  
  // Agregar referencia si existe trackingString
  if (trackingString) {
    return `${baseUrl}?ref=${trackingString}`;
  }
  
  return baseUrl;
}

// Procesar propiedades - combinar datos del layout con l√≥gica correcta
const processedProperties = agentProperties.map(property => {
  const priceData = getPriceAndOperation(property);
  return {
    ...property,
    ...priceData,
    localizedTitle: getLocalizedTitle(property, currentLanguage),
    localizedOperation: getLocalizedOperation(priceData.operacion, currentLanguage),
    localizedCategory: getLocalizedCategory(property, currentLanguage)
  };
});

// Calculate correct counts
const totalProperties = agentPropertiesInfo.total_found || 0;
const shownProperties = agentProperties.length;

console.log('üè† AgentPropertiesCarousel loaded:', {
  language: currentLanguage,
  hasAgentProperties: showCarousel,
  totalProperties: totalProperties,
  shownProperties: shownProperties,
  agentId: agentPropertiesInfo.agent_id
});
---

<!-- Agent Properties Carousel -->
{showCarousel && (
  <div class="space-y-6">
    <!-- Header con informaci√≥n del asesor -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-900 border-b-2 border-[#f04e00] pb-2 inline-block">
          <a 
            href={getAdvisorUrl(data.agent.slug, currentLanguage, data.trackingString)}
            class="hover:text-[#f04e00] transition-colors duration-300"
          >
                                                            {t.morePropertiesOf}&nbsp;{agent.name || t.thisAdvisor}
          </a>
        </h2>
        <p class="text-sm text-gray-600 mt-2">
          <span>{shownProperties}</span>{' '}
          <span>{shownProperties === 1 ? t.propertyAvailable : t.propertiesShown}</span>
        </p>
      </div>
      
      <!-- Controles del carrusel -->
      <div class="flex items-center gap-2">
        <button 
          id="carousel-prev"
          class="w-10 h-10 bg-white border border-gray-300 rounded-full flex items-center justify-center hover:bg-gray-50 hover:border-[#f04e00] transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
          onclick="slideCarousel('prev')"
        >
          <i class="fas fa-chevron-left text-gray-600"></i>
        </button>
        <button 
          id="carousel-next"
          class="w-10 h-10 bg-white border border-gray-300 rounded-full flex items-center justify-center hover:bg-gray-50 hover:border-[#f04e00] transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
          onclick="slideCarousel('next')"
        >
          <i class="fas fa-chevron-right text-gray-600"></i>
        </button>
      </div>
    </div>

    <!-- Carrusel -->
    <div class="relative overflow-hidden" id="carousel-wrapper">
      <div 
        id="carousel-container" 
        class="flex transition-transform duration-300 ease-out gap-4"
        style="transform: translateX(0px)"
      >
        {processedProperties.map((property, index) => (
          <div class="flex-shrink-0 w-72 carousel-item">
            <a 
              href={property.url?.startsWith('/') ? property.url : `/${property.url}`}
              class="group block bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-500 overflow-hidden border border-gray-100 hover:border-gray-200 relative"
            >
              <!-- Imagen m√°s compacta -->
              <div class="relative h-40 overflow-hidden">
                <img 
                  src={property.imagen || '/images/placeholder-property.jpg'}
                  alt={property.localizedTitle}
                  class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                  loading="lazy"
                  onerror="this.src='/images/placeholder-property.jpg'"
                />
                
                <!-- Overlay sutil -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              </div>
              
              <!-- Badge ribbon de operaci√≥n (derecha) -->
              <div class="ribbon">
                {property.localizedOperation}
              </div>
              
              <!-- Badge ribbon del tipo de propiedad (izquierda) -->
              <div class="ribbon-left">
                {property.localizedCategory}
              </div>
              
              <!-- Contenido m√°s compacto -->
              <div class="p-4">
                <!-- Ubicaci√≥n con precio a la derecha -->
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-1">
                    <i class="fas fa-map-marker-alt text-gray-400 text-xs"></i>
                    <p class="text-xs text-gray-500 font-medium">
                      {property.sector || 'Santo Domingo'}
                    </p>
                  </div>
                  <span class="text-sm font-bold text-[#f04e00] group-hover:text-[#e03400] transition-colors">
                    {property.precio}
                  </span>
                </div>
                
                <!-- T√≠tulo m√°s peque√±o -->
                <h3 class="text-sm font-semibold text-gray-900 mb-3 group-hover:text-[#f04e00] transition-colors line-clamp-2 leading-tight">
                  {property.localizedTitle}
                </h3>
                
                <!-- Caracter√≠sticas con iconos consistentes y flecha alineada -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3 text-xs text-gray-600">
                    {(property.habitaciones && property.habitaciones > 0) && (
                      <div class="flex items-center gap-1">
                        <i class="fas fa-bed text-gray-500"></i>
                        <span class="font-medium text-gray-700">{property.habitaciones}</span>
                      </div>
                    )}
                    
                    {(property.banos && property.banos > 0) && (
                      <div class="flex items-center gap-1">
                        <i class="fas fa-bath text-gray-500"></i>
                        <span class="font-medium text-gray-700">{property.banos}</span>
                      </div>
                    )}
                    
                    {(property.metros && property.metros > 0) && (
                      <div class="flex items-center gap-1">
                        <i class="fas fa-th-large text-gray-500"></i>
                        <span class="font-medium text-gray-700">{property.metros}m¬≤</span>
                      </div>
                    )}
                    
                    {(property.parking_spots && property.parking_spots > 0) && (
                      <div class="flex items-center gap-1">
                        <i class="fas fa-car text-gray-500"></i>
                        <span class="font-medium text-gray-700">{property.parking_spots}</span>
                      </div>
                    )}
                  </div>
                  
                  <!-- Flecha alineada con los iconos -->
                  <i class="fas fa-arrow-right text-gray-400 group-hover:text-[#f04e00] transition-colors text-xs"></i>
                </div>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>

    <!-- Indicadores de posici√≥n -->
    <div class="flex items-center justify-center gap-2 mt-4">
      <div class="flex gap-1" id="carousel-dots">
        <!-- Los dots se generar√°n din√°micamente con JavaScript -->
      </div>
    </div>

    <!-- Ver todas las propiedades del asesor -->
    {totalProperties > shownProperties && (
      <div class="text-center pt-4 border-t border-gray-200">
        <a 
          href={getAdvisorUrl(data.agent.slug, currentLanguage, data.trackingString)}
          class="inline-flex items-center gap-2 text-[#f04e00] hover:text-[#d94400] font-medium text-sm transition-colors"
        >
          <span>{t.viewAllProperties} {totalProperties} {t.propertiesOf} {agent.name || t.thisAdvisorLower}</span>
          <i class="fas fa-arrow-right text-xs"></i>
        </a>
      </div>
    )}
  </div>
)}

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .ribbon {
    position: absolute;
    top: 0;
    right: 0;
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
    padding: 4px 12px 4px 8px;
    font-size: 0.75rem;
    font-weight: 500;
    clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-bottom-left-radius: 2px;
    z-index: 10;
  }

  .ribbon-left {
    position: absolute;
    top: 0;
    left: 0;
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
    padding: 4px 8px 4px 12px;
    font-size: 0.75rem;
    font-weight: 500;
    clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
    box-shadow: 0 2px 4px rgba (0, 0, 0, 0.1);
    border-bottom-right-radius: 2px;
    z-index: 10;
  }

  /* Estilos del carrusel */
  #carousel-container {
    scroll-behavior: smooth;
  }

  .carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #d1d5db;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .carousel-dot.active {
    background: #f04e00;
    transform: scale(1.2);
  }

  .carousel-dot:hover {
    background: #f04e00;
  }

  /* Estilos para carrusel expandido por el layout */
  .carousel-full-width #carousel-container {
    gap: 1.5rem; /* Aumentar gap cuando est√° expandido */
  }

  .carousel-full-width .carousel-item {
    width: 20rem; /* w-80 en lugar de w-72 cuando est√° expandido */
  }

  /* Responsive adjustments para carrusel expandido */
  @media (min-width: 1536px) {
    .carousel-full-width .carousel-item {
      width: 22rem; /* A√∫n m√°s ancho en pantallas muy grandes */
    }
  }
</style>

<script>
  // Estado del carrusel
  let currentSlide = 0;
  let maxSlides = 0;
  let itemWidth = 300; // Base width
  let visibleItems = 1;
  let isLayoutControlled = false;

  // Funci√≥n para detectar si el layout est√° controlando la expansi√≥n
  function checkLayoutControl() {
    const carouselSection = document.getElementById('agent-properties-carousel-section');
    isLayoutControlled = carouselSection && carouselSection.hasAttribute('data-layout-controlled');
    
    if (isLayoutControlled) {
      console.log('üé† Carrusel bajo control del layout - sistema de componente desactivado');
      
      // Ajustar el ancho de items si est√° expandido por el layout
      const isExpanded = carouselSection.classList.contains('carousel-full-width');
      if (isExpanded) {
        itemWidth = 320; // Ajustar para items m√°s anchos
        console.log('üé† Carrusel expandido por layout - ajustando itemWidth a', itemWidth);
      } else {
        itemWidth = 288; // w-72 = 288px
      }
      
      return true;
    }
    
    return false;
  }

  // Funci√≥n para calcular cu√°ntos elementos son visibles
  function calculateVisibleItems() {
    const container = document.getElementById('carousel-container');
    if (!container) return 1;
    
    const containerWidth = container.parentElement.offsetWidth;
    
    // Usar el itemWidth actualizado basado en el estado del layout
    const effectiveItemWidth = itemWidth + 16; // Incluir gap
    visibleItems = Math.floor(containerWidth / effectiveItemWidth);
    
    console.log('üé† Calculando elementos visibles:', {
      containerWidth,
      itemWidth,
      effectiveItemWidth,
      visibleItems: Math.max(1, visibleItems),
      isLayoutControlled
    });
    
    return Math.max(1, visibleItems);
  }

  // Funci√≥n para actualizar el estado de los botones
  function updateButtons() {
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    
    if (prevBtn) prevBtn.disabled = currentSlide === 0;
    if (nextBtn) nextBtn.disabled = currentSlide >= maxSlides - 1;
  }

  // Funci√≥n para crear los dots
  function createDots() {
    const dotsContainer = document.getElementById('carousel-dots');
    if (!dotsContainer) return;
    
    dotsContainer.innerHTML = '';
    
    for (let i = 0; i < maxSlides; i++) {
      const dot = document.createElement('div');
      dot.className = `carousel-dot ${i === currentSlide ? 'active' : ''}`;
      dot.onclick = () => goToSlide(i);
      dotsContainer.appendChild(dot);
    }
  }

  // Funci√≥n para actualizar los dots
  function updateDots() {
    const dots = document.querySelectorAll('.carousel-dot');
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === currentSlide);
    });
  }

  // Funci√≥n para ir a una diapositiva espec√≠fica
  function goToSlide(slideIndex) {
    currentSlide = Math.max(0, Math.min(slideIndex, maxSlides - 1));
    
    const container = document.getElementById('carousel-container');
    if (container) {
      const gap = 16; // gap-4 = 16px
      const translateX = -(currentSlide * (itemWidth + gap));
      container.style.transform = `translateX(${translateX}px)`;
    }
    
    updateButtons();
    updateDots();
  }

  // Funci√≥n principal del carrusel
  window.slideCarousel = function(direction) {
    if (direction === 'next' && currentSlide < maxSlides - 1) {
      goToSlide(currentSlide + 1);
    } else if (direction === 'prev' && currentSlide > 0) {
      goToSlide(currentSlide - 1);
    }
  };

  // Funci√≥n para inicializar el carrusel
  function initCarousel() {
    const container = document.getElementById('carousel-container');
    if (!container) return;
    
    const items = container.children.length;
    if (items === 0) return;
    
    // Verificar control del layout ANTES de calcular
    checkLayoutControl();
    
    calculateVisibleItems();
    maxSlides = Math.max(1, items - visibleItems + 1);
    
    // Solo mostrar controles si hay m√°s elementos que los visibles
    const showControls = items > visibleItems;
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    const dotsContainer = document.getElementById('carousel-dots');
    
    if (prevBtn) prevBtn.style.display = showControls ? 'flex' : 'none';
    if (nextBtn) nextBtn.style.display = showControls ? 'flex' : 'none';
    if (dotsContainer) dotsContainer.style.display = showControls ? 'flex' : 'none';
    
    if (showControls) {
      createDots();
      updateButtons();
    }
    
    console.log('üé† Carrusel inicializado:', {
      totalItems: items,
      visibleItems: visibleItems,
      maxSlides: maxSlides,
      showControls: showControls,
      isLayoutControlled: isLayoutControlled,
      itemWidth: itemWidth
    });
  }

  // Funci√≥n para manejar el resize
  function handleResize() {
    const oldVisibleItems = visibleItems;
    const oldLayoutControlled = isLayoutControlled;
    
    checkLayoutControl();
    calculateVisibleItems();
    
    if (oldVisibleItems !== visibleItems || oldLayoutControlled !== isLayoutControlled) {
      initCarousel();
      goToSlide(0); // Resetear a la primera diapositiva
    }
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    // Esperar un poco para que el layout se estabilice
    setTimeout(() => {
      initCarousel();
    }, 250);
  });

  // Manejar resize de ventana
  window.addEventListener('resize', handleResize);

  // Observer para detectar cambios en el atributo data-layout-controlled
  if (window.MutationObserver) {
    const carouselSection = document.getElementById('agent-properties-carousel-section');
    if (carouselSection) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && 
              (mutation.attributeName === 'data-layout-controlled' || 
               mutation.attributeName === 'class')) {
            console.log('üé† Detectado cambio en control del layout - reinicializando');
            setTimeout(() => {
              initCarousel();
            }, 100);
          }
        });
      });
      
      observer.observe(carouselSection, {
        attributes: true,
        attributeFilter: ['data-layout-controlled', 'class']
      });

      // ESCUCHAR evento personalizado de cambio de layout
      carouselSection.addEventListener('carousel-layout-changed', (event) => {
        console.log('üé† Evento de cambio de layout recibido:', event.detail);
        
        // Reinicializar completamente el carrusel
        setTimeout(() => {
          // Resetear estado
          currentSlide = 0;
          
          // Forzar rec√°lculo de todo
          checkLayoutControl();
          initCarousel();
          
          // Ir a la primera slide para asegurar posici√≥n correcta
          goToSlide(0);
          
          console.log('üé† Carrusel reinicializado despu√©s del cambio de layout');
        }, 200);
      });
    }
  }

  // Soporte para navegaci√≥n con teclado
  document.addEventListener('keydown', function(e) {
    if (e.target.closest('#carousel-container')) {
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        slideCarousel('prev');
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        slideCarousel('next');
      }
    }
  });
</script>