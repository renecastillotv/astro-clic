---
// src/pages/[...slug].astro — Router compatible con middleware (assets fuera, 1 fetch, cache+CB)

import PropertyListLayout from '../layouts/PropertyListLayout.astro';
import SinglePropertyLayout from '../layouts/SinglePropertyLayout.astro';
import Error404Layout from '../layouts/Error404Layout.astro';
import HomepageLayout from '../layouts/HomepageLayout.astro';

import AdvisorsLayout from '../layouts/AdvisorsLayout.astro';
import SingleAdvisorLayout from '../layouts/SingleAdvisorLayout.astro';
import FavoritesLayout from '../layouts/FavoritesLayout.astro';
import SharedFavoritesLayout from '../layouts/SharedFavoritesLayout.astro';

import TestimonialsMainLayout from '../layouts/TestimonialsMainLayout.astro';
import TestimonialsCategoryLayout from '../layouts/TestimonialsCategoryLayout.astro';
import TestimonialsSingleLayout from '../layouts/TestimonialsSingleLayout.astro';

import ArticlesMainLayout from '../layouts/ArticlesMainLayout.astro';
import ArticlesCategoryLayout from '../layouts/ArticlesCategoryLayout.astro';
import ArticlesSingleLayout from '../layouts/ArticlesSingleLayout.astro';

import VideosMainLayout from '../layouts/VideosMainLayout.astro';
import VideosCategoryLayout from '../layouts/VideosCategoryLayout.astro';
import VideosSingleLayout from '../layouts/VideosSingleLayout.astro';

import ContactLayout from '../layouts/ContactLayout.astro';
import SellLayout from '../layouts/SellLayout.astro';
import VacationRentalsLayout from '../layouts/VacationRentalsLayout.astro';
import VacationRentalsMainLayout from '../layouts/VacationRentalsMainLayout.astro';
import VacationRentalsDynamicLayout from '../layouts/VacationRentalsDynamicLayout.astro';
import CuratedListingsLayout from '../layouts/CuratedListingsLayout.astro';
import CuratedListingsSingleLayout from '../layouts/CuratedListingsSingleLayout.astro';

export const prerender = false;

// 1) Early-exit para assets (en prod lo debe cortar el middleware; aquí es "cinturón y tirantes")
const p = Astro.url.pathname;
const ASSET_RE = /\.(?:png|jpe?g|webp|gif|svg|ico|css|js|map|woff2?|ttf|txt|xml|pdf|mp4|mp3)$/i;
const ASSET_DIR_RE = /^\/(?:images|img|assets|static|_astro)\//i;

if (ASSET_RE.test(p) || ASSET_DIR_RE.test(p)) {
  // 404 barato y cacheable (negative caching) → evita reintentos y NO renderiza 404 de página
  return new Response('', {
    status: 404,
    headers: { 'cache-control': 'public, max-age=300, s-maxage=300' } // 5 min
  });
}

console.log(`✅ Page request: ${p}`);

// 2) Config
const LANGUAGES = ['es', 'en', 'fr'];
const SPECIAL_ROUTES = [
  'asesores','favoritos','testimonios','videos','articulos','contacto',
  'rentas-vacacionales','planes-rentas-vacacionales','vender','listados-de',
  'advisors','favorites','testimonials','articles','contact',
  'vacation-rentals','vacation-rental-plans','sell','listings-of',
  'conseillers','favoris','temoignages','locations-vacances',
  'plans-locations-vacances','vendre','listes-de'
];

const MAIN_BACKEND = 'https://pacewqgypevfgjmdsorz.supabase.co/functions/v1/backend';
const CONTENT_BACKEND = 'https://pacewqgypevfgjmdsorz.supabase.co/functions/v1/content-backend';
const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhY2V3cWd5cGV2ZmdqbWRzb3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NjU4OTksImV4cCI6MjA2NDI0MTg5OX0.Qlg-UVy-sikr76GxYmTcfCz1EnAqPHxvFeLrdqnjuWs';

// 3) Cache + circuit breaker
type CacheVal = { json:any; exp:number };
const PAGE_CACHE: Map<string, CacheVal> = (globalThis as any).__EDGE_PAGE_CACHE__ ?? new Map();
(globalThis as any).__EDGE_PAGE_CACHE__ = PAGE_CACHE;

const FAIL_MEMO: Map<string, number> = (globalThis as any).__EDGE_FAIL_MEMO__ ?? new Map();
(globalThis as any).__EDGE_FAIL_MEMO__ = FAIL_MEMO;

const CACHE_TTL_MS = 60_000;
const FAIL_TTL_MS  = 8000;
const MAIN_TIMEOUT_MS = 5000;
const CONTENT_TIMEOUT_MS = 5000;



// 4) Parse de ruta
const { slug } = Astro.params;
let segments: string[] = [];
if (slug) {
  if (typeof slug === 'string') segments = slug.split('/').filter(Boolean);
  else if (Array.isArray(slug)) segments = slug.filter(Boolean);
}

let language = 'es';
let rest = segments;
if (segments[0] && LANGUAGES.includes(segments[0])) {
  language = segments[0];
  rest = segments.slice(1);
}

const first = rest[0] ?? '';
const useContent = (first === '' || SPECIAL_ROUTES.includes(first));

// 5) Build path para backend
let backendPath = language !== 'es' ? `/${language}` : '';
backendPath += rest.length ? `/${rest.join('/')}` : '/';

// 6) Fetch único con split timeouts + cache + circuit-breaker
async function callBackendOnce(backendBase: string, path: string) {
  const isContent = backendBase.includes('content-backend');
  const timeoutMs = isContent ? CONTENT_TIMEOUT_MS : MAIN_TIMEOUT_MS;
  const url = `${backendBase}${path}?domain=${Astro.url.hostname}`;

  // circuit breaker: si falló recientemente, no bloquee SSR
  const lastFail = FAIL_MEMO.get(url) ?? 0;
  if (Date.now() - lastFail < FAIL_TTL_MS) {
    console.warn(`⛔ CB skip: ${url}`);
    return { pageType: '404', language, error: 'circuit-breaker' };
  }

  // cache
  const now = Date.now();
  const hit = PAGE_CACHE.get(url);
  if (hit && hit.exp > now) {
    console.log(`⚡ cache HIT: ${url}`);
    return hit.json;
  }

  console.log(`➡️ Using: ${isContent ? 'CONTENT' : 'MAIN'} → ${backendPath}`);
  console.time(`⏱️ ${url}`);
  try {
    const res = await fetch(url, {
      headers: {
        'Authorization': AUTH_TOKEN,
        'Content-Type': 'application/json',
        'User-Agent': `CLIC-Router/${Astro.url.host}`,
        'X-Original-Host': Astro.url.hostname
      },
      signal: AbortSignal.timeout(timeoutMs)
    });
    if (!res.ok) throw new Error(`Backend ${res.status}`);
    const json = await res.json();
    console.timeEnd(`⏱️ ${url}`);
    PAGE_CACHE.set(url, { json, exp: now + CACHE_TTL_MS });
    return json;
  } catch (e:any) {
    console.timeEnd(`⏱️ ${url}`);
    console.error('Backend error:', e?.message || e);
    FAIL_MEMO.set(url, Date.now());
    return { pageType: '404', language, error: String(e?.message || e) };
  }
}

const backendUrl = useContent ? CONTENT_BACKEND : MAIN_BACKEND;
const pageData = await callBackendOnce(backendUrl, backendPath);
pageData.language = language;

const pageType = pageData.pageType || pageData.type || (
  pageData.property?.id ? 'single-property' :
  Array.isArray(pageData.properties) ? 'property-list' : '404'
);

// 7) Flags de render
const showHomepage = pageType === 'homepage';
const showPropertyList = pageType === 'property-list';
const showSingleProperty = pageType === 'single-property';
const showAdvisorsList = pageType === 'advisors-list' || pageType === 'advisors-main';
const showAdvisorSingle = pageType === 'advisor-single';
const showFavoritesMain = pageType === 'favorites-main';
const showFavoritesShared = pageType === 'favorites-shared';
const showTestimonialsMain = pageType === 'testimonials-main';
const showTestimonialsCategory = pageType === 'testimonials-category';
const showTestimonialsSingle = pageType === 'testimonials-single';
const showArticlesMain = pageType === 'articles-main';
const showArticlesCategory = pageType === 'articles-category';
const showArticlesSingle = pageType === 'articles-single' || pageType === 'articles-single-404';
const showVideosMain = pageType === 'videos-main';
const showVideosCategory = pageType === 'videos-category';
const showVideosSingle = pageType === 'videos-single';
const showContact = pageType === 'contact';
const showSell = pageType === 'sell';
const showVacationRentalsMain = pageType === 'vacation-rentals-main';
const showVacationRentalsPlans = pageType === 'vacation-rentals-plans';
const showVacationRentalsDynamic = pageType === 'vacation-rentals-dynamic';
const showCuratedListingsMain = pageType === 'curated-listings-main';
const showCuratedListingsSingle = pageType === 'curated-listings-single';
const show404 = pageType === '404' || !pageType;
---

{showHomepage && <HomepageLayout data={pageData} language={pageData.language} />}

{show404 && <Error404Layout data={pageData} language={pageData.language} />}

{showPropertyList && <PropertyListLayout data={pageData} language={pageData.language} />}

{showSingleProperty && <SinglePropertyLayout data={pageData} language={pageData.language} />}

{showAdvisorsList && <AdvisorsLayout data={pageData} language={pageData.language} />}

{showAdvisorSingle && <SingleAdvisorLayout data={pageData} language={pageData.language} />}

{showFavoritesMain && <FavoritesLayout data={pageData} language={pageData.language} />}

{showFavoritesShared && <SharedFavoritesLayout data={pageData} language={pageData.language} />}

{showTestimonialsMain && <TestimonialsMainLayout data={pageData} language={pageData.language} />}

{showTestimonialsCategory && <TestimonialsCategoryLayout data={pageData} language={pageData.language} />}

{showTestimonialsSingle && <TestimonialsSingleLayout data={pageData} language={pageData.language} />}

{showArticlesMain && <ArticlesMainLayout data={pageData} language={pageData.language} />}

{showArticlesCategory && <ArticlesCategoryLayout data={pageData} language={pageData.language} />}

{showArticlesSingle && <ArticlesSingleLayout data={pageData} language={pageData.language} />}

{showVideosMain && <VideosMainLayout data={pageData} language={pageData.language} />}

{showVideosCategory && <VideosCategoryLayout data={pageData} language={pageData.language} />}

{showVideosSingle && <VideosSingleLayout data={pageData} language={pageData.language} />}

{showContact && <ContactLayout data={pageData} language={pageData.language} />}

{showSell && <SellLayout data={pageData} language={pageData.language} />}

{showVacationRentalsMain && <VacationRentalsMainLayout data={pageData} language={pageData.language} />}

{showVacationRentalsPlans && <VacationRentalsLayout data={pageData} language={pageData.language} />}

{showVacationRentalsDynamic && <VacationRentalsDynamicLayout data={pageData} language={pageData.language} />}

{showCuratedListingsMain && <CuratedListingsLayout data={pageData} language={pageData.language} />}

{showCuratedListingsSingle && <CuratedListingsSingleLayout data={pageData} language={pageData.language} />}
