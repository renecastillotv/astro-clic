---
// src/layouts/AdvisorsLayout.astro
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';

/* Utils */
function safeArray(arr, def = []) { return Array.isArray(arr) ? arr : def; }
function safeString(str, def = '') { return typeof str === 'string' ? str : def; }
function safeObject(obj, def = {}) { return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : def; }
function safeNumber(num, def = 0) { return typeof num === 'number' && !isNaN(num) ? num : def; }
function asNullableUrl(v) { if (!v) return null; if (typeof v === 'string' && v.trim() === '') return null; return v; }
function getInitials(name = '') { const p = name.trim().split(/\s+/).filter(Boolean); if (!p.length) return '—'; return (p[0][0] + (p[p.length-1]?.[0]||'')).toUpperCase(); }

/* Props */
const { data } = Astro.props;
const language = safeString(data?.language, 'es');

/* Fallback a Edge Function */
const BASE_URL = 'https://pacewqgypevfgjmdsorz.supabase.co/functions/v1/backend';
const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhY2V3cWd5cGV2ZmdqbWRzb3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NjU4OTksImV4cCI6MjA2NDI0MTg5OX0.Qlg-UVy-sikr76GxYmTcfCz1EnAqPHxvFeLrdqnjuWs';

let advisorsData = safeObject(data);
if (!advisorsData || (!advisorsData.advisors && !advisorsData.sections)) {
  const routeMap = { es: 'asesores', en: 'en/advisors', fr: 'fr/conseillers' };
  const route = routeMap[language] || 'asesores';
  try {
    const r = await fetch(`${BASE_URL}/${route}`, {
      method: 'GET',
      headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json', 'User-Agent': `CLIC-AdvisorsLayout/${Astro.url.host}` }
    });
    if (r.ok) { advisorsData = await r.json(); advisorsData.language = language; }
  } catch (e) { console.warn('Edge function error', e); }
}

/* Normalización */
const advisors = safeArray(advisorsData?.advisors).map(a => ({ ...a }));
const stats = safeObject(advisorsData?.stats);
const rawSeo = safeObject(advisorsData?.seo);
const text = ({
  es: { metaTitle:'Asesores Inmobiliarios Expertos | CLIC', metaDescription:'Nuestro equipo de asesores especializados te ayudará a encontrar la propiedad perfecta',
        pageTitle:'Nuestro Equipo de Asesores', pageSubtitle:'Especialistas con profundo conocimiento del mercado',
        featuredTitle:'Asesores Destacados', teamTitle:'Todos los Asesores', noAdvisors:'No se encontraron asesores disponibles.',
        specialties:'Especialidades', languages:'Idiomas', listings:'Prop. activas', sales:'Ventas', years:'Años', rating:'Satisfacción',
        view:'Ver perfil' },
  en: { metaTitle:'Expert Real Estate Advisors | CLIC', metaDescription:'Our specialized advisors will help you find the perfect property',
        pageTitle:'Our Advisory Team', pageSubtitle:'Specialists with deep market knowledge',
        featuredTitle:'Featured Advisors', teamTitle:'All Advisors', noAdvisors:'No advisors found.',
        specialties:'Specialties', languages:'Languages', listings:'Active props', sales:'Sales', years:'Years', rating:'Rating',
        view:'View profile' },
  fr: { metaTitle:'Conseillers Immobiliers Experts | CLIC', metaDescription:'Nos conseillers spécialisés vous aideront à trouver la propriété parfaite',
        pageTitle:'Notre Équipe de Conseillers', pageSubtitle:'Spécialistes avec une connaissance approfondie du marché',
        featuredTitle:'Conseillers en Vedette', teamTitle:'Tous les Conseillers', noAdvisors:'Aucun conseiller trouvé.',
        specialties:'Spécialités', languages:'Langues', listings:'Biens actifs', sales:'Ventes', years:'Ans', rating:'Satisfaction',
        view:'Voir profil' }
})[language];

/* SEO */
const safeSeo = {
  title: safeString(rawSeo.title) || text.metaTitle,
  description: safeString(rawSeo.description) || text.metaDescription,
  h1: safeString(rawSeo.h1) || text.pageTitle,
  h2: safeString(rawSeo.h2) || text.pageSubtitle,
  canonical_url: safeString(rawSeo.canonical_url, ''),
  ogImage: safeString(rawSeo.ogImage || rawSeo.open_graph?.image, '/og-advisors.jpg'),
  keywords: safeString(rawSeo.keywords),
  hreflang: safeObject(rawSeo.hreflang),
  breadcrumbs: safeArray(rawSeo.breadcrumbs, []),
  structured_data: safeObject(rawSeo.structured_data),
  open_graph: safeObject(rawSeo.open_graph),
  twitter_card: safeObject(rawSeo.twitter_card)
};

/* Featured + listado general */
const explicitFeatured = safeArray(advisorsData?.featuredAdvisors);
const inferredFeatured = advisors.filter(a =>
  a?.featured === true || safeNumber(a?.stats?.totalSales) > 10 || safeNumber(a?.stats?.yearsExperience) > 3
);
const featured = (explicitFeatured.length ? explicitFeatured : inferredFeatured).slice(0, 4);

const featuredIds = new Set(featured.map(a => a.id));
const generalAdvisors = advisors
  .filter(a => !featuredIds.has(a.id))
  .sort((a,b)=>safeString(a.name).localeCompare(safeString(b.name), undefined, { sensitivity: 'base' }));

/* Layout props */
const layoutProps = {
  title: safeSeo.title, description: safeSeo.description, ogImage: safeSeo.ogImage, canonical: safeSeo.canonical_url,
  keywords: safeSeo.keywords, hreflangData: safeSeo.hreflang || {}, globalConfig: advisorsData?.globalConfig || {},
  language, trackingString: advisorsData?.trackingString || '', hotItems: advisorsData?.hotItems || {},
  country: advisorsData?.country || {}, breadcrumbs: safeSeo.breadcrumbs,
  structuredData: safeSeo.structured_data, openGraph: safeSeo.open_graph, twitterCard: safeSeo.twitter_card
};
---

<Layout {...layoutProps}>
  <div class="advisors-layout">

    <!-- HERO (elegante + color de marca en stats) -->
    <section class="py-16 bg-gray-900 text-white">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{safeSeo.h1 || safeSeo.title}</h1>
        <p class="text-xl text-white/80 max-w-3xl mx-auto">{safeSeo.h2 || safeSeo.description}</p>

        {stats && (
          <div class="flex flex-wrap justify-center gap-8 mt-12">
            {safeNumber(stats.totalAdvisors,0)>0 && (<div class="tstat"><div class="tstatV">{stats.totalAdvisors}</div><div class="tstatL">Asesores</div></div>)}
            {safeNumber(stats.totalExperience,0)>0 && (<div class="tstat"><div class="tstatV">{stats.totalExperience}+</div><div class="tstatL">Años Experiencia</div></div>)}
            {safeNumber(stats.totalSales,0)>0 && (<div class="tstat"><div class="tstatV">{stats.totalSales}+</div><div class="tstatL">Ventas</div></div>)}
            {safeNumber(stats.averageSatisfaction,0)>0 && (<div class="tstat"><div class="tstatV">{stats.averageSatisfaction}</div><div class="tstatL">Satisfacción</div></div>)}
          </div>
        )}
      </div>
    </section>

    <!-- DESTACADOS (foto grande centrada, tarjeta compacta, badges arriba) -->
    {featured.length > 0 && (
      <section class="py-12 bg-white">
        <div class="container mx-auto px-4">
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold mb-2">{text.featuredTitle}</h2>
            <p class="text-gray-600">{language==='es'?'El mejor equipo del Caribe, seleccionado por desempeño': language==='en'?'The Caribbean’s top team, performance-selected':'La meilleure équipe des Caraïbes, sélectionnée par performance'}</p>
          </div>

          <div class="grid gap-7 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
            {featured.map((a) => (
              <a href={a.url} class="fcard group">
                <!-- Top badges (compacto) -->
                <div class="fcard__top">
                  {safeNumber(a?.stats?.clientSatisfaction,0)>0 && (
                    <span class="fbadge fbadge--brand">★ {a.stats.clientSatisfaction}</span>
                  )}
                  {safeNumber(a?.stats?.yearsExperience,0)>0 && (
                    <span class="fbadge">{a.stats.yearsExperience} {text.years}</span>
                  )}
                  {safeNumber(a?.stats?.totalSales,0)>0 && (
                    <span class="fbadge">{a.stats.totalSales} {text.sales}</span>
                  )}
                </div>

                <!-- Avatar grande centrado -->
                <div class="fcard__avatar">
                  {asNullableUrl(a.avatar)
                    ? <img src={a.avatar} alt={a.name} class="favatar" loading="lazy" />
                    : <div class="favatar favatar--initials">{getInitials(a.name)}</div>}
                </div>

                <!-- Nombre + posición -->
                <div class="fcard__title">
                  <h3 class="fname">{a.name}</h3>
                  <p class="fpos">{a.position}</p>
                </div>

                <!-- Chips (especialidades / idiomas) -->
                {safeArray(a.specialties).length>0 && (
                  <div class="fchips">
                    {a.specialties.slice(0,2).map((s)=>(<span class="fchip">{s}</span>))}
                    {a.specialties.length>2 && (<span class="fchip fchip--more">+{a.specialties.length-2}</span>)}
                  </div>
                )}
                {safeArray(a.languagesSpoken).length>0 && (
                  <div class="flangs"><span class="flangs__l">{text.languages}:</span> {a.languagesSpoken.slice(0,3).join(', ')}</div>
                )}

                <!-- CTA a la derecha -->
                <div class="fcard__cta">
                  <span class="cta cta--brand">{text.view}
                    <svg class="cta__i" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  </span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- LISTADO GENERAL (alfabético, bonito, incluye idiomas y ventas si > 0) -->
    <section class="py-12 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-6">{text.teamTitle}</h2>

        {generalAdvisors.length>0 ? (
          <div class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {generalAdvisors.map((a)=>(
              <a href={a.url} class="gcard group">
                <div class="gcard__head">
                  {asNullableUrl(a.avatar)
                    ? <img src={a.avatar} alt={a.name} class="gavatar" loading="lazy" />
                    : <div class="gavatar gavatar--initials">{getInitials(a.name)}</div>}
                  <div class="gtitle">
                    <h3 class="gname">{a.name}</h3>
                    <p class="gpos">{a.position}</p>
                  </div>
                  <span class="cta cta--ghost ml-auto">{text.view}
                    <svg class="cta__i" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  </span>
                </div>

                <div class="gmeta">
                  {safeNumber(a?.stats?.yearsExperience,0)>0 && (
                    <span class="gmeta__pill">{a.stats.yearsExperience} {text.years}</span>
                  )}
                  {safeNumber(a?.stats?.clientSatisfaction,0)>0 && (
                    <span class="gmeta__pill gmeta__pill--brand">★ {a.stats.clientSatisfaction}</span>
                  )}
                  {safeNumber(a?.stats?.totalSales,0)>0 && (
                    <span class="gmeta__pill">{a.stats.totalSales} {text.sales}</span>
                  )}
                </div>

                {safeArray(a.languagesSpoken).length>0 && (
                  <div class="glangs"><span class="glangs__l">{text.languages}:</span> {a.languagesSpoken.slice(0,3).join(', ')}</div>
                )}

                {safeArray(a.specialties).length>0 && (
                  <div class="gchips">
                    {a.specialties.slice(0,2).map((s)=>(<span class="gchip">{s}</span>))}
                    {a.specialties.length>2 && (<span class="gchip gchip--more">+{a.specialties.length-2}</span>)}
                  </div>
                )}
              </a>
            ))}
          </div>
        ) : (
          <div class="text-center text-gray-500 py-10">{text.noAdvisors}</div>
        )}
      </div>
    </section>

    {safeArray(advisorsData?.teamProperties).length>0 && (
      <PropertyCarousel
        title={language==='es'?'Propiedades del Equipo':language==='en'?'Team Properties':'Biens de l’équipe'}
        subtitle={language==='es'?'Gestionadas por nuestros asesores':language==='en'?'Managed by our advisors':'Gérées par nos conseillers'}
        properties={advisorsData.teamProperties}
        viewAllLink={`${language==='es'?'/comprar':language==='en'?'/en/buy':'/fr/acheter'}?equipo=destacados`}
        language={language}
      />
    )}
  </div>
</Layout>

<style>
  /* Hero stats */
  .tstat{text-align:center}
  .tstatV{font-weight:800;font-size:1.6rem;color:#f04e00}
  .tstatL{font-size:.85rem;color:rgba(255,255,255,.8)}

  /* Featured card */
  .fcard{border:1px solid #e5e7eb;border-radius:1.25rem;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.04);
    padding:0.9rem 0.9rem 0.8rem;display:flex;flex-direction:column;gap:.55rem;transition:transform .2s,border-color .2s,box-shadow .2s}
  .fcard:hover{transform:translateY(-4px);border-color:#f04e00;box-shadow:0 10px 26px rgba(240,78,0,.12)}
  .fcard__top{display:flex;gap:.35rem;justify-content:center}
  .fbadge{font-size:.72rem;padding:.3rem .5rem;border-radius:.6rem;background:#f3f4f6;border:1px solid #e5e7eb;color:#374151}
  .fbadge--brand{background:rgba(240,78,0,.08);border-color:rgba(240,78,0,.25);color:#f04e00;font-weight:700}
  .fcard__avatar{display:flex;justify-content:center}
  .favatar{width:112px;height:112px;border-radius:9999px;object-fit:cover;box-shadow:0 0 0 4px rgba(240,78,0,.14)}
  .favatar--initials{display:flex;align-items:center;justify-content:center;background:#f04e00;color:#fff;font-weight:800;font-size:2rem}
  .fcard__title{text-align:center;margin-top:.15rem}
  .fname{font-weight:900;font-size:1.05rem}
  .fpos{font-size:.85rem;color:#6b7280;margin-top:.1rem}
  .fchips{display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center}
  .fchip{font-size:.72rem;padding:.25rem .55rem;border-radius:.6rem;background:rgba(240,78,0,.08);border:1px solid rgba(240,78,0,.25);color:#f04e00}
  .fchip--more{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
  .flangs{text-align:center;font-size:.78rem;color:#6b7280}
  .flangs__l{font-weight:600;color:#374151}
  .fcard__cta{display:flex;justify-content:flex-end;margin-top:.25rem}
  .cta{display:inline-flex;align-items:center;gap:.35rem;font-weight:700;font-size:.84rem}
  .cta--brand{color:#f04e00}
  .cta--ghost{color:#f04e00;border:1px dashed rgba(240,78,0,.35);padding:.25rem .45rem;border-radius:.5rem}
  .cta__i{width:15px;height:15px}

  /* General list */
  .gcard{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;padding:.8rem .9rem;display:flex;flex-direction:column;gap:.55rem;
    transition:transform .2s,border-color .2s,box-shadow .2s}
  .gcard:hover{transform:translateY(-3px);border-color:#f04e00;box-shadow:0 10px 24px rgba(240,78,0,.08)}
  .gcard__head{display:flex;align-items:center;gap:.7rem}
  .gavatar{width:56px;height:56px;border-radius:.9rem;object-fit:cover;border:1px solid rgba(240,78,0,.22)}
  .gavatar--initials{display:flex;align-items:center;justify-content:center;background:#f04e00;color:#fff;font-weight:800}
  .gtitle{min-width:0}
  .gname{font-weight:900;line-height:1.1}
  .gpos{font-size:.82rem;color:#6b7280}
  .gmeta{display:flex;flex-wrap:wrap;gap:.35rem}
  .gmeta__pill{font-size:.72rem;background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;border-radius:.5rem;padding:.2rem .45rem}
  .gmeta__pill--brand{background:rgba(240,78,0,.08);color:#f04e00;border-color:rgba(240,78,0,.3);font-weight:700}
  .glangs{font-size:.78rem;color:#6b7280}
  .glangs__l{font-weight:600;color:#374151}
  .gchips{display:flex;flex-wrap:wrap;gap:.35rem}
  .gchip{font-size:.72rem;padding:.2rem .5rem;border-radius:.6rem;background:rgba(240,78,0,.08);border:1px solid rgba(240,78,0,.25);color:#f04e00}
  .gchip.gchip--more{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
</style>
