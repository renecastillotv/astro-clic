---
// src/layouts/AdvisorsLayout.astro
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';

/* Utils */
function safeArray(arr, def = []) { return Array.isArray(arr) ? arr : def; }
function safeString(str, def = '') { return typeof str === 'string' ? str : def; }
function safeObject(obj, def = {}) { return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : def; }
function safeNumber(num, def = 0) { return typeof num === 'number' && !isNaN(num) ? num : def; }
function asNullableUrl(v) { if (!v) return null; if (typeof v === 'string' && v.trim() === '') return null; return v; }
function getInitials(name = '') { const p = name.trim().split(/\s+/).filter(Boolean); if (!p.length) return '—'; return (p[0][0] + (p[p.length-1]?.[0]||'')).toUpperCase(); }

/* Props */
const { data } = Astro.props;
const language = safeString(data?.language, 'es');

/* Fallback a Edge Function */
const BASE_URL = 'https://pacewqgypevfgjmdsorz.supabase.co/functions/v1/backend';
const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhY2V3cWd5cGV2ZmdqbWRzb3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NjU4OTksImV4cCI6MjA2NDI0MTg5OX0.Qlg-UVy-sikr76GxYmTcfCz1EnAqPHxvFeLrdqnjuWs';

let advisorsData = safeObject(data);
if (!advisorsData || (!advisorsData.advisors && !advisorsData.sections)) {
  const routeMap = { es: 'asesores', en: 'en/advisors', fr: 'fr/conseillers' };
  const route = routeMap[language] || 'asesores';
  try {
    const r = await fetch(`${BASE_URL}/${route}`, {
      method: 'GET',
      headers: { 'Authorization': AUTH_TOKEN, 'Content-Type': 'application/json', 'User-Agent': `CLIC-AdvisorsLayout/${Astro.url.host}` }
    });
    if (r.ok) { advisorsData = await r.json(); advisorsData.language = language; }
  } catch (e) { console.warn('Edge function error', e); }
}

/* Normalización */
const advisors = safeArray(advisorsData?.advisors).map(a => ({ ...a }));
const stats = safeObject(advisorsData?.stats);
const rawSeo = safeObject(advisorsData?.seo);
const text = ({
  es: { metaTitle:'Asesores Inmobiliarios Expertos | CLIC', metaDescription:'Nuestro equipo de asesores especializados te ayudará a encontrar la propiedad perfecta',
        pageTitle:'Nuestro Equipo de Asesores', pageSubtitle:'Especialistas con profundo conocimiento del mercado',
        featuredTitle:'Asesores Destacados', teamTitle:'Todos los Asesores', noAdvisors:'No se encontraron asesores disponibles.',
        specialties:'Especialidades', languages:'Idiomas', listings:'Prop. activas', sales:'Ventas', years:'Años', rating:'Satisfacción',
        view:'Ver perfil' },
  en: { metaTitle:'Expert Real Estate Advisors | CLIC', metaDescription:'Our specialized advisors will help you find the perfect property',
        pageTitle:'Our Advisory Team', pageSubtitle:'Specialists with deep market knowledge',
        featuredTitle:'Featured Advisors', teamTitle:'All Advisors', noAdvisors:'No advisors found.',
        specialties:'Specialties', languages:'Languages', listings:'Active props', sales:'Sales', years:'Years', rating:'Rating',
        view:'View profile' },
  fr: { metaTitle:'Conseillers Immobiliers Experts | CLIC', metaDescription:'Nos conseillers spécialisés vous aideront à trouver la propriété parfaite',
        pageTitle:'Notre Équipe de Conseillers', pageSubtitle:'Spécialistes avec une connaissance approfondie du marché',
        featuredTitle:'Conseillers en Vedette', teamTitle:'Tous les Conseillers', noAdvisors:'Aucun conseiller trouvé.',
        specialties:'Spécialités', languages:'Langues', listings:'Biens actifs', sales:'Ventes', years:'Ans', rating:'Satisfaction',
        view:'Voir profil' }
})[language];

/* SEO */
const safeSeo = {
  title: safeString(rawSeo.title) || text.metaTitle,
  description: safeString(rawSeo.description) || text.metaDescription,
  h1: safeString(rawSeo.h1) || text.pageTitle,
  h2: safeString(rawSeo.h2) || text.pageSubtitle,
  canonical_url: safeString(rawSeo.canonical_url, ''),
  ogImage: safeString(rawSeo.ogImage || rawSeo.open_graph?.image, '/og-advisors.jpg'),
  keywords: safeString(rawSeo.keywords),
  hreflang: safeObject(rawSeo.hreflang),
  breadcrumbs: safeArray(rawSeo.breadcrumbs, []),
  structured_data: safeObject(rawSeo.structured_data),
  open_graph: safeObject(rawSeo.open_graph),
  twitter_card: safeObject(rawSeo.twitter_card)
};

/* Featured + listado general */
const explicitFeatured = safeArray(advisorsData?.featuredAdvisors);
const inferredFeatured = advisors.filter(a =>
  a?.featured === true || safeNumber(a?.stats?.totalSales) > 10 || safeNumber(a?.stats?.yearsExperience) > 3
);
const featured = (explicitFeatured.length ? explicitFeatured : inferredFeatured).slice(0, 4);

const featuredIds = new Set(featured.map(a => a.id));
const generalAdvisors = advisors
  .filter(a => !featuredIds.has(a.id))
  .sort((a,b)=>safeString(a.name).localeCompare(safeString(b.name), undefined, { sensitivity: 'base' }));

/* Layout props */
const layoutProps = {
  title: safeSeo.title, description: safeSeo.description, ogImage: safeSeo.ogImage, canonical: safeSeo.canonical_url,
  keywords: safeSeo.keywords, hreflangData: safeSeo.hreflang || {}, globalConfig: advisorsData?.globalConfig || {},
  language, trackingString: advisorsData?.trackingString || '', hotItems: advisorsData?.hotItems || {},
  country: advisorsData?.country || {}, breadcrumbs: safeSeo.breadcrumbs,
  structuredData: safeSeo.structured_data, openGraph: safeSeo.open_graph, twitterCard: safeSeo.twitter_card
};
---

<Layout {...layoutProps}>
  <div class="advisors-layout">

    <!-- HERO (elegante + color de marca en stats) -->
    <section class="py-16 bg-gray-900 text-white">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{safeSeo.h1 || safeSeo.title}</h1>
        <p class="text-xl text-white/80 max-w-3xl mx-auto">{safeSeo.h2 || safeSeo.description}</p>

        {stats && (
          <div class="flex flex-wrap justify-center gap-8 mt-12">
            {safeNumber(stats.totalAdvisors,0)>0 && (<div class="tstat"><div class="tstatV">{stats.totalAdvisors}</div><div class="tstatL">Asesores</div></div>)}
            {safeNumber(stats.totalExperience,0)>0 && (<div class="tstat"><div class="tstatV">{stats.totalExperience}+</div><div class="tstatL">Años Experiencia</div></div>)}
            {safeNumber(stats.totalSales,0)>0 && (<div class="tstat"><div class="tstatV">{stats.totalSales}+</div><div class="tstatL">Ventas</div></div>)}
            {safeNumber(stats.averageSatisfaction,0)>0 && (<div class="tstat"><div class="tstatV">{stats.averageSatisfaction}</div><div class="tstatL">Satisfacción</div></div>)}
          </div>
        )}
      </div>
    </section>

    <!-- DESTACADOS (foto grande centrada, tarjeta premium) -->
    {featured.length > 0 && (
      <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
          <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold mb-3">{text.featuredTitle}</h2>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">{language==='es'?'El mejor equipo del Caribe, seleccionado por desempeño': language==='en'?'The Caribbean\'s top team, performance-selected':'La meilleure équipe des Caraïbes, sélectionnée par performance'}</p>
          </div>

          <div class="grid gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
            {featured.map((a) => (
              <a href={a.url} class="fcard group">
                <!-- Top badges -->
                <div class="fcard__top">
                  {safeNumber(a?.stats?.clientSatisfaction,0)>0 && (
                    <span class="fbadge fbadge--brand">★ {a.stats.clientSatisfaction}</span>
                  )}
                  {safeNumber(a?.stats?.yearsExperience,0)>0 && (
                    <span class="fbadge">{a.stats.yearsExperience} {text.years}</span>
                  )}
                  {safeNumber(a?.stats?.totalSales,0)>0 && (
                    <span class="fbadge">{a.stats.totalSales} {text.sales}</span>
                  )}
                </div>

                <!-- Avatar grande centrado -->
                <div class="fcard__avatar">
                  {asNullableUrl(a.avatar)
                    ? <img src={a.avatar} alt={a.name} class="favatar" loading="lazy" />
                    : <div class="favatar favatar--initials">{getInitials(a.name)}</div>}
                </div>

                <!-- Nombre + posición -->
                <div class="fcard__title">
                  <h3 class="fname">{a.name}</h3>
                  <p class="fpos">{a.position}</p>
                </div>

                <!-- Chips (especialidades / idiomas) -->
                {safeArray(a.specialties).length>0 && (
                  <div class="fchips">
                    {a.specialties.slice(0,2).map((s)=>(<span class="fchip">{s}</span>))}
                    {a.specialties.length>2 && (<span class="fchip fchip--more">+{a.specialties.length-2}</span>)}
                  </div>
                )}
                {safeArray(a.languagesSpoken).length>0 && (
                  <div class="flangs"><span class="flangs__l">{text.languages}:</span> {a.languagesSpoken.slice(0,3).join(', ')}</div>
                )}

                <!-- CTA -->
                <div class="fcard__cta">
                  <span class="cta cta--brand">{text.view}
                    <svg class="cta__i" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  </span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- LISTADO GENERAL (diseño moderno con fotos grandes y mejor jerarquía) -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="flex items-center justify-between mb-10 gap-4 flex-wrap">
          <h2 class="text-3xl md:text-4xl font-bold">{text.teamTitle}</h2>

          {generalAdvisors.length > 5 && (
            <div class="search-box">
              <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input
                type="text"
                id="advisor-search"
                placeholder={language==='es'?'Buscar asesor...':language==='en'?'Search advisor...':'Rechercher conseiller...'}
                class="search-input"
              />
            </div>
          )}
        </div>

        {generalAdvisors.length>0 ? (
          <div id="advisors-grid" class="grid gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
            {generalAdvisors.map((a)=>(
              <a href={a.url} class="gcard group" data-advisor-name={a.name.toLowerCase()}>
                <!-- Header con foto grande + info básica -->
                <div class="gcard__header">
                  <div class="gcard__avatar-wrap">
                    {asNullableUrl(a.avatar)
                      ? <img src={a.avatar} alt={a.name} class="gavatar" loading="lazy" />
                      : <div class="gavatar gavatar--initials">{getInitials(a.name)}</div>}
                    {safeNumber(a?.stats?.clientSatisfaction,0)>0 && (
                      <div class="gavatar__badge">★ {a.stats.clientSatisfaction}</div>
                    )}
                  </div>
                  <div class="gcard__info">
                    <h3 class="gname">{a.name}</h3>
                    <p class="gpos">{a.position}</p>

                    <!-- Stats pills inline -->
                    <div class="gstats">
                      {safeNumber(a?.stats?.yearsExperience,0)>0 && (
                        <span class="gstat">{a.stats.yearsExperience} {text.years}</span>
                      )}
                      {safeNumber(a?.stats?.totalSales,0)>0 && (
                        <span class="gstat">{a.stats.totalSales} {text.sales}</span>
                      )}
                    </div>
                  </div>
                </div>

                <!-- Idiomas (destacado) -->
                {safeArray(a.languagesSpoken).length>0 && (
                  <div class="glangs">
                    <svg class="glangs__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                    </svg>
                    <span>{a.languagesSpoken.slice(0,3).join(', ')}</span>
                  </div>
                )}

                <!-- Especialidades (chips más grandes) -->
                {safeArray(a.specialties).length>0 && (
                  <div class="gchips">
                    {a.specialties.slice(0,3).map((s)=>(<span class="gchip">{s}</span>))}
                    {a.specialties.length>3 && (<span class="gchip gchip--more">+{a.specialties.length-3}</span>)}
                  </div>
                )}

                <!-- CTA flotante en hover -->
                <div class="gcard__cta">
                  <span class="gcta">{text.view}
                    <svg class="gcta__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </span>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="text-center text-gray-500 py-10">{text.noAdvisors}</div>
        )}
      </div>
    </section>

    {safeArray(advisorsData?.teamProperties).length>0 && (
      <PropertyCarousel
        title={language==='es'?'Propiedades del Equipo':language==='en'?'Team Properties':'Biens de l’équipe'}
        subtitle={language==='es'?'Gestionadas por nuestros asesores':language==='en'?'Managed by our advisors':'Gérées par nos conseillers'}
        properties={advisorsData.teamProperties}
        viewAllLink={`${language==='es'?'/comprar':language==='en'?'/en/buy':'/fr/acheter'}?equipo=destacados`}
        language={language}
      />
    )}
  </div>
</Layout>

<style>
  /* Hero stats */
  .tstat{text-align:center}
  .tstatV{font-weight:800;font-size:1.8rem;color:#f04e00}
  .tstatL{font-size:.9rem;color:rgba(255,255,255,.8);margin-top:.2rem}

  /* Featured card - Diseño premium */
  .fcard{
    border:1px solid #e5e7eb;
    border-radius:1.5rem;
    background:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,.06);
    padding:1.25rem;
    display:flex;
    flex-direction:column;
    gap:.75rem;
    transition:all .3s cubic-bezier(.4,0,.2,1);
    position:relative;
    overflow:hidden;
  }
  .fcard::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    right:0;
    height:3px;
    background:linear-gradient(90deg, #f04e00, #ff6a00);
    transform:scaleX(0);
    transition:transform .3s cubic-bezier(.4,0,.2,1);
  }
  .fcard:hover{transform:translateY(-6px);border-color:#f04e00;box-shadow:0 16px 40px rgba(240,78,0,.15)}
  .fcard:hover::before{transform:scaleX(1)}
  .fcard__top{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap}
  .fbadge{font-size:.75rem;padding:.35rem .65rem;border-radius:.7rem;background:#f3f4f6;border:1px solid #e5e7eb;color:#374151;font-weight:600}
  .fbadge--brand{background:rgba(240,78,0,.1);border-color:rgba(240,78,0,.3);color:#f04e00;font-weight:700}
  .fcard__avatar{display:flex;justify-content:center;margin:.5rem 0}
  .favatar{width:128px;height:128px;border-radius:9999px;object-fit:cover;box-shadow:0 0 0 5px rgba(240,78,0,.12);transition:transform .3s}
  .fcard:hover .favatar{transform:scale(1.05);box-shadow:0 0 0 5px rgba(240,78,0,.25)}
  .favatar--initials{display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #f04e00, #ff6a00);color:#fff;font-weight:800;font-size:2.5rem}
  .fcard__title{text-align:center;margin-top:.3rem}
  .fname{font-weight:900;font-size:1.15rem;line-height:1.2;color:#111827}
  .fpos{font-size:.88rem;color:#6b7280;margin-top:.25rem;font-weight:500}
  .fchips{display:flex;flex-wrap:wrap;gap:.45rem;justify-content:center}
  .fchip{font-size:.75rem;padding:.3rem .65rem;border-radius:.7rem;background:rgba(240,78,0,.08);border:1px solid rgba(240,78,0,.25);color:#f04e00;font-weight:600}
  .fchip--more{background:#f3f4f6;border-color:#e5e7eb;color:#6b7280}
  .flangs{text-align:center;font-size:.82rem;color:#6b7280;padding-top:.25rem}
  .flangs__l{font-weight:600;color:#374151}
  .fcard__cta{display:flex;justify-content:center;margin-top:.5rem}
  .cta{display:inline-flex;align-items:center;gap:.4rem;font-weight:700;font-size:.88rem;transition:gap .2s}
  .cta--brand{color:#f04e00}
  .fcard:hover .cta--brand{gap:.6rem}
  .cta__i{width:16px;height:16px;transition:transform .2s}
  .fcard:hover .cta__i{transform:translateX(3px)}

  /* General list - Diseño moderno con fotos grandes */
  .gcard{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:1.25rem;
    padding:1.5rem;
    display:flex;
    flex-direction:column;
    gap:1rem;
    transition:all .3s cubic-bezier(.4,0,.2,1);
    position:relative;
    overflow:hidden;
  }
  .gcard::before{
    content:'';
    position:absolute;
    inset:0;
    border-radius:inherit;
    padding:1px;
    background:linear-gradient(135deg, transparent, rgba(240,78,0,.3), transparent);
    -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite:xor;
    mask-composite:exclude;
    opacity:0;
    transition:opacity .3s;
  }
  .gcard:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(240,78,0,.12)}
  .gcard:hover::before{opacity:1}

  .gcard__header{display:flex;gap:1rem;align-items:flex-start}
  .gcard__avatar-wrap{position:relative;flex-shrink:0}
  .gavatar{
    width:96px;
    height:96px;
    border-radius:1.25rem;
    object-fit:cover;
    border:2px solid rgba(240,78,0,.2);
    transition:all .3s;
  }
  .gcard:hover .gavatar{
    border-color:#f04e00;
    transform:scale(1.05);
  }
  .gavatar--initials{
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(135deg, #f04e00, #ff6a00);
    color:#fff;
    font-weight:800;
    font-size:2rem;
  }
  .gavatar__badge{
    position:absolute;
    bottom:-6px;
    right:-6px;
    background:linear-gradient(135deg, #f04e00, #ff6a00);
    color:#fff;
    font-size:.7rem;
    font-weight:700;
    padding:.25rem .5rem;
    border-radius:.6rem;
    box-shadow:0 2px 8px rgba(240,78,0,.3);
    border:2px solid #fff;
  }

  .gcard__info{flex:1;min-width:0}
  .gname{font-weight:900;font-size:1.15rem;line-height:1.2;color:#111827;margin-bottom:.15rem}
  .gpos{font-size:.88rem;color:#6b7280;margin-bottom:.5rem;font-weight:500}
  .gstats{display:flex;gap:.4rem;flex-wrap:wrap}
  .gstat{
    font-size:.72rem;
    background:#f3f4f6;
    color:#374151;
    border:1px solid #e5e7eb;
    border-radius:.5rem;
    padding:.25rem .5rem;
    font-weight:600;
  }

  .glangs{
    display:flex;
    align-items:center;
    gap:.5rem;
    font-size:.88rem;
    color:#374151;
    background:rgba(240,78,0,.04);
    border:1px solid rgba(240,78,0,.15);
    border-radius:.8rem;
    padding:.6rem .9rem;
    font-weight:500;
  }
  .glangs__icon{width:18px;height:18px;color:#f04e00;flex-shrink:0}

  .gchips{display:flex;flex-wrap:wrap;gap:.45rem}
  .gchip{
    font-size:.78rem;
    padding:.4rem .75rem;
    border-radius:.7rem;
    background:rgba(240,78,0,.08);
    border:1px solid rgba(240,78,0,.25);
    color:#f04e00;
    font-weight:600;
    transition:all .2s;
  }
  .gcard:hover .gchip{background:rgba(240,78,0,.12);border-color:rgba(240,78,0,.35)}
  .gchip--more{background:#f3f4f6;border-color:#e5e7eb;color:#6b7280}

  .gcard__cta{
    display:flex;
    justify-content:flex-end;
    padding-top:.5rem;
    border-top:1px solid #f3f4f6;
    margin-top:auto;
  }
  .gcta{
    display:inline-flex;
    align-items:center;
    gap:.4rem;
    color:#f04e00;
    font-weight:700;
    font-size:.88rem;
    padding:.4rem .8rem;
    border:1px solid rgba(240,78,0,.2);
    border-radius:.7rem;
    background:rgba(240,78,0,.03);
    transition:all .2s;
  }
  .gcard:hover .gcta{
    gap:.6rem;
    background:rgba(240,78,0,.08);
    border-color:rgba(240,78,0,.35);
  }
  .gcta__icon{width:16px;height:16px;transition:transform .2s}
  .gcard:hover .gcta__icon{transform:translateX(3px)}

  /* Search box - Elegante y minimalista */
  .search-box{
    position:relative;
    display:flex;
    align-items:center;
    max-width:320px;
    width:100%;
  }
  .search-icon{
    position:absolute;
    left:1rem;
    width:18px;
    height:18px;
    color:#6b7280;
    stroke-width:2;
    pointer-events:none;
    transition:color .2s;
  }
  .search-input{
    width:100%;
    padding:.7rem 1rem .7rem 2.75rem;
    border:1px solid #e5e7eb;
    border-radius:.8rem;
    font-size:.95rem;
    color:#111827;
    background:#fff;
    transition:all .2s;
    outline:none;
  }
  .search-input::placeholder{
    color:#9ca3af;
  }
  .search-input:focus{
    border-color:#f04e00;
    box-shadow:0 0 0 3px rgba(240,78,0,.1);
  }
  .search-input:focus + .search-icon,
  .search-box:focus-within .search-icon{
    color:#f04e00;
  }

  /* Hidden state for filtered cards */
  .gcard.hidden{
    display:none;
  }
</style>

<script>
  // Búsqueda de asesores en tiempo real
  const searchInput = document.getElementById('advisor-search');
  const advisorsGrid = document.getElementById('advisors-grid');

  if (searchInput && advisorsGrid) {
    const cards = Array.from(advisorsGrid.querySelectorAll('.gcard'));

    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase().trim();

      cards.forEach(card => {
        const advisorName = card.getAttribute('data-advisor-name') || '';

        if (advisorName.includes(searchTerm)) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
    });
  }
</script>
