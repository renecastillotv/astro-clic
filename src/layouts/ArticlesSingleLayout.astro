---
// src/layouts/ArticlesSingleLayout.astro - Layout para artículo individual limpio
import Layout from './Layout.astro';

// ===================================================================
// FUNCIONES HELPER PARA VALIDACIÓN DEFENSIVA
// ===================================================================

function safeGet(obj, path, defaultValue = null) {
  try {
    return path.split('.').reduce((current, key) => current && current[key], obj) || defaultValue;
  } catch (error) {
    console.warn('safeGet error:', error, 'path:', path);
    return defaultValue;
  }
}

function safeArray(arr, defaultValue = []) {
  return Array.isArray(arr) ? arr : defaultValue;
}

function safeString(str, defaultValue = '') {
  return typeof str === 'string' ? str : defaultValue;
}

function safeObject(obj, defaultValue = {}) {
  return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : defaultValue;
}

function safeNumber(num, defaultValue = 0) {
  return typeof num === 'number' && !isNaN(num) ? num : defaultValue;
}

// ===================================================================
// EXTRACCIÓN DE DATOS DEL PROP
// ===================================================================

const { data } = Astro.props;
const language = safeString(data?.language, 'es');

// ===================================================================
// PROCESAMIENTO DEFENSIVO DE DATOS
// ===================================================================

const articleData = safeObject(data?.article, {});
const categoryData = safeObject(data?.category, {});
const seoData = safeObject(data?.seo, {});

// Datos seguros del artículo
const safeArticle = {
  id: safeString(articleData.id),
  title: safeString(articleData.title, 'Artículo sin título'),
  subtitle: safeString(articleData.subtitle),
  excerpt: safeString(articleData.excerpt, 'Extracto no disponible'),
  content: safeString(articleData.content, ''),
  featuredImage: safeString(articleData.featuredImage, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=1200&h=600&fit=crop'),
  publishedAt: safeString(articleData.publishedAt, new Date().toISOString()),
  views: safeNumber(articleData.views, 0),
  readTime: safeString(articleData.readTime, '5 min'),
  readTimeMinutes: safeNumber(articleData.readTimeMinutes, 5),
  featured: Boolean(articleData.featured),
  url: safeString(articleData.url, '#'),
  slug: safeString(articleData.slug),
  category: safeString(articleData.category || categoryData.name, 'General'),
  categorySlug: safeString(categoryData.slug || 'general'),
  tags: safeArray(articleData.tags, []),
  author: safeObject(articleData.author, {
    name: 'Equipo CLIC',
    avatar: 'https://pacewqgypevfgjmdsorz.supabase.co/storage/v1/object/public/avatars/profile_photos/6e9575f8-d8ef-4671-aa7f-e7193a2d3f21_1751833067618.jpg',
    position: language === 'es' ? 'Especialista Inmobiliario' :
              language === 'en' ? 'Real Estate Specialist' :
              'Spécialiste Immobilier',
    bio: language === 'es' ? 'Experto en bienes raíces con años de experiencia ayudando a clientes a encontrar su hogar perfecto.' :
         language === 'en' ? 'Real estate expert with years of experience helping clients find their perfect home.' :
         'Expert en immobilier avec des années d\'expérience aidant les clients à trouver leur maison parfaite.',
    phone: '+1 809 487 2542',
    whatsapp: '18094872542',
    email: 'info@clicinmobiliaria.com'
  }),
  language: language
};

// Artículos relacionados
const safeRelatedArticles = safeArray(data?.relatedArticles, []).map((article, index) => ({
  id: safeString(article.id, `related-${index}`),
  title: safeString(article.title, 'Artículo relacionado'),
  excerpt: safeString(article.excerpt, 'Extracto no disponible'),
  featuredImage: safeString(article.featuredImage, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=300&fit=crop'),
  url: safeString(article.url, '#'),
  publishedAt: safeString(article.publishedAt, new Date().toISOString()),
  readTime: safeString(article.readTime, '5 min'),
  views: safeString(article.views, '0'),
  category: safeString(article.category, 'General'),
  categorySlug: safeString(article.categorySlug, 'general'),
  author: safeObject(article.author, {
    name: 'Equipo CLIC',
    avatar: 'https://pacewqgypevfgjmdsorz.supabase.co/storage/v1/object/public/avatars/profile_photos/6e9575f8-d8ef-4671-aa7f-e7193a2d3f21_1751833067618.jpg'
  })
}));

// SEO seguro
const safeSeo = {
  title: safeString(seoData.title, `${safeArticle.title} - Blog CLIC`),
  description: safeString(seoData.description, safeArticle.excerpt),
  breadcrumbs: safeArray(seoData.breadcrumbs, [
    {
      name: language === 'en' ? 'Home' : language === 'fr' ? 'Accueil' : 'Inicio',
      url: language === 'es' ? '/' : `/${language}/`
    },
    {
      name: language === 'en' ? 'Articles' : language === 'fr' ? 'Articles' : 'Artículos',
      url: language === 'es' ? '/articulos' : `/${language}/articles`
    },
    {
      name: safeArticle.category,
      url: language === 'es' ? `/articulos/${safeArticle.categorySlug}` : `/${language}/articles/${safeArticle.categorySlug}`
    },
    {
      name: safeArticle.title,
      url: safeArticle.url
    }
  ])
};

// ===================================================================
// PREPARAR PROPS PARA LAYOUT CON DATOS SEO COMPLETOS
// ===================================================================

const layoutProps = {
  title: safeSeo.title,
  description: safeSeo.description,
  ogImage: safeGet(seoData, 'ogImage') || safeArticle.featuredImage,
  canonical: safeGet(seoData, 'canonical_url') || safeArticle.url,
  keywords: safeGet(seoData, 'keywords') || `${safeArticle.title}, ${safeArticle.category}, artículos inmobiliarios, República Dominicana`,
  hreflangData: safeGet(seoData, 'hreflang') || {},
  globalConfig: data?.globalConfig || {},
  language: language,
  trackingString: data?.trackingString || '',
  hotItems: data?.hotItems || {},
  country: data?.country || {},
  breadcrumbs: safeSeo.breadcrumbs,
  structuredData: safeGet(seoData, 'structured_data') || {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": safeArticle.title,
    "description": safeArticle.excerpt,
    "image": safeArticle.featuredImage,
    "datePublished": safeArticle.publishedAt,
    "author": {
      "@type": "Person",
      "name": safeArticle.author.name
    },
    "publisher": {
      "@type": "Organization",
      "name": "CLIC Inmobiliaria"
    }
  },
  openGraph: safeGet(seoData, 'open_graph') || {
    title: safeSeo.title,
    description: safeSeo.description,
    image: safeArticle.featuredImage,
    type: 'article'
  },
  twitterCard: safeGet(seoData, 'twitter_card') || {}
};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    shareArticle: 'Compartir este artículo',
    aboutAuthor: 'Sobre el autor',
    sendEmail: 'Enviar email',
    contactWhatsApp: 'Contactar por WhatsApp',
    callNow: 'Llamar ahora',
    relatedArticlesTitle: 'Artículos relacionados',
    minRead: 'min de lectura',
    views: 'lecturas',
    author: 'Por',
    facebook: 'Facebook',
    twitter: 'Twitter', 
    linkedin: 'LinkedIn',
    share: 'Compartir',
    publishedOn: 'Publicado el',
    noRelatedArticles: 'No hay artículos relacionados disponibles'
  },
  en: {
    shareArticle: 'Share this article',
    aboutAuthor: 'About the author',
    sendEmail: 'Send email',
    contactWhatsApp: 'Contact via WhatsApp',
    callNow: 'Call now',
    relatedArticlesTitle: 'Related articles',
    minRead: 'min read',
    views: 'views',
    author: 'By',
    facebook: 'Facebook',
    twitter: 'Twitter',
    linkedin: 'LinkedIn', 
    share: 'Share',
    publishedOn: 'Published on',
    noRelatedArticles: 'No related articles available'
  },
  fr: {
    shareArticle: 'Partager cet article',
    aboutAuthor: 'À propos de l\'auteur',
    sendEmail: 'Envoyer un email',
    contactWhatsApp: 'Contacter via WhatsApp',
    callNow: 'Appeler maintenant',
    relatedArticlesTitle: 'Articles connexes',
    minRead: 'min de lecture',
    views: 'vues',
    author: 'Par',
    facebook: 'Facebook',
    twitter: 'Twitter',
    linkedin: 'LinkedIn',
    share: 'Partager',
    publishedOn: 'Publié le',
    noRelatedArticles: 'Aucun article connexe disponible'
  }
};

const text = TEXTS[language] || TEXTS.es;

// URLs según idioma
const routes = {
  es: {
    articlesBase: '/articulos'
  },
  en: {
    articlesBase: '/en/articles'  
  },
  fr: {
    articlesBase: '/fr/articles'
  }
};

const currentRoutes = routes[language] || routes.es;

// Función para formatear fecha
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
    }
    
    const months = {
      es: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
      en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      fr: ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre']
    };
    
    const monthNames = months[language] || months.es;
    return `${date.getDate()} de ${monthNames[date.getMonth()]} de ${date.getFullYear()}`;
  } catch (error) {
    return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
  }
}

console.log('✅ ArticlesSingleLayout preparado:', {
  language,
  title: safeArticle.title,
  author: safeArticle.author?.name,
  relatedArticlesCount: safeRelatedArticles.length,
  category: safeArticle.category
});
---

<Layout {...layoutProps}>
  <div class="min-h-screen bg-gray-50">

    <!-- Breadcrumbs -->
    <section class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-3">
        {safeSeo.breadcrumbs && safeSeo.breadcrumbs.length > 0 && (
          <div aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm text-gray-600">
              {safeSeo.breadcrumbs.map((breadcrumb, index) => (
                <li class="flex items-center">
                  {index > 0 && (
                    <i class="fas fa-chevron-right mx-2 text-gray-400 text-xs"></i>
                  )}
                  {index === safeSeo.breadcrumbs.length - 1 ? (
                    <span class="text-[#f04e00] font-medium">{breadcrumb.name}</span>
                  ) : (
                    <a href={breadcrumb.url} class="hover:text-[#f04e00] transition-colors">
                      {breadcrumb.name}
                    </a>
                  )}
                </li>
              ))}
            </ol>
          </div>
        )}
      </div>
    </section>

    <!-- Article Header -->
    <section class="py-12 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          
          <!-- Category and tags -->
          <div class="flex flex-wrap items-center gap-3 mb-6">
            <span class="bg-[#f04e00] text-white px-4 py-2 rounded-full text-sm font-medium">
              {safeArticle.category}
            </span>
            {safeArticle.tags.map((tag, index) => (
              <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm" key={index}>
                {safeString(tag.name || tag, 'Tag')}
              </span>
            ))}
          </div>

          <!-- Title and subtitle -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-6 leading-tight">
            {safeArticle.title}
          </h1>
          
          {safeArticle.subtitle && (
            <p class="text-xl text-gray-600 mb-8 font-medium leading-relaxed">
              {safeArticle.subtitle}
            </p>
          )}

          <!-- Article meta -->
          <div class="flex flex-wrap items-center gap-6 text-sm text-gray-600 mb-8 pb-8 border-b border-gray-200">
            <div class="flex items-center gap-3">
              <img 
                src={safeArticle.author.avatar} 
                alt={safeArticle.author.name}
                class="w-12 h-12 rounded-full"
              />
              <div>
                <p class="font-medium text-gray-900">{safeArticle.author.name}</p>
                <p class="text-gray-500">{safeArticle.author.position}</p>
              </div>
            </div>
            
            <div class="flex items-center gap-6">
              <span class="flex items-center gap-2">
                <i class="far fa-calendar text-gray-400"></i>
                {formatDate(safeArticle.publishedAt)}
              </span>
              
              <span class="flex items-center gap-2">
                <i class="far fa-clock text-gray-400"></i>
                {safeArticle.readTime}
              </span>
              
              <span class="flex items-center gap-2">
                <i class="far fa-eye text-gray-400"></i>
                {safeArticle.views.toLocaleString()} {text.views}
              </span>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Article Content with Magazine Layout -->
    <section class="py-0 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          
          <!-- Magazine-style layout -->
          <article class="magazine-article">
            
            <!-- Featured Image and initial content -->
            <div class="editorial-content">
              <div class="relative">
                
                <!-- Floating image -->
                <figure class="float-left mr-8 mb-6 w-96 group">
                  <div class="aspect-[4/3] relative overflow-hidden rounded-xl shadow-lg">
                    <img 
                      src={safeArticle.featuredImage} 
                      alt={safeArticle.title}
                      class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    />
                  </div>
                </figure>

                <!-- Article content that flows around image -->
                <div class="text-gray-700 leading-7 text-base magazine-text">
                  {safeArticle.content ? (
                    <div set:html={safeArticle.content} class="article-content" />
                  ) : (
                    <p class="mb-5 text-justify hyphens-auto">
                      {safeArticle.excerpt}
                    </p>
                  )}
                </div>

              </div>
            </div>

            <!-- Share buttons -->
            <div class="clear-both mt-12 pt-8 border-t border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">{text.shareArticle}</h3>
              <div class="flex flex-wrap gap-3">
                <a 
                  href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(`https://clicinmobiliaria.com${safeArticle.url}`)}`}
                  target="_blank"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
                >
                  <i class="fab fa-facebook-f"></i>
                  {text.facebook}
                </a>
                
                <a 
                  href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(`https://clicinmobiliaria.com${safeArticle.url}`)}&text=${encodeURIComponent(safeArticle.title)}`}
                  target="_blank"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-blue-400 text-white rounded-lg hover:bg-blue-500 transition-colors text-sm"
                >
                  <i class="fab fa-twitter"></i>
                  {text.twitter}
                </a>
                
                <a 
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`https://clicinmobiliaria.com${safeArticle.url}`)}`}
                  target="_blank"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors text-sm"
                >
                  <i class="fab fa-linkedin-in"></i>
                  {text.linkedin}
                </a>
                
                <button 
                  onclick={`if(navigator.share){navigator.share({title:'${safeArticle.title}',url:window.location.href})}`}
                  class="inline-flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                >
                  <i class="fas fa-share-alt"></i>
                  {text.share}
                </button>
              </div>
            </div>

            <!-- Author Bio -->
            <div class="mt-12 p-6 bg-gray-50 rounded-xl">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">{text.aboutAuthor}</h3>
              <div class="flex items-start gap-4">
                <img 
                  src={safeArticle.author.avatar} 
                  alt={safeArticle.author.name}
                  class="w-16 h-16 rounded-full"
                />
                <div class="flex-1">
                  <h4 class="text-lg font-semibold text-gray-900">{safeArticle.author.name}</h4>
                  <p class="text-[#f04e00] font-medium mb-2">{safeArticle.author.position}</p>
                  {safeArticle.author.bio && (
                    <p class="text-gray-600 mb-4">{safeArticle.author.bio}</p>
                  )}
                  
                  <div class="flex flex-wrap gap-4">
                    <a 
                      href={`https://wa.me/${safeArticle.author.whatsapp}?text=${encodeURIComponent(`Hola, leí tu artículo "${safeArticle.title}" y me gustaría más información`)}`}
                      target="_blank"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                    >
                      <i class="fab fa-whatsapp"></i>
                      {text.contactWhatsApp}
                    </a>
                    
                    <a 
                      href={`mailto:${safeArticle.author.email}`}
                      class="inline-flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                    >
                      <i class="far fa-envelope"></i>
                      {text.sendEmail}
                    </a>
                    
                    <a 
                      href={`tel:${safeArticle.author.phone}`}
                      class="inline-flex items-center gap-2 px-4 py-2 bg-[#f04e00] text-white rounded-lg hover:bg-[#d94400] transition-colors text-sm"
                    >
                      <i class="fas fa-phone"></i>
                      {text.callNow}
                    </a>
                  </div>
                </div>
              </div>
            </div>

          </article>

        </div>
      </div>
    </section>

    <!-- Related Articles -->
    {safeRelatedArticles.length > 0 && (
      <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8 text-center">
              {text.relatedArticlesTitle}
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              {safeRelatedArticles.map((article, index) => (
                <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden group" key={article.id || index}>
                  <a href={article.url} class="block">
                    <div class="aspect-[16/10] relative overflow-hidden">
                      <img 
                        src={article.featuredImage} 
                        alt={article.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      />
                      <div class="absolute top-3 right-3 bg-black/70 text-white px-3 py-1 rounded-full text-xs font-medium">
                        <i class="far fa-clock mr-1"></i>
                        {article.readTime}
                      </div>
                    </div>
                    
                    <div class="p-6">
                      <h3 class="text-lg font-bold text-gray-900 mb-3 line-clamp-2 group-hover:text-[#f04e00] transition-colors leading-tight">
                        {article.title}
                      </h3>
                      
                      <p class="text-gray-600 mb-4 line-clamp-3 text-sm leading-relaxed">
                        {article.excerpt}
                      </p>
                      
                      <div class="flex items-center justify-between text-sm text-gray-500">
                        <div class="flex items-center gap-2">
                          <img 
                            src={article.author.avatar} 
                            alt={article.author.name}
                            class="w-6 h-6 rounded-full"
                          />
                          <span class="truncate font-medium">{article.author.name}</span>
                        </div>
                        <span>{article.views} {text.views}</span>
                      </div>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Magazine-style text formatting */
  .magazine-text {
    text-align: justify;
    hyphens: auto;
    -webkit-hyphens: auto;
    -moz-hyphens: auto;
    -ms-hyphens: auto;
    line-height: 1.7;
  }

  /* Better floating image behavior */
  figure.float-left {
    shape-outside: margin-box;
    margin-bottom: 1.5rem;
  }

  /* Article content styling */
  .article-content p {
    margin-bottom: 1.25rem;
    text-align: justify;
    hyphens: auto;
    line-height: 1.7;
  }

  .article-content h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-top: 2rem;
    margin-bottom: 1rem;
    clear: both;
  }

  .article-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #f04e00;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .article-content strong,
  .article-content b {
    font-weight: 600;
    color: #1f2937;
  }

  .article-content a {
    color: #f04e00;
    text-decoration: underline;
    text-decoration-color: #f04e00;
  }

  .article-content a:hover {
    color: #d94400;
    text-decoration-color: #d94400;
  }

  .article-content ul,
  .article-content ol {
    margin: 1.25rem 0;
    padding-left: 1.5rem;
  }

  .article-content li {
    margin-bottom: 0.5rem;
  }

  /* Better responsive behavior */
  @media (max-width: 1024px) {
    figure.float-left {
      width: 320px !important;
    }
  }

  @media (max-width: 768px) {
    figure.float-left {
      float: none !important;
      width: 100% !important;
      margin-right: 0 !important;
      margin-bottom: 2rem;
    }
    
    .magazine-text p,
    .article-content p {
      text-align: left !important;
      hyphens: none !important;
    }
  }

  /* Smooth transitions */
  .group:hover .group-hover\:scale-105 {
    transform: scale(1.05);
  }
  
  .group:hover .group-hover\:text-[#f04e00] {
    color: #f04e00;
  }
</style>