---
// src/layouts/ArticlesMainLayout.astro - Layout para p√°gina principal de art√≠culos con validaci√≥n defensiva
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';

// ===================================================================
// FUNCIONES HELPER PARA VALIDACI√ìN DEFENSIVA
// ===================================================================

function safeGet(obj, path, defaultValue = null) {
  try {
    return path.split('.').reduce((current, key) => current && current[key], obj) || defaultValue;
  } catch (error) {
    console.warn('safeGet error:', error, 'path:', path);
    return defaultValue;
  }
}

function safeArray(arr, defaultValue = []) {
  return Array.isArray(arr) ? arr : defaultValue;
}

function safeString(str, defaultValue = '') {
  return typeof str === 'string' ? str : defaultValue;
}

function safeObject(obj, defaultValue = {}) {
  return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : defaultValue;
}

function safeNumber(num, defaultValue = 0) {
  return typeof num === 'number' && !isNaN(num) ? num : defaultValue;
}

// ===================================================================
// EXTRACCI√ìN DE DATOS DEL PROP CON VALIDACI√ìN DEFENSIVA
// ===================================================================

const { data } = Astro.props;
const language = safeString(data?.language, 'es');

// ===================================================================
// PROCESAMIENTO DEFENSIVO DE DATOS
// ===================================================================

let articlesData = safeObject(data);

// Procesar categor√≠as de forma defensiva
const rawCategories = safeArray(articlesData.categories);
const safeCategories = rawCategories.map((cat, index) => ({
  id: safeString(cat.id, `category-${index}`),
  name: safeString(cat.name || cat.title || cat.display_name, 'Categor√≠a sin nombre'),
  slug: safeString(cat.slug, `categoria-${index}`),
  url: safeString(cat.url, `#categoria-${index}`),
  articleCount: safeNumber(cat.articleCount || cat.count, 0),
  description: safeString(cat.description, 'Descripci√≥n no disponible'),
  featured: Boolean(cat.featured),
  thumbnail: safeString(cat.thumbnail, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=600&fit=crop'),
  icon: safeString(cat.icon, 'üì∞'),
  recentArticles: safeArray(cat.recentArticles, [])
}));

// Separar categor√≠as destacadas y regulares
let featuredCategories = safeCategories.filter(cat => cat.featured);
let regularCategories = safeCategories.filter(cat => !cat.featured);

// Si no hay categor√≠as destacadas, tomar las primeras 2 como destacadas
if (featuredCategories.length === 0 && regularCategories.length > 0) {
  featuredCategories = regularCategories.slice(0, 2).map(cat => ({ ...cat, featured: true }));
  regularCategories = regularCategories.slice(2);
}

// Procesar art√≠culos destacados
const rawFeaturedArticles = safeArray(articlesData.featuredArticles);
const safeFeaturedArticles = rawFeaturedArticles.map((article, index) => ({
  id: safeString(article.id, `featured-${index}`),
  title: safeString(article.title, 'Art√≠culo sin t√≠tulo'),
  excerpt: safeString(article.excerpt, 'Extracto no disponible'),
  subtitle: safeString(article.subtitle),
  featuredImage: safeString(article.featuredImage || article.featured_image, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=450&fit=crop'),
  publishedAt: safeString(article.publishedAt || article.published_at, new Date().toISOString()),
  views: safeString(article.views, '0'),
  readTime: safeString(article.readTime || article.read_time, '5 min'),
  featured: Boolean(article.featured),
  url: safeString(article.url, '#'),
  slug: safeString(article.slug),
  category: safeString(article.category, 'General'),
  categorySlug: safeString(article.categorySlug || article.category_slug, 'general'),
  tags: safeArray(article.tags, []),
  author: safeObject(article.author, {
    name: 'Equipo CLIC',
    avatar: '/images/team/clic-experts.jpg',
    title: 'Especialista Inmobiliario'
  })
}));

// Procesar art√≠culos recientes
const rawRecentArticles = safeArray(articlesData.recentArticles);
const safeRecentArticles = rawRecentArticles.map((article, index) => ({
  id: safeString(article.id, `recent-${index}`),
  title: safeString(article.title, 'Art√≠culo sin t√≠tulo'),
  excerpt: safeString(article.excerpt, 'Extracto no disponible'),
  subtitle: safeString(article.subtitle),
  featuredImage: safeString(article.featuredImage || article.featured_image, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=450&fit=crop'),
  publishedAt: safeString(article.publishedAt || article.published_at, new Date().toISOString()),
  views: safeString(article.views, '0'),
  readTime: safeString(article.readTime || article.read_time, '5 min'),
  featured: Boolean(article.featured),
  url: safeString(article.url, '#'),
  slug: safeString(article.slug),
  author: safeObject(article.author, {
    name: 'Equipo CLIC',
    avatar: '/images/team/clic-experts.jpg',
    title: 'Especialista Inmobiliario'
  })
}));

// Procesar propiedades relacionadas
const rawRelatedProperties = safeArray(articlesData.relatedProperties);
const safeRelatedProperties = rawRelatedProperties.map((property, index) => ({
  id: safeString(property.id, `property-${index}`),
  titulo: safeString(property.titulo || property.title, 'Propiedad sin t√≠tulo'),
  precio: safeString(property.precio || property.price, '$0'),
  imagen: safeString(property.imagen || property.image || property.featuredImage, 'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800&h=600&fit=crop'),
  sector: safeString(property.sector || property.location, 'Ubicaci√≥n no especificada'),
  habitaciones: safeNumber(property.habitaciones || property.bedrooms, 0),
  banos: safeNumber(property.banos || property.bathrooms, 0),
  metros: safeNumber(property.metros || property.area, 0),
  tipo: safeString(property.tipo || property.type, 'Propiedad'),
  destacado: Boolean(property.destacado || property.featured),
  nuevo: Boolean(property.nuevo || property.isNew),
  descuento: safeString(property.descuento || property.discount),
  slug: safeString(property.slug, `propiedad-${index}`)
}));

// Procesar estad√≠sticas
const rawStats = safeObject(articlesData.stats);
const safeStats = {
  totalArticles: safeNumber(rawStats.totalArticles, safeFeaturedArticles.length + safeRecentArticles.length),
  totalReads: safeString(rawStats.totalReads || rawStats.totalViews, '1.5M'),
  avgRating: safeNumber(rawStats.avgRating || rawStats.rating, 4.8),
  publishedThisMonth: safeNumber(rawStats.publishedThisMonth || rawStats.thisMonth, 5),
  totalCategories: safeNumber(rawStats.totalCategories, safeCategories.length),
  totalViews: safeString(rawStats.totalViews, '1500000')
};

// Procesar SEO
const rawSeo = safeObject(articlesData.seo);
const safeSeo = {
  title: safeString(rawSeo.title, 
    language === 'en' ? 'Real Estate Articles & Insights | CLIC Inmobiliaria' :
    language === 'fr' ? 'Articles & Insights Immobiliers | CLIC Inmobiliaria' :
    'Art√≠culos e Insights Inmobiliarios | CLIC Inmobiliaria'),
  description: safeString(rawSeo.description,
    language === 'en' ? 'Discover the latest real estate trends, market insights, and expert advice from CLIC Inmobiliaria.' :
    language === 'fr' ? 'D√©couvrez les derni√®res tendances immobili√®res et conseils d\'experts de CLIC Inmobiliaria.' :
    'Descubre las √∫ltimas tendencias inmobiliarias, insights del mercado y consejos expertos de CLIC Inmobiliaria.'),
  h1: safeString(rawSeo.h1,
    language === 'en' ? 'Real Estate Articles & Market Insights' :
    language === 'fr' ? 'Articles Immobiliers & Insights du March√©' :
    'Art√≠culos Inmobiliarios e Insights del Mercado'),
  h2: safeString(rawSeo.h2,
    language === 'en' ? 'Expert insights to make informed property decisions' :
    language === 'fr' ? 'Insights d\'experts pour prendre des d√©cisions immobili√®res √©clair√©es' :
    'Insights expertos para tomar decisiones inmobiliarias informadas'),
  canonical_url: safeString(rawSeo.canonical_url, language === 'es' ? '/articulos' : `/${language}/articles`),
  breadcrumbs: safeArray(rawSeo.breadcrumbs, [
    {
      name: language === 'en' ? 'Home' : language === 'fr' ? 'Accueil' : 'Inicio',
      url: language === 'es' ? '/' : `/${language}/`
    },
    {
      name: language === 'en' ? 'Articles' : language === 'fr' ? 'Articles' : 'Art√≠culos',
      url: language === 'es' ? '/articulos' : `/${language}/articles`
    }
  ])
};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    title: 'Blog Inmobiliario CLIC',
    subtitle: 'Gu√≠as, consejos y an√°lisis expertos para tomar las mejores decisiones inmobiliarias en Rep√∫blica Dominicana',
    featuredTitle: 'üåü Art√≠culos m√°s le√≠dos',
    categoriesTitle: 'Categor√≠as Destacadas',
    allCategoriesTitle: 'Todas las Categor√≠as',
    propertiesTitle: 'Propiedades destacadas en nuestros art√≠culos',
    propertiesSubtitle: 'Inversiones recomendadas por nuestros expertos',
    expertiseTitle: '¬øPor qu√© confiar en nuestro contenido?',
    expertiseSubtitle: 'Nuestros art√≠culos est√°n respaldados por m√°s de 15 a√±os de experiencia en el mercado inmobiliario dominicano',
    ctaTitle: '¬øNecesitas asesor√≠a personalizada?',
    ctaSubtitle: 'Nuestros expertos est√°n listos para ayudarte a tomar la mejor decisi√≥n',
    ctaButton1: 'Hablar con un experto',
    ctaButton2: 'Ver todas las propiedades',
    readMore: 'Leer m√°s',
    articles: 'art√≠culos',
    recentArticles: 'Art√≠culos recientes:',
    minRead: 'min de lectura',
    views: 'lecturas',
    author: 'Por',
    statsLabels: {
      articles: 'Art√≠culos publicados',
      reads: 'Lecturas totales',
      rating: 'Calificaci√≥n promedio',
      thisMonth: 'Nuevos este mes'
    },
    expertiseItems: {
      local: {
        title: 'Conocimiento Local',
        description: 'Expertos que viven y trabajan en Rep√∫blica Dominicana'
      },
      experience: {
        title: '15+ A√±os de Experiencia',
        description: 'Hemos acompa√±ado a miles de clientes en sus decisiones inmobiliarias'
      },
      updated: {
        title: 'Informaci√≥n Actualizada',
        description: 'Contenido revisado y actualizado regularmente por nuestros especialistas'
      },
      verified: {
        title: 'Datos Verificados',
        description: 'Todas nuestras cifras y an√°lisis est√°n respaldados por fuentes oficiales'
      }
    }
  },
  en: {
    title: 'CLIC Real Estate Blog',
    subtitle: 'Expert guides, tips and analysis to make the best real estate decisions in Dominican Republic',
    featuredTitle: 'üåü Most read articles',
    categoriesTitle: 'Featured Categories',
    allCategoriesTitle: 'All Categories',
    propertiesTitle: 'Properties featured in our articles',
    propertiesSubtitle: 'Investments recommended by our experts',
    expertiseTitle: 'Why trust our content?',
    expertiseSubtitle: 'Our articles are backed by more than 15 years of experience in the Dominican real estate market',
    ctaTitle: 'Need personalized advice?',
    ctaSubtitle: 'Our experts are ready to help you make the best decision',
    ctaButton1: 'Talk to an expert',
    ctaButton2: 'View all properties',
    readMore: 'Read more',
    articles: 'articles',
    recentArticles: 'Recent articles:',
    minRead: 'min read',
    views: 'views',
    author: 'By',
    statsLabels: {
      articles: 'Published articles',
      reads: 'Total reads',
      rating: 'Average rating',
      thisMonth: 'New this month'
    },
    expertiseItems: {
      local: {
        title: 'Local Knowledge',
        description: 'Experts who live and work in Dominican Republic'
      },
      experience: {
        title: '15+ Years Experience',
        description: 'We have guided thousands of clients in their real estate decisions'
      },
      updated: {
        title: 'Updated Information',
        description: 'Content reviewed and updated regularly by our specialists'
      },
      verified: {
        title: 'Verified Data',
        description: 'All our figures and analysis are backed by official sources'
      }
    }
  },
  fr: {
    title: 'Blog Immobilier CLIC',
    subtitle: 'Guides, conseils et analyses d\'experts pour prendre les meilleures d√©cisions immobili√®res en R√©publique dominicaine',
    featuredTitle: 'üåü Articles les plus lus',
    categoriesTitle: 'Cat√©gories en Vedette',
    allCategoriesTitle: 'Toutes les Cat√©gories',
    propertiesTitle: 'Propri√©t√©s mises en avant dans nos articles',
    propertiesSubtitle: 'Investissements recommand√©s par nos experts',
    expertiseTitle: 'Pourquoi faire confiance √† notre contenu?',
    expertiseSubtitle: 'Nos articles sont soutenus par plus de 15 ans d\'exp√©rience sur le march√© immobilier dominicain',
    ctaTitle: 'Besoin de conseils personnalis√©s?',
    ctaSubtitle: 'Nos experts sont pr√™ts √† vous aider √† prendre la meilleure d√©cision',
    ctaButton1: 'Parler √† un expert',
    ctaButton2: 'Voir toutes les propri√©t√©s',
    readMore: 'Lire plus',
    articles: 'articles',
    recentArticles: 'Articles r√©cents:',
    minRead: 'min de lecture',
    views: 'vues',
    author: 'Par',
    statsLabels: {
      articles: 'Articles publi√©s',
      reads: 'Lectures totales',
      rating: 'Note moyenne',
      thisMonth: 'Nouveaux ce mois'
    },
    expertiseItems: {
      local: {
        title: 'Connaissance Locale',
        description: 'Experts qui vivent et travaillent en R√©publique dominicaine'
      },
      experience: {
        title: '15+ Ans d\'Exp√©rience',
        description: 'Nous avons guid√© des milliers de clients dans leurs d√©cisions immobili√®res'
      },
      updated: {
        title: 'Information Mise √† Jour',
        description: 'Contenu revu et mis √† jour r√©guli√®rement par nos sp√©cialistes'
      },
      verified: {
        title: 'Donn√©es V√©rifi√©es',
        description: 'Tous nos chiffres et analyses sont soutenus par des sources officielles'
      }
    }
  }
};

const text = TEXTS[language] || TEXTS.es;

// URLs seg√∫n idioma
const routes = {
  es: {
    contact: '/contacto',
    properties: '/comprar',
    articlesBase: '/articulos'
  },
  en: {
    contact: '/en/contact',
    properties: '/en/buy',
    articlesBase: '/en/articles'
  },
  fr: {
    contact: '/fr/contact',
    properties: '/fr/acheter',
    articlesBase: '/fr/articles'
  }
};

const currentRoutes = routes[language] || routes.es;

// Funci√≥n para formatear fecha
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return language === 'en' ? 'Recent' : language === 'fr' ? 'R√©cent' : 'Reciente';
    }
    
    const months = {
      es: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
      en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      fr: ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre']
    };
    
    const monthNames = months[language] || months.es;
    return `${date.getDate()} de ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
  } catch (error) {
    return language === 'en' ? 'Recent' : language === 'fr' ? 'R√©cent' : 'Reciente';
  }
}

console.log('‚úÖ ArticlesMainLayout preparado con validaci√≥n defensiva:', {
  language,
  categoriesCount: safeCategories.length,
  featuredCount: featuredCategories.length,
  featuredArticlesCount: safeFeaturedArticles.length,
  recentArticlesCount: safeRecentArticles.length,
  totalArticles: safeStats.totalArticles
});
---

<Layout 
  title={safeSeo.title || text.title}
  description={safeSeo.description || text.subtitle}
  language={language}
>
  <!-- Hero Section -->
  <section class="bg-gradient-to-r from-[#f04e00] to-[#ff7a3d] py-16">
    <div class="container mx-auto px-4">
      <div class="text-center text-white">
        <h1 class="text-4xl md:text-5xl font-bold mb-6">
          {text.title}
        </h1>
        <p class="text-xl max-w-3xl mx-auto mb-8 text-white/90">
          {text.subtitle}
        </p>
        
        <!-- Stats -->
        <div class="flex flex-wrap justify-center gap-8 mt-10">
          <div class="text-center">
            <div class="text-3xl font-bold text-white mb-2">{safeStats.totalArticles}+</div>
            <div class="text-sm text-white/80">{text.statsLabels.articles}</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-white mb-2">{safeStats.totalReads}+</div>
            <div class="text-sm text-white/80">{text.statsLabels.reads}</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-white mb-2">{safeStats.avgRating}/5</div>
            <div class="text-sm text-white/80">{text.statsLabels.rating}</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-white mb-2">{safeStats.publishedThisMonth}</div>
            <div class="text-sm text-white/80">{text.statsLabels.thisMonth}</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Articles -->
  {safeArray(safeFeaturedArticles).length > 0 && (
    <section class="py-12 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">
          {text.featuredTitle}
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {safeArray(safeFeaturedArticles).map((article, index) => (
            <a 
              href={article.url}
              class="group bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden"
              key={article.id || index}
            >
              <div class="aspect-[16/9] relative overflow-hidden">
                <img 
                  src={article.featuredImage} 
                  alt={article.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                
                <!-- Category badge -->
                <div class="absolute top-4 left-4">
                  <span class="bg-[#f04e00] text-white px-3 py-1 rounded-full text-sm font-medium">
                    {article.category}
                  </span>
                </div>
                
                <!-- Read stats -->
                <div class="absolute top-4 right-4 bg-black/80 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  {article.views}
                </div>
                
                <!-- Read time indicator -->
                <div class="absolute bottom-4 right-4 bg-white/90 text-gray-900 px-3 py-1 rounded-full text-sm">
                  {article.readTime} {text.minRead}
                </div>
              </div>
              
              <div class="p-6">
                <div class="flex flex-wrap items-center gap-2 mb-3">
                  {safeArray(article.tags).map((tag, tagIndex) => (
                    <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded" key={tagIndex}>
                      {safeString(tag, 'Tag')}
                    </span>
                  ))}
                </div>
                
                <h3 class="text-xl font-semibold text-gray-900 mb-3 group-hover:text-[#f04e00] transition-colors">
                  {article.title}
                </h3>
                
                <p class="text-gray-600 mb-4">
                  {article.excerpt}
                </p>
                
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <img 
                      src={article.author.avatar} 
                      alt={article.author.name}
                      class="w-10 h-10 rounded-full"
                    />
                    <div>
                      <p class="text-sm font-medium text-gray-900">{article.author.name}</p>
                      <p class="text-xs text-gray-500">{article.author.title}</p>
                    </div>
                  </div>
                  
                  <span class="text-sm text-gray-500">
                    {formatDate(article.publishedAt)}
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Featured Categories -->
  {safeArray(featuredCategories).length > 0 && (
    <section class="py-12">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">{text.categoriesTitle}</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {safeArray(featuredCategories).map((category, index) => (
            <a 
              href={category.url}
              class="group relative overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
              key={category.id || index}
            >
              <div class="aspect-[16/9] relative">
                <img 
                  src={category.thumbnail} 
                  alt={category.name}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                
                <!-- Content overlay -->
                <div class="absolute bottom-0 left-0 right-0 p-8">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="text-4xl">{category.icon}</span>
                    <h3 class="text-3xl font-bold text-white">{category.name}</h3>
                  </div>
                  <p class="text-lg text-white/90 mb-4">{category.description}</p>
                  
                  <div class="flex items-center justify-between">
                    <span class="text-white/80">
                      {category.articleCount} {text.articles}
                    </span>
                    <span class="inline-flex items-center gap-2 text-white group-hover:gap-3 transition-all">
                      {text.readMore}
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </span>
                  </div>
                  
                  <!-- Recent articles preview -->
                  {safeArray(category.recentArticles).length > 0 && (
                    <div class="mt-4 pt-4 border-t border-white/20">
                      <p class="text-sm text-white/70 mb-2">{text.recentArticles}</p>
                      <ul class="text-sm text-white/90 space-y-1">
                        {safeArray(category.recentArticles).slice(0, 3).map((article, articleIndex) => (
                          <li class="flex items-center gap-2" key={articleIndex}>
                            <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            {safeString(article, 'Art√≠culo')}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- All Categories -->
  {safeArray(regularCategories).length > 0 && (
    <section class="py-12 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">{text.allCategoriesTitle}</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {safeArray(regularCategories).map((category, index) => (
            <a 
              href={category.url}
              class="group bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 p-6"
              key={category.id || index}
            >
              <div class="flex items-start gap-4">
                <span class="text-4xl flex-shrink-0">{category.icon}</span>
                <div class="flex-1">
                  <h3 class="text-xl font-semibold text-gray-900 mb-2 group-hover:text-[#f04e00] transition-colors">
                    {category.name}
                  </h3>
                  <p class="text-gray-600 mb-4">{category.description}</p>
                  
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">
                      {category.articleCount} {text.articles}
                    </span>
                    <span class="text-[#f04e00] group-hover:translate-x-1 transition-transform inline-flex items-center gap-1">
                      {text.readMore}
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </span>
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Related Properties -->
  {safeArray(safeRelatedProperties).length > 0 && (
    <PropertyCarousel 
      title={text.propertiesTitle}
      subtitle={text.propertiesSubtitle}
      properties={safeRelatedProperties}
      viewAllLink={`${currentRoutes.properties}?fuente=blog`}
      language={language}
    />
  )}

  <!-- Expertise Section -->
  <section class="py-16 bg-gradient-to-r from-gray-900 to-gray-800">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
        {text.expertiseTitle}
      </h2>
      <p class="text-xl text-white/80 mb-12 max-w-2xl mx-auto">
        {text.expertiseSubtitle}
      </p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
        <div class="text-center">
          <div class="w-16 h-16 bg-[#f04e00] rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">{text.expertiseItems.local.title}</h3>
          <p class="text-sm text-white/70">{text.expertiseItems.local.description}</p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 bg-[#f04e00] rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">{text.expertiseItems.experience.title}</h3>
          <p class="text-sm text-white/70">{text.expertiseItems.experience.description}</p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 bg-[#f04e00] rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">{text.expertiseItems.updated.title}</h3>
          <p class="text-sm text-white/70">{text.expertiseItems.updated.description}</p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 bg-[#f04e00] rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">{text.expertiseItems.verified.title}</h3>
          <p class="text-sm text-white/70">{text.expertiseItems.verified.description}</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-[#f04e00]">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
        {text.ctaTitle}
      </h2>
      <p class="text-xl text-white/90 mb-8 max-w-2xl mx-auto">
        {text.ctaSubtitle}
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href={currentRoutes.contact} class="inline-block px-8 py-3 bg-white text-[#f04e00] rounded-lg hover:bg-gray-100 transition-colors font-medium">
          {text.ctaButton1}
        </a>
        <a href={currentRoutes.properties} class="inline-block px-8 py-3 bg-white/20 text-white border border-white rounded-lg hover:bg-white/30 transition-colors font-medium">
          {text.ctaButton2}
        </a>
      </div>
    </div>
  </section>
</Layout>