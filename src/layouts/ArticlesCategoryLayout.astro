---
// src/layouts/ArticlesCategoryLayout.astro - Layout para categor√≠as de art√≠culos con validaci√≥n defensiva
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';

// ===================================================================
// FUNCIONES HELPER PARA VALIDACI√ìN DEFENSIVA
// ===================================================================

function safeGet(obj, path, defaultValue = null) {
  try {
    return path.split('.').reduce((current, key) => current && current[key], obj) || defaultValue;
  } catch (error) {
    console.warn('safeGet error:', error, 'path:', path);
    return defaultValue;
  }
}

function safeArray(arr, defaultValue = []) {
  return Array.isArray(arr) ? arr : defaultValue;
}

function safeString(str, defaultValue = '') {
  return typeof str === 'string' ? str : defaultValue;
}

function safeObject(obj, defaultValue = {}) {
  return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : defaultValue;
}

function safeNumber(num, defaultValue = 0) {
  return typeof num === 'number' && !isNaN(num) ? num : defaultValue;
}

// ===================================================================
// EXTRACCI√ìN DE DATOS DEL PROP CON VALIDACI√ìN DEFENSIVA
// ===================================================================

const { data } = Astro.props;
const language = safeString(data?.language, 'es');
const categorySlug = safeString(data?.category || data?.categorySlug || data?.slug, 'general');

// ===================================================================
// PROCESAMIENTO DEFENSIVO DE DATOS
// ===================================================================

let categoryData = safeObject(data);

// Configuraciones por defecto de categor√≠as
const categoryConfigs = {
  'guias-de-compra': {
    title: language === 'es' ? 'Gu√≠as de Compra' :
           language === 'en' ? 'Buying Guides' :
           'Guides d\'Achat',
    description: language === 'es' ? 'Todo lo que necesitas saber para comprar tu propiedad ideal en Rep√∫blica Dominicana. Desde el proceso legal hasta consejos pr√°cticos de negociaci√≥n.' :
                 language === 'en' ? 'Everything you need to know to buy your ideal property in Dominican Republic. From legal process to practical negotiation tips.' :
                 'Tout ce que vous devez savoir pour acheter votre propri√©t√© id√©ale en R√©publique dominicaine. Du processus juridique aux conseils pratiques de n√©gociation.',
    icon: 'üìö'
  },
  'inversion-inmobiliaria': {
    title: language === 'es' ? 'Inversi√≥n Inmobiliaria' :
           language === 'en' ? 'Real Estate Investment' :
           'Investissement Immobilier',
    description: language === 'es' ? 'Estrategias, an√°lisis y casos de √©xito para maximizar tu retorno de inversi√≥n en el mercado inmobiliario dominicano.' :
                 language === 'en' ? 'Strategies, analysis and success cases to maximize your return on investment in the Dominican real estate market.' :
                 'Strat√©gies, analyses et cas de succ√®s pour maximiser votre retour sur investissement sur le march√© immobilier dominicain.',
    icon: 'üìà'
  },
  'mercado-inmobiliario': {
    title: language === 'es' ? 'Mercado Inmobiliario' :
           language === 'en' ? 'Real Estate Market' :
           'March√© Immobilier',
    description: language === 'es' ? 'An√°lisis de tendencias, precios y oportunidades en el mercado dominicano' :
                 language === 'en' ? 'Analysis of trends, prices and opportunities in the Dominican market' :
                 'Analyse des tendances, prix et opportunit√©s sur le march√© dominicain',
    icon: 'üèòÔ∏è'
  },
  'tips': {
    title: language === 'es' ? 'Tips y Consejos' :
           language === 'en' ? 'Tips & Advice' :
           'Conseils et Astuces',
    description: language === 'es' ? 'Consejos pr√°cticos y tips expertos para navegar el mercado inmobiliario con √©xito' :
                 language === 'en' ? 'Practical advice and expert tips to successfully navigate the real estate market' :
                 'Conseils pratiques et astuces d\'experts pour naviguer avec succ√®s sur le march√© immobilier',
    icon: 'üí°'
  },
  'comparativas': {
    title: language === 'es' ? 'Comparativas' :
           language === 'en' ? 'Comparisons' :
           'Comparaisons',
    description: language === 'es' ? 'Comparaciones detalladas para ayudarte a tomar la mejor decisi√≥n inmobiliaria' :
                 language === 'en' ? 'Detailed comparisons to help you make the best real estate decision' :
                 'Comparaisons d√©taill√©es pour vous aider √† prendre la meilleure d√©cision immobili√®re',
    icon: '‚öñÔ∏è'
  },
  'ubicacion': {
    title: language === 'es' ? 'Ubicaciones' :
           language === 'en' ? 'Locations' :
           'Emplacements',
    description: language === 'es' ? 'Gu√≠as de ubicaciones y an√°lisis de los mejores sectores para vivir e invertir' :
                 language === 'en' ? 'Location guides and analysis of the best areas to live and invest' :
                 'Guides d\'emplacement et analyse des meilleurs secteurs pour vivre et investir',
    icon: 'üìç'
  }
};

// Obtener configuraci√≥n de categor√≠a o usar fallback
const currentConfig = categoryConfigs[categorySlug] || categoryConfigs['guias-de-compra'];

// Crear datos seguros de categor√≠a
const safeCategoryData = {
  language: language,
  category: categorySlug,
  categorySlug: categorySlug,
  title: safeString(safeGet(categoryData, 'category.name') || categoryData.title || currentConfig.title),
  description: safeString(safeGet(categoryData, 'category.description') || categoryData.description || currentConfig.description),
  icon: safeString(safeGet(categoryData, 'category.icon') || categoryData.icon || currentConfig.icon),
  slug: safeString(safeGet(categoryData, 'category.slug') || categoryData.slug || categorySlug),
  url: safeString(safeGet(categoryData, 'category.url') || categoryData.url || `#${categorySlug}`)
};

// Procesar art√≠culos de forma defensiva
const rawArticles = safeArray(categoryData.articles);
const safeArticles = rawArticles.map((article, index) => ({
  id: safeString(article.id, `article-${index}`),
  slug: safeString(article.slug, `articulo-${index}`),
  title: safeString(article.title, 'Art√≠culo sin t√≠tulo'),
  excerpt: safeString(article.excerpt, 'Extracto no disponible'),
  featuredImage: safeString(article.featuredImage || article.featured_image, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=450&fit=crop'),
  publishedAt: safeString(article.publishedAt || article.published_at, new Date().toISOString()),
  readTime: safeNumber(article.readTime || article.read_time, 5),
  views: safeString(article.views, '0'),
  featured: Boolean(article.featured),
  tags: safeArray(article.tags, [language === 'es' ? 'General' : 'General']),
  author: safeObject(article.author, {
    name: 'Equipo CLIC',
    avatar: 'https://i.pravatar.cc/150?img=1',
    title: language === 'es' ? 'Especialista Inmobiliario' :
           language === 'en' ? 'Real Estate Specialist' :
           'Sp√©cialiste Immobilier'
  }),
  url: safeString(article.url, '#')
}));

// Si no hay art√≠culos del backend, crear art√≠culos de fallback
let finalArticles = safeArticles;
if (finalArticles.length === 0) {
  console.log('üìã ArticlesCategoryLayout: Creando art√≠culos de fallback');
  finalArticles = [
    {
      id: 'fallback-1',
      slug: 'guia-completa-comprar-villa-punta-cana',
      title: language === 'es' ? 'Gu√≠a Completa para Comprar una Villa en Punta Cana' :
              language === 'en' ? 'Complete Guide to Buying a Villa in Punta Cana' :
              'Guide Complet pour Acheter une Villa √† Punta Cana',
      excerpt: language === 'es' ? 'Descubre paso a paso c√≥mo adquirir tu villa so√±ada en el para√≠so caribe√±o. Incluye an√°lisis de zonas, precios y documentaci√≥n necesaria.' :
               language === 'en' ? 'Discover step by step how to acquire your dream villa in the Caribbean paradise. Includes area analysis, prices and required documentation.' :
               'D√©couvrez √©tape par √©tape comment acqu√©rir votre villa de r√™ve dans le paradis carib√©en. Comprend l\'analyse des zones, les prix et la documentation requise.',
      featuredImage: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800&h=450&fit=crop',
      author: {
        name: 'Mar√≠a Rodr√≠guez',
        avatar: 'https://i.pravatar.cc/150?img=5',
        title: language === 'es' ? 'Especialista en Punta Cana' :
               language === 'en' ? 'Punta Cana Specialist' :
               'Sp√©cialiste de Punta Cana'
      },
      publishedAt: '2024-03-20',
      readTime: 15,
      views: '12.5K',
      featured: true,
      tags: ['Punta Cana', 'Villas', language === 'es' ? 'Proceso de Compra' : language === 'en' ? 'Buying Process' : 'Processus d\'Achat'],
      url: '#'
    },
    {
      id: 'fallback-2',
      slug: 'documentos-extranjeros-comprar-rd',
      title: language === 'es' ? 'Documentos Necesarios para Extranjeros que Compran en RD' :
              language === 'en' ? 'Required Documents for Foreigners Buying in DR' :
              'Documents N√©cessaires pour les √âtrangers Achetant en RD',
      excerpt: language === 'es' ? 'Lista completa y actualizada de todos los documentos que necesitas como extranjero para comprar propiedades en Rep√∫blica Dominicana.' :
               language === 'en' ? 'Complete and updated list of all documents you need as a foreigner to buy properties in Dominican Republic.' :
               'Liste compl√®te et mise √† jour de tous les documents dont vous avez besoin en tant qu\'√©tranger pour acheter des propri√©t√©s en R√©publique dominicaine.',
      featuredImage: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=800&h=450&fit=crop',
      author: {
        name: 'Carlos Mej√≠a',
        avatar: 'https://i.pravatar.cc/150?img=8',
        title: language === 'es' ? 'Asesor Legal' :
               language === 'en' ? 'Legal Advisor' :
               'Conseiller Juridique'
      },
      publishedAt: '2024-03-18',
      readTime: 10,
      views: '8.3K',
      featured: true,
      tags: ['Legal', language === 'es' ? 'Extranjeros' : language === 'en' ? 'Foreigners' : '√âtrangers', 'Documentaci√≥n'],
      url: '#'
    }
  ];
}

// Separar art√≠culos destacados y regulares
const featuredArticles = finalArticles.filter(a => a.featured);
const regularArticles = finalArticles.filter(a => !a.featured);

// Procesar propiedades relacionadas
const rawRelatedProperties = safeArray(categoryData.relatedProperties);
const safeRelatedProperties = rawRelatedProperties.map((property, index) => ({
  id: safeString(property.id, `property-${index}`),
  slug: safeString(property.slug, `propiedad-${index}`),
  titulo: safeString(property.titulo || property.title, 'Propiedad sin t√≠tulo'),
  precio: safeString(property.precio || property.price, '$0'),
  imagen: safeString(property.imagen || property.image || property.featuredImage, 'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800&h=600&fit=crop'),
  sector: safeString(property.sector || property.location, 'Ubicaci√≥n no especificada'),
  habitaciones: safeNumber(property.habitaciones || property.bedrooms, 0),
  banos: safeNumber(property.banos || property.bathrooms, 0),
  metros: safeNumber(property.metros || property.area, 0),
  tipo: safeString(property.tipo || property.type, 'Propiedad'),
  destacado: Boolean(property.destacado || property.featured),
  nuevo: Boolean(property.nuevo || property.isNew),
  descuento: safeString(property.descuento || property.discount)
}));

// Art√≠culos m√°s populares de la categor√≠a (ordenados por vistas)
const popularArticles = [...finalArticles]
  .sort((a, b) => {
    const viewsA = parseInt(safeString(a.views, '0').replace('K', '000').replace('.', '')) || 0;
    const viewsB = parseInt(safeString(b.views, '0').replace('K', '000').replace('.', '')) || 0;
    return viewsB - viewsA;
  })
  .slice(0, 5);

// SEO seguro
const safeSeo = {
  title: safeString(safeGet(categoryData, 'seo.title'), `${safeCategoryData.title} - Blog CLIC`),
  description: safeString(safeGet(categoryData, 'seo.description'), safeCategoryData.description)
};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    breadcrumbArticles: 'Art√≠culos',
    featuredTitle: 'Art√≠culos Destacados',
    allTitle: 'Todos los Art√≠culos',
    popularTitle: 'üî• M√°s populares en',
    newsletterTitle: 'üìß No te pierdas ning√∫n art√≠culo',
    newsletterSubtitle: 'Recibe nuestros mejores contenidos directo a tu correo',
    newsletterButton: 'Suscribirse',
    propertiesTitle: 'Propiedades recomendadas para',
    propertiesSubtitle: 'Basadas en los art√≠culos m√°s le√≠dos de esta categor√≠a',
    ctaTitle: '¬øTienes preguntas sobre',
    ctaSubtitle: 'Nuestros asesores expertos est√°n listos para ayudarte',
    ctaButton: 'Hablar con un asesor',
    readMore: 'Leer m√°s',
    minRead: 'min de lectura',
    views: 'vistas',
    author: 'Por',
    articles: 'art√≠culos',
    recentArticles: 'Art√≠culos recientes:'
  },
  en: {
    breadcrumbArticles: 'Articles',
    featuredTitle: 'Featured Articles',
    allTitle: 'All Articles',
    popularTitle: 'üî• Most popular in',
    newsletterTitle: 'üìß Don\'t miss any article',
    newsletterSubtitle: 'Get our best content straight to your inbox',
    newsletterButton: 'Subscribe',
    propertiesTitle: 'Recommended properties for',
    propertiesSubtitle: 'Based on the most read articles in this category',
    ctaTitle: 'Do you have questions about',
    ctaSubtitle: 'Our expert advisors are ready to help you',
    ctaButton: 'Talk to an advisor',
    readMore: 'Read more',
    minRead: 'min read',
    views: 'views',
    author: 'By',
    articles: 'articles',
    recentArticles: 'Recent articles:'
  },
  fr: {
    breadcrumbArticles: 'Articles',
    featuredTitle: 'Articles en Vedette',
    allTitle: 'Tous les Articles',
    popularTitle: 'üî• Les plus populaires dans',
    newsletterTitle: 'üìß Ne manquez aucun article',
    newsletterSubtitle: 'Recevez notre meilleur contenu directement dans votre bo√Æte mail',
    newsletterButton: 'S\'abonner',
    propertiesTitle: 'Propri√©t√©s recommand√©es pour',
    propertiesSubtitle: 'Bas√©es sur les articles les plus lus de cette cat√©gorie',
    ctaTitle: 'Avez-vous des questions sur',
    ctaSubtitle: 'Nos conseillers experts sont pr√™ts √† vous aider',
    ctaButton: 'Parler √† un conseiller',
    readMore: 'Lire plus',
    minRead: 'min de lecture',
    views: 'vues',
    author: 'Par',
    articles: 'articles',
    recentArticles: 'Articles r√©cents:'
  }
};

const text = TEXTS[language] || TEXTS.es;

// URLs seg√∫n idioma
const routes = {
  es: {
    contact: '/contacto',
    properties: '/comprar',
    articlesBase: '/articulos'
  },
  en: {
    contact: '/en/contact',
    properties: '/en/buy',
    articlesBase: '/en/articles'
  },
  fr: {
    contact: '/fr/contact',
    properties: '/fr/acheter',
    articlesBase: '/fr/articles'
  }
};

const currentRoutes = routes[language] || routes.es;

// Funci√≥n para formatear fecha
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return language === 'en' ? 'Recent' : language === 'fr' ? 'R√©cent' : 'Reciente';
    }
    
    const months = {
      es: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
      en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      fr: ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre']
    };
    
    const monthNames = months[language] || months.es;
    return `${date.getDate()} de ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
  } catch (error) {
    return language === 'en' ? 'Recent' : language === 'fr' ? 'R√©cent' : 'Reciente';
  }
}

console.log('‚úÖ ArticlesCategoryLayout preparado con validaci√≥n defensiva:', {
  language,
  category: categorySlug,
  title: safeCategoryData.title,
  articlesCount: finalArticles.length,
  featuredCount: featuredArticles.length,
  regularCount: regularArticles.length,
  propertiesCount: safeRelatedProperties.length
});
---

<Layout 
  title={safeSeo.title}
  description={safeSeo.description}
  language={language}
>
  <!-- Breadcrumbs -->
  <section class="bg-gray-50 py-4">
    <div class="container mx-auto px-4">
      <nav class="text-sm text-gray-600">
        <a href={currentRoutes.articlesBase} class="hover:text-[#f04e00]">{text.breadcrumbArticles}</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{safeCategoryData.title}</span>
      </nav>
    </div>
  </section>

  <!-- Hero Section -->
  <section class="bg-gradient-to-b from-gray-50 to-white py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl">
        <div class="flex items-center gap-4 mb-4">
          <span class="text-5xl">{safeCategoryData.icon}</span>
          <h1 class="text-4xl md:text-5xl font-bold text-gray-900">
            {safeCategoryData.title}
          </h1>
        </div>
        <p class="text-xl text-gray-600">
          {safeCategoryData.description}
        </p>
      </div>
    </div>
  </section>

  <!-- Main Content Grid -->
  <section class="py-12">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Articles Column - 2/3 width -->
        <div class="lg:col-span-2">
          
          <!-- Featured Articles -->
          {safeArray(featuredArticles).length > 0 && (
            <div class="mb-12">
              <h2 class="text-2xl font-bold text-gray-900 mb-6">{text.featuredTitle}</h2>
              
              <div class="space-y-8">
                {safeArray(featuredArticles).map((article, index) => (
                  <article class="bg-white rounded-xl shadow-md hover:shadow-xl transition-shadow overflow-hidden" key={article.id || index}>
                    <a 
                      href={article.url || `${currentRoutes.articlesBase}/${categorySlug}/${article.slug}`}
                      class="flex flex-col md:flex-row"
                    >
                      <div class="md:w-2/5">
                        <div class="aspect-[16/9] md:aspect-[4/3] h-full">
                          <img 
                            src={article.featuredImage} 
                            alt={article.title}
                            class="w-full h-full object-cover"
                          />
                        </div>
                      </div>
                      
                      <div class="flex-1 p-6">
                        <div class="flex items-center gap-2 mb-3">
                          {safeArray(article.tags).map((tag, tagIndex) => (
                            <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded" key={tagIndex}>
                              {safeString(tag, 'Tag')}
                            </span>
                          ))}
                        </div>
                        
                        <h3 class="text-xl font-semibold text-gray-900 mb-3 hover:text-[#f04e00] transition-colors">
                          {article.title}
                        </h3>
                        
                        <p class="text-gray-600 mb-4 line-clamp-2">
                          {article.excerpt}
                        </p>
                        
                        <div class="flex items-center justify-between">
                          <div class="flex items-center gap-3">
                            <img 
                              src={article.author.avatar} 
                              alt={article.author.name}
                              class="w-10 h-10 rounded-full"
                            />
                            <div>
                              <p class="text-sm font-medium text-gray-900">{article.author.name}</p>
                              <p class="text-xs text-gray-500">{article.author.title}</p>
                            </div>
                          </div>
                          
                          <div class="text-sm text-gray-500">
                            {article.readTime} {text.minRead} ‚Ä¢ {article.views} {text.views}
                          </div>
                        </div>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </div>
          )}
          
          <!-- Regular Articles Grid -->
          {safeArray(regularArticles).length > 0 && (
            <div>
              <h2 class="text-2xl font-bold text-gray-900 mb-6">{text.allTitle}</h2>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {safeArray(regularArticles).map((article, index) => (
                  <article class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow" key={article.id || index}>
                    <a href={article.url || `${currentRoutes.articlesBase}/${categorySlug}/${article.slug}`}>
                      <div class="aspect-[16/9] overflow-hidden rounded-t-lg">
                        <img 
                          src={article.featuredImage} 
                          alt={article.title}
                          class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                        />
                      </div>
                      
                      <div class="p-5">
                        <div class="flex items-center gap-2 mb-2">
                          {safeArray(article.tags).slice(0, 2).map((tag, tagIndex) => (
                            <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded" key={tagIndex}>
                              {safeString(tag, 'Tag')}
                            </span>
                          ))}
                        </div>
                        
                        <h3 class="font-semibold text-gray-900 mb-2 hover:text-[#f04e00] transition-colors line-clamp-2">
                          {article.title}
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                          {article.excerpt}
                        </p>
                        
                        <div class="flex items-center justify-between text-sm text-gray-500">
                          <span>{formatDate(article.publishedAt)}</span>
                          <span>{article.readTime} {text.minRead}</span>
                        </div>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </div>
          )}
          
          <!-- Mensaje si no hay art√≠culos -->
          {finalArticles.length === 0 && (
            <div class="text-center py-12">
              <div class="text-6xl mb-4">üìÑ</div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">
                {language === 'en' ? 'No articles yet' : language === 'fr' ? 'Pas encore d\'articles' : 'A√∫n no hay art√≠culos'}
              </h3>
              <p class="text-gray-600">
                {language === 'en' ? 'Check back soon for new content in this category.' : 
                 language === 'fr' ? 'Revenez bient√¥t pour du nouveau contenu dans cette cat√©gorie.' : 
                 'Vuelve pronto para encontrar nuevo contenido en esta categor√≠a.'}
              </p>
            </div>
          )}
        </div>
        
        <!-- Sidebar - 1/3 width -->
        <aside class="lg:col-span-1">
          
          <!-- Popular Articles -->
          {safeArray(popularArticles).length > 0 && (
            <div class="bg-white rounded-lg shadow-md p-6 mb-8 sticky top-24">
              <h3 class="text-lg font-bold text-gray-900 mb-4">
                {text.popularTitle} {safeCategoryData.title}
              </h3>
              
              <div class="space-y-4">
                {safeArray(popularArticles).map((article, index) => (
                  <a 
                    href={article.url || `${currentRoutes.articlesBase}/${categorySlug}/${article.slug}`}
                    class="flex gap-3 group"
                    key={article.id || index}
                  >
                    <span class="text-2xl font-bold text-gray-200 group-hover:text-[#f04e00]/20 transition-colors">
                      {index + 1}
                    </span>
                    <div class="flex-1">
                      <h4 class="font-medium text-gray-900 group-hover:text-[#f04e00] transition-colors text-sm line-clamp-2">
                        {article.title}
                      </h4>
                      <p class="text-xs text-gray-500 mt-1">
                        {article.views} {text.views}
                      </p>
                    </div>
                  </a>
                ))}
              </div>
              
              <!-- Newsletter CTA -->
              <div class="mt-8 pt-8 border-t">
                <h4 class="font-semibold text-gray-900 mb-3">
                  {text.newsletterTitle}
                </h4>
                <p class="text-sm text-gray-600 mb-4">
                  {text.newsletterSubtitle}
                </p>
                <form class="space-y-3">
                  <input 
                    type="email" 
                    placeholder="tu@email.com"
                    class="w-full px-3 py-2 border rounded-md text-sm"
                  />
                  <button 
                    type="submit"
                    class="w-full bg-[#f04e00] text-white py-2 rounded-md hover:bg-[#d94400] transition-colors text-sm font-medium"
                  >
                    {text.newsletterButton}
                  </button>
                </form>
              </div>
            </div>
          )}
          
        </aside>
        
      </div>
    </div>
  </section>

  <!-- Related Properties -->
  {safeArray(safeRelatedProperties).length > 0 && (
    <PropertyCarousel 
      title={`${text.propertiesTitle} ${safeCategoryData.title.toLowerCase()}`}
      subtitle={text.propertiesSubtitle}
      properties={safeRelatedProperties}
      viewAllLink={`${currentRoutes.properties}?fuente=${categorySlug}`}
      language={language}
    />
  )}

  <!-- CTA Section -->
  <section class="py-16 bg-[#f04e00]">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold text-white mb-4">
        {text.ctaTitle} {safeCategoryData.title.toLowerCase()}?
      </h2>
      <p class="text-xl text-white/90 mb-8 max-w-2xl mx-auto">
        {text.ctaSubtitle}
      </p>
      <a 
        href={currentRoutes.contact} 
        class="inline-block px-8 py-3 bg-white text-[#f04e00] rounded-lg hover:bg-gray-100 transition-colors font-medium"
      >
        {text.ctaButton}
      </a>
    </div>
  </section>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>