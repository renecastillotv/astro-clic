---
// src/layouts/ArticlesCategoryLayout.astro - Layout para categorías de artículos con estilo magazine
import Layout from './Layout.astro';

// ===================================================================
// FUNCIONES HELPER PARA VALIDACIÓN DEFENSIVA
// ===================================================================

function safeGet(obj, path, defaultValue = null) {
  try {
    return path.split('.').reduce((current, key) => current && current[key], obj) || defaultValue;
  } catch (error) {
    console.warn('safeGet error:', error, 'path:', path);
    return defaultValue;
  }
}

function safeArray(arr, defaultValue = []) {
  return Array.isArray(arr) ? arr : defaultValue;
}

function safeString(str, defaultValue = '') {
  return typeof str === 'string' ? str : defaultValue;
}

function safeObject(obj, defaultValue = {}) {
  return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : defaultValue;
}

function safeNumber(num, defaultValue = 0) {
  return typeof num === 'number' && !isNaN(num) ? num : defaultValue;
}

// ===================================================================
// EXTRACCIÓN DE DATOS DEL PROP CON VALIDACIÓN DEFENSIVA
// ===================================================================

const { data } = Astro.props;
const language = safeString(data?.language, 'es');
const categorySlug = safeString(data?.category?.slug || data?.categorySlug || data?.slug, 'general');

// ===================================================================
// PROCESAMIENTO DEFENSIVO DE DATOS
// ===================================================================

let categoryData = safeObject(data);

// Configuraciones por defecto de categorías
const categoryConfigs = {
  'guias-de-compra': {
    title: language === 'es' ? 'Guías de Compra' :
           language === 'en' ? 'Buying Guides' :
           'Guides d\'Achat',
    description: language === 'es' ? 'Todo lo que necesitas saber para comprar tu propiedad ideal en República Dominicana. Desde el proceso legal hasta consejos prácticos de negociación.' :
                 language === 'en' ? 'Everything you need to know to buy your ideal property in Dominican Republic. From legal process to practical negotiation tips.' :
                 'Tout ce que vous devez savoir pour acheter votre propriété idéale en République dominicaine.',
    icon: 'fa-book'
  },
  'inversion': {
    title: language === 'es' ? 'Inversión Inmobiliaria' :
           language === 'en' ? 'Real Estate Investment' :
           'Investissement Immobilier',
    description: language === 'es' ? 'Estrategias, análisis y casos de éxito para maximizar tu retorno de inversión en el mercado inmobiliario dominicano.' :
                 language === 'en' ? 'Strategies, analysis and success cases to maximize your return on investment in the Dominican real estate market.' :
                 'Stratégies, analyses et cas de succès pour maximiser votre retour sur investissement.',
    icon: 'fa-chart-line'
  },
  'analisis-de-mercado': {
    title: language === 'es' ? 'Análisis de Mercado' :
           language === 'en' ? 'Market Analysis' :
           'Analyse de Marché',
    description: language === 'es' ? 'Análisis de tendencias, precios y oportunidades en el mercado dominicano' :
                 language === 'en' ? 'Analysis of trends, prices and opportunities in the Dominican market' :
                 'Analyse des tendances, prix et opportunités sur le marché dominicain',
    icon: 'fa-chart-bar'
  },
  'tips': {
    title: language === 'es' ? 'Tips y Consejos' :
           language === 'en' ? 'Tips & Advice' :
           'Conseils et Astuces',
    description: language === 'es' ? 'Consejos prácticos y tips expertos para navegar el mercado inmobiliario con éxito' :
                 language === 'en' ? 'Practical advice and expert tips to successfully navigate the real estate market' :
                 'Conseils pratiques et astuces d\'experts pour naviguer avec succès sur le marché immobilier',
    icon: 'fa-lightbulb'
  },
  'comparativas': {
    title: language === 'es' ? 'Comparativas' :
           language === 'en' ? 'Comparisons' :
           'Comparaisons',
    description: language === 'es' ? 'Comparaciones detalladas para ayudarte a tomar la mejor decisión inmobiliaria' :
                 language === 'en' ? 'Detailed comparisons to help you make the best real estate decision' :
                 'Comparaisons détaillées pour vous aider à prendre la meilleure décision immobilière',
    icon: 'fa-balance-scale'
  },
  'ubicacion': {
    title: language === 'es' ? 'Ubicaciones' :
           language === 'en' ? 'Locations' :
           'Emplacements',
    description: language === 'es' ? 'Guías de ubicaciones y análisis de los mejores sectores para vivir e invertir' :
                 language === 'en' ? 'Location guides and analysis of the best areas to live and invest' :
                 'Guides d\'emplacement et analyse des meilleurs secteurs pour vivre et investir',
    icon: 'fa-map-marker-alt'
  }
};

// Obtener configuración de categoría o usar fallback
const currentConfig = categoryConfigs[categorySlug] || categoryConfigs['guias-de-compra'];

// Crear datos seguros de categoría
const safeCategoryData = {
  language: language,
  category: categorySlug,
  categorySlug: categorySlug,
  title: safeString(safeGet(categoryData, 'category.name') || categoryData.title || currentConfig.title),
  description: safeString(safeGet(categoryData, 'category.description') || categoryData.description || currentConfig.description),
  icon: safeString(currentConfig.icon),
  slug: safeString(safeGet(categoryData, 'category.slug') || categoryData.slug || categorySlug),
  url: safeString(safeGet(categoryData, 'category.url') || categoryData.url || `#${categorySlug}`)
};

// Procesar artículos de forma defensiva
const rawArticles = safeArray(categoryData.articles);
const safeArticles = rawArticles.map((article, index) => ({
  id: safeString(article.id, `article-${index}`),
  slug: safeString(article.slug, `articulo-${index}`),
  title: safeString(article.title, 'Artículo sin título'),
  excerpt: safeString(article.excerpt, 'Extracto no disponible'),
  subtitle: safeString(article.subtitle),
  content: safeString(article.content, ''),
  featuredImage: safeString(article.featuredImage || article.featured_image, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=800&h=450&fit=crop'),
  publishedAt: safeString(article.publishedAt || article.published_at, new Date().toISOString()),
  readTime: safeString(article.readTime || article.read_time, '5 min'),
  readTimeMinutes: safeNumber(article.readTimeMinutes, 5),
  views: safeNumber(article.views, 0),
  featured: Boolean(article.featured),
  tags: safeArray(article.tags, []),
  author: safeObject(article.author, {
    name: 'Equipo CLIC',
    avatar: 'https://pacewqgypevfgjmdsorz.supabase.co/storage/v1/object/public/avatars/profile_photos/6e9575f8-d8ef-4671-aa7f-e7193a2d3f21_1751833067618.jpg',
    position: language === 'es' ? 'Especialista Inmobiliario' :
              language === 'en' ? 'Real Estate Specialist' :
              'Spécialiste Immobilier'
  }),
  url: safeString(article.url, '#')
}));

// Encontrar el artículo más popular (mayor views)
const mostPopularArticle = safeArticles.length > 0 ? 
  safeArticles.reduce((prev, current) => 
    (current.views > prev.views) ? current : prev, 
    safeArticles[0]
  ) : null;

// Artículos para el grid (excluir el más popular si hay más de 1)
const gridArticles = safeArticles.length > 1 ? 
  safeArticles.filter(article => article.id !== mostPopularArticle?.id) : 
  [];

// Función para extraer párrafos del contenido HTML
function extractParagraphs(htmlContent, maxParagraphs = 3) {
  if (!htmlContent) return [];
  
  const paragraphs = htmlContent.split('</p>')
    .slice(0, maxParagraphs)
    .map(p => p.replace(/<p[^>]*>/g, '').trim())
    .filter(p => p.length > 0);
    
  return paragraphs;
}

// SEO seguro
const safeSeo = {
  title: safeString(safeGet(categoryData, 'seo.title'), `${safeCategoryData.title} - Blog CLIC`),
  description: safeString(safeGet(categoryData, 'seo.description'), safeCategoryData.description),
  breadcrumbs: safeArray(safeGet(categoryData, 'seo.breadcrumbs'), [
    {
      name: language === 'en' ? 'Home' : language === 'fr' ? 'Accueil' : 'Inicio',
      url: language === 'es' ? '/' : `/${language}/`
    },
    {
      name: language === 'en' ? 'Articles' : language === 'fr' ? 'Articles' : 'Artículos',
      url: language === 'es' ? '/articulos' : `/${language}/articles`
    },
    {
      name: safeCategoryData.title,
      url: language === 'es' ? `/articulos/${categorySlug}` : `/${language}/articles/${categorySlug}`
    }
  ])
};

// ===================================================================
// PREPARAR PROPS PARA LAYOUT CON DATOS SEO COMPLETOS
// ===================================================================

const layoutProps = {
  title: safeSeo.title,
  description: safeSeo.description,
  ogImage: safeGet(categoryData, 'seo.ogImage') || '/og-articles.jpg',
  canonical: safeGet(categoryData, 'seo.canonical_url') || (language === 'es' ? `/articulos/${categorySlug}` : `/${language}/articles/${categorySlug}`),
  keywords: safeGet(categoryData, 'seo.keywords') || `${safeCategoryData.title}, artículos inmobiliarios, República Dominicana`,
  hreflangData: safeGet(categoryData, 'seo.hreflang') || {},
  globalConfig: data?.globalConfig || categoryData?.globalConfig || {},
  language: language,
  trackingString: categoryData?.trackingString || '',
  hotItems: categoryData?.hotItems || {},
  country: categoryData?.country || {},
  breadcrumbs: safeSeo.breadcrumbs,
  structuredData: safeGet(categoryData, 'seo.structured_data') || {
    "@context": "https://schema.org",
    "@type": "Blog",
    "name": safeSeo.title,
    "description": safeSeo.description,
    "url": `${data?.domainInfo?.realDomain || 'https://clicinmobiliaria.com'}${language === 'es' ? `/articulos/${categorySlug}` : `/${language}/articles/${categorySlug}`}`,
    "publisher": {
      "@type": "Organization", 
      "name": "CLIC Inmobiliaria"
    }
  },
  openGraph: safeGet(categoryData, 'seo.open_graph') || {
    title: safeSeo.title,
    description: safeSeo.description,
    type: 'website',
    site_name: 'CLIC Inmobiliaria'
  },
  twitterCard: safeGet(categoryData, 'seo.twitter_card') || {}
};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    breadcrumbArticles: 'Artículos',
    readMore: 'Leer más',
    readFull: 'Leer artículo completo',
    showMore: 'Leer contenido completo',
    showLess: 'Mostrar menos',
    moreArticles: 'Más artículos de',
    readingTime: 'min de lectura',
    views: 'lecturas',
    author: 'Por',
    publishedOn: 'Publicado el',
    articles: 'artículos',
    noArticles: 'Aún no hay artículos',
    noArticlesDesc: 'Vuelve pronto para encontrar nuevo contenido en esta categoría.',
    backToArticles: 'Ver todos los artículos'
  },
  en: {
    breadcrumbArticles: 'Articles',
    readMore: 'Read more',
    readFull: 'Read full article',
    showMore: 'Read full content',
    showLess: 'Show less',
    moreArticles: 'More articles in',
    readingTime: 'min read',
    views: 'views',
    author: 'By',
    publishedOn: 'Published on',
    articles: 'articles',
    noArticles: 'No articles yet',
    noArticlesDesc: 'Check back soon for new content in this category.',
    backToArticles: 'View all articles'
  },
  fr: {
    breadcrumbArticles: 'Articles',
    readMore: 'Lire plus',
    readFull: 'Lire l\'article complet',
    showMore: 'Lire le contenu complet',
    showLess: 'Afficher moins',
    moreArticles: 'Plus d\'articles dans',
    readingTime: 'min de lecture',
    views: 'vues',
    author: 'Par',
    publishedOn: 'Publié le',
    articles: 'articles',
    noArticles: 'Pas encore d\'articles',
    noArticlesDesc: 'Revenez bientôt pour du nouveau contenu dans cette catégorie.',
    backToArticles: 'Voir tous les articles'
  }
};

const text = TEXTS[language] || TEXTS.es;

// URLs según idioma
const routes = {
  es: {
    articlesBase: '/articulos'
  },
  en: {
    articlesBase: '/en/articles'
  },
  fr: {
    articlesBase: '/fr/articles'
  }
};

const currentRoutes = routes[language] || routes.es;

// Función para formatear fecha
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
    }
    
    const months = {
      es: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
      en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      fr: ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre']
    };
    
    const monthNames = months[language] || months.es;
    return `${date.getDate()} de ${monthNames[date.getMonth()]} de ${date.getFullYear()}`;
  } catch (error) {
    return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
  }
}

console.log('✅ ArticlesCategoryLayout preparado:', {
  language,
  category: categorySlug,
  title: safeCategoryData.title,
  articlesCount: safeArticles.length,
  mostPopular: mostPopularArticle?.title,
  gridCount: gridArticles.length
});
---

<Layout {...layoutProps}>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <div class="min-h-screen bg-gray-50">
    
    <!-- Hero Section with Category Info -->
    <section class="bg-gradient-to-r from-[#f04e00] to-[#ff7a3d] py-16 pb-8">
      <div class="container mx-auto px-4">
        <div class="text-center text-white max-w-4xl mx-auto">
          
          <!-- Breadcrumbs -->
          <nav class="text-sm mb-8">
            {safeSeo.breadcrumbs && safeSeo.breadcrumbs.map((breadcrumb, index) => (
              <span key={index}>
                {index > 0 && <span class="mx-2 text-white/60">•</span>}
                {index === safeSeo.breadcrumbs.length - 1 ? (
                  <span class="text-white font-medium">{breadcrumb.name}</span>
                ) : (
                  <a href={breadcrumb.url} class="text-white/80 hover:text-white transition-colors">
                    {breadcrumb.name}
                  </a>
                )}
              </span>
            ))}
          </nav>

          <div class="flex items-center justify-center gap-4 mb-6">
            <i class={`fas ${safeCategoryData.icon} text-5xl`}></i>
            <h1 class="text-4xl md:text-5xl font-bold">
              {safeCategoryData.title}
            </h1>
          </div>
          
          <p class="text-xl max-w-3xl mx-auto text-white/90">
            {safeCategoryData.description}
          </p>
          
          <!-- Category Stats -->
          <div class="mt-10">
            <div class="text-3xl font-bold text-white mb-2">{safeArticles.length}</div>
            <div class="text-sm text-white/80">{text.articles}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <main class="py-12 bg-white">
      <div class="container mx-auto px-4">

        {/* Si hay artículos */}
        {safeArticles.length > 0 ? (
          <div>
            {/* Featured Article con Magazine Style (solo si hay más de 1) */}
            {mostPopularArticle && safeArticles.length > 1 && (
              <article class="mb-16 max-w-6xl mx-auto">
                <!-- Article header - Full Width -->
                <header class="mb-8">
                  <!-- Author info -->
                  <div class="flex items-center gap-4 mb-6">
                    <img 
                      src={mostPopularArticle.author.avatar} 
                      alt={mostPopularArticle.author.name}
                      class="w-12 h-12 rounded-full"
                    />
                    <div>
                      <div class="text-sm text-gray-600">
                        <span class="font-medium text-gray-900">{text.author} {mostPopularArticle.author.name}</span>
                        <span class="mx-2">•</span>
                        <span>{formatDate(mostPopularArticle.publishedAt)}</span>
                        <span class="mx-2">•</span>
                        <span>
                          <i class="far fa-eye mr-1"></i>
                          {mostPopularArticle.views.toLocaleString()} {text.views}
                        </span>
                        <span class="mx-2">•</span>
                        <span>
                          <i class="far fa-clock mr-1"></i>
                          {mostPopularArticle.readTime}
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- Title and excerpt - Full Width -->
                  <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">
                    {mostPopularArticle.title}
                  </h2>
                  
                  <p class="text-xl text-gray-700 mb-6 leading-relaxed font-medium">
                    {mostPopularArticle.excerpt}
                  </p>
                </header>

                <!-- Magazine-style content with floating image -->
                <div class="editorial-content">
                  <div id="article-preview">
                    <!-- Content with floating image -->
                    <div class="relative">
                      <!-- Floating image with elegant overlay -->
                      <figure class="float-left mr-8 mb-6 w-96 group">
                        <div class="aspect-[4/3] relative overflow-hidden rounded-xl shadow-lg">
                          <img 
                            src={mostPopularArticle.featuredImage} 
                            alt={mostPopularArticle.title}
                            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                          />
                          <!-- Elegant overlay button -->
                          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="absolute bottom-4 left-4 right-4">
                              <a 
                                href={mostPopularArticle.url}
                                class="block w-full bg-white/95 backdrop-blur-sm text-gray-900 text-center py-2.5 px-3 rounded-lg font-medium hover:bg-white transition-all duration-300 text-sm"
                              >
                                {text.readFull}
                              </a>
                            </div>
                          </div>
                        </div>
                      </figure>

                      <!-- Justified text that wraps around the image -->
                      <div class="text-gray-700 leading-7 text-base magazine-text">
                        {mostPopularArticle.content && extractParagraphs(mostPopularArticle.content, 4).map((paragraph, index) => (
                          <p class="mb-5 text-justify hyphens-auto" key={index} set:html={paragraph} />
                        ))}
                      </div>
                      
                      <!-- Clear float for button -->
                      <div class="clear-both mt-6">
                        <a 
                          href={mostPopularArticle.url}
                          class="inline-flex items-center gap-2 text-[#f04e00] hover:text-[#d94400] font-medium text-sm transition-all duration-200 group border-b border-transparent hover:border-[#f04e00]"
                        >
                          <span>{text.readFull}</span>
                          <i class="fas fa-arrow-right transition-all duration-200 group-hover:translate-x-1"></i>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </article>
            )}

            {/* Grid de artículos adicionales o único artículo */}
            {(gridArticles.length > 0 || (safeArticles.length === 1 && mostPopularArticle)) && (
              <section class="max-w-6xl mx-auto">
                {safeArticles.length > 1 && (
                  <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">
                    {text.moreArticles} {safeCategoryData.title}
                  </h2>
                )}
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                  {(gridArticles.length > 0 ? gridArticles : [mostPopularArticle]).map((article, index) => (
                    <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden group" key={article.id}>
                      <a href={article.url} class="block">
                        <!-- Image -->
                        <div class="aspect-[16/10] relative overflow-hidden">
                          <img 
                            src={article.featuredImage} 
                            alt={article.title}
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          />
                          <div class="absolute top-3 right-3 bg-black/70 text-white px-3 py-1 rounded-full text-xs font-medium">
                            <i class="far fa-clock mr-1"></i>
                            {article.readTime}
                          </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6">
                          <h3 class="text-lg font-bold text-gray-900 mb-3 line-clamp-2 group-hover:text-[#f04e00] transition-colors leading-tight">
                            {article.title}
                          </h3>
                          
                          {article.subtitle && (
                            <h4 class="text-sm text-gray-600 mb-3 font-medium line-clamp-1">
                              {article.subtitle}
                            </h4>
                          )}
                          
                          <p class="text-gray-600 mb-4 line-clamp-3 text-sm leading-relaxed">
                            {article.excerpt}
                          </p>
                          
                          <!-- Meta -->
                          <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                            <div class="flex items-center gap-2">
                              <img 
                                src={article.author.avatar} 
                                alt={article.author.name}
                                class="w-6 h-6 rounded-full"
                              />
                              <span class="truncate font-medium">{article.author.name}</span>
                            </div>
                            <span class="flex items-center gap-1">
                              <i class="far fa-eye"></i>
                              {article.views.toLocaleString()}
                            </span>
                          </div>
                          
                          <!-- Read more link -->
                          <div class="inline-flex items-center gap-2 text-[#f04e00] font-medium text-sm group-hover:gap-3 transition-all">
                            <span>{text.readMore}</span>
                            <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                          </div>
                        </div>
                      </a>
                    </article>
                  ))}
                </div>
              </section>
            )}
          </div>
        ) : (
          /* Estado vacío */
          <div class="text-center py-16 max-w-2xl mx-auto">
            <div class="text-8xl mb-6">📝</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">
              {text.noArticles}
            </h3>
            <p class="text-gray-600 mb-8 text-lg">
              {text.noArticlesDesc}
            </p>
            <a 
              href={currentRoutes.articlesBase}
              class="inline-flex items-center gap-2 bg-[#f04e00] text-white px-6 py-3 rounded-lg font-medium hover:bg-[#d94400] transition-colors"
            >
              <i class="fas fa-arrow-left"></i>
              {text.backToArticles}
            </a>
          </div>
        )}

      </div>
    </main>

  </div>
</Layout>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Magazine-style text formatting */
  .magazine-text {
    text-align: justify;
    hyphens: auto;
    -webkit-hyphens: auto;
    -moz-hyphens: auto;
    -ms-hyphens: auto;
  }

  /* Float behavior for magazine layout */
  .magazine-text p:first-child,
  .magazine-text p:nth-child(2) {
    text-indent: 0;
  }

  .magazine-text p:not(:first-child):not(:nth-child(2)) {
    text-indent: 1.5em;
  }

  /* Better floating image behavior */
  figure.float-left {
    shape-outside: margin-box;
    margin-bottom: 1.5rem;
  }

  /* Better responsive behavior */
  @media (max-width: 1024px) {
    figure.float-left {
      width: 320px !important;
    }
  }

  @media (max-width: 768px) {
    figure.float-left {
      float: none !important;
      width: 100% !important;
      margin-right: 0 !important;
      margin-bottom: 2rem;
    }
    
    .magazine-text p {
      text-indent: 0 !important;
    }
  }

  /* Smooth transitions */
  .group:hover .group-hover\:scale-105 {
    transform: scale(1.05);
  }
  
  .group:hover .group-hover\:text-[#f04e00] {
    color: #f04e00;
  }
  
  .group:hover .group-hover\:gap-3 {
    gap: 0.75rem;
  }

  .group:hover .group-hover\:translate-x-1 {
    transform: translateX(0.25rem);
  }
</style>