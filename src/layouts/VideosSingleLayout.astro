---
// src/layouts/VideosSingleLayout.astro - Layout para video individual con validación defensiva
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';
import VideoGallery from '../components/VideoGallery.astro';
import AreaAdvisors from '../components/AreaAdvisors.astro';

// ===================================================================
// FUNCIONES HELPER PARA VALIDACIÓN DEFENSIVA
// ===================================================================

function safeGet(obj, path, defaultValue = null) {
  try {
    return path.split('.').reduce((current, key) => current && current[key], obj) || defaultValue;
  } catch (error) {
    console.warn('safeGet error:', error, 'path:', path);
    return defaultValue;
  }
}

function safeArray(arr, defaultValue = []) {
  return Array.isArray(arr) ? arr : defaultValue;
}

function safeString(str, defaultValue = '') {
  return typeof str === 'string' ? str : defaultValue;
}

function safeObject(obj, defaultValue = {}) {
  return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : defaultValue;
}

function safeNumber(num, defaultValue = 0) {
  return typeof num === 'number' && !isNaN(num) ? num : defaultValue;
}

// ===================================================================
// EXTRACCIÓN DE DATOS DEL PROP CON VALIDACIÓN DEFENSIVA
// ===================================================================

const { data } = Astro.props;
const language = safeString(data?.language, 'es');
const categorySlug = safeString(data?.categorySlug || data?.category, 'casa-famosos');
const videoSlug = safeString(data?.videoSlug || data?.slug, 'video-sin-titulo');

// ===================================================================
// PROCESAMIENTO DEFENSIVO DE DATOS
// ===================================================================

let videoData = safeObject(data);

// Crear datos seguros del video
const safeVideoData = {
  language: language,
  slug: safeString(videoData.slug || videoSlug, 'video-sin-titulo'),
  categorySlug: safeString(videoData.categorySlug || categorySlug, 'casa-famosos'),
  title: safeString(videoData.title, 
    language === 'es' ? 'Casa de Celebrity en Santo Domingo' :
    language === 'en' ? 'Celebrity House in Santo Domingo' :
    'Maison de Célébrité à Santo Domingo'),
  subtitle: safeString(videoData.subtitle,
    language === 'es' ? 'Tour exclusivo por una espectacular propiedad' :
    language === 'en' ? 'Exclusive tour of a spectacular property' :
    'Visite exclusive d\'une propriété spectaculaire'),
  description: safeString(videoData.description,
    language === 'es' ? `Acompáñanos en este recorrido exclusivo por una impresionante propiedad ubicada en una de las mejores zonas de Santo Domingo.
    
Esta propiedad combina elegancia moderna con toques tropicales, creando el hogar perfecto.

Características destacadas:
• Múltiples habitaciones con baño privado
• Cocina gourmet con isla central
• Sala de entretenimiento
• Área de piscina
• Jardín tropical
• Espacios de entretenimiento

La decoración refleja un estilo sofisticado pero acogedor, con arte local y mobiliario de calidad.` :
    language === 'en' ? `Join us on this exclusive tour of an impressive property located in one of the best areas of Santo Domingo.

This property combines modern elegance with tropical touches, creating the perfect home.

Featured characteristics:
• Multiple bedrooms with private bathroom
• Gourmet kitchen with central island
• Entertainment room
• Pool area
• Tropical garden
• Entertainment spaces

The decoration reflects a sophisticated but cozy style, with local art and quality furniture.` :
    `Rejoignez-nous dans cette visite exclusive d'une propriété impressionnante située dans l'un des meilleurs quartiers de Santo Domingo.

Cette propriété combine élégance moderne et touches tropicales, créant la maison parfaite.

Caractéristiques en vedette:
• Plusieurs chambres avec salle de bain privée
• Cuisine gastronomique avec îlot central
• Salle de divertissement
• Zone piscine
• Jardin tropical
• Espaces de divertissement

La décoration reflète un style sophistiqué mais chaleureux, avec de l'art local et du mobilier de qualité.`),
  videoId: safeString(videoData.videoId, 'dQw4w9WgXcQ'),
  duration: safeString(videoData.duration, '15:00'),
  views: safeString(videoData.views, '100,000'),
  publishedAt: safeString(videoData.publishedAt, new Date().toISOString()),
  category: safeString(videoData.category,
    language === 'es' ? 'Casa de Famosos' :
    language === 'en' ? 'Celebrity Homes' :
    'Maisons des Célébrités'),
  location: safeString(videoData.location, 'Santo Domingo'),
  propertyType: safeString(videoData.propertyType,
    language === 'es' ? 'Villa de Lujo' :
    language === 'en' ? 'Luxury Villa' :
    'Villa de Luxe'),
  thumbnail: safeString(videoData.thumbnail || videoData.featuredImage, 
    'https://images.unsplash.com/photo-1613977257363-707ba9348227?w=1200&h=800&fit=crop')
};

// Procesar galería de fotos de forma defensiva
const rawPhotoGallery = safeArray(videoData.photoGallery);
const safePhotoGallery = rawPhotoGallery.length > 0 ? rawPhotoGallery.map((photo, index) => ({
  url: safeString(photo.url || photo.image, 'https://images.unsplash.com/photo-1613977257363-707ba9348227?w=1200&h=800&fit=crop'),
  caption: safeString(photo.caption || photo.title,
    language === 'es' ? `Imagen ${index + 1} de la propiedad` :
    language === 'en' ? `Property image ${index + 1}` :
    `Image ${index + 1} de la propriété`)
})) : [
  {
    url: 'https://images.unsplash.com/photo-1613977257363-707ba9348227?w=1200&h=800&fit=crop',
    caption: language === 'es' ? 'Fachada principal' : language === 'en' ? 'Main facade' : 'Façade principale'
  },
  {
    url: 'https://images.unsplash.com/photo-1600607687644-aac4c3eac7f4?w=1200&h=800&fit=crop',
    caption: language === 'es' ? 'Sala principal' : language === 'en' ? 'Main living room' : 'Salon principal'
  },
  {
    url: 'https://images.unsplash.com/photo-1600607687920-4e2a09cf159d?w=1200&h=800&fit=crop',
    caption: language === 'es' ? 'Cocina gourmet' : language === 'en' ? 'Gourmet kitchen' : 'Cuisine gastronomique'
  }
];

// Procesar propiedades similares de forma defensiva
const rawSimilarProperties = safeArray(videoData.similarProperties);
const safeSimilarProperties = rawSimilarProperties.map((property, index) => ({
  id: safeString(property.id, `property-${index}`),
  slug: safeString(property.slug, `propiedad-${index}`),
  titulo: safeString(property.titulo || property.title, 'Propiedad sin título'),
  precio: safeString(property.precio || property.price, '$0'),
  imagen: safeString(property.imagen || property.image || property.featuredImage, 
    'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800&h=600&fit=crop'),
  sector: safeString(property.sector || property.location, 'Santo Domingo'),
  habitaciones: safeNumber(property.habitaciones || property.bedrooms, 3),
  banos: safeNumber(property.banos || property.bathrooms, 3),
  metros: safeNumber(property.metros || property.area, 200),
  tipo: safeString(property.tipo || property.type, 'Villa'),
  destacado: Boolean(property.destacado || property.featured),
  nuevo: Boolean(property.nuevo || property.isNew)
}));

// Procesar videos relacionados de forma defensiva
const rawRelatedVideos = safeArray(videoData.relatedVideos);
const safeRelatedVideos = rawRelatedVideos.map((video, index) => ({
  id: safeString(video.id, `video-${index}`),
  title: safeString(video.title, 'Video sin título'),
  thumbnail: safeString(video.thumbnail || video.image, 
    'https://images.unsplash.com/photo-1600607687644-aac4c3eac7f4?w=800&h=450&fit=crop'),
  duration: safeString(video.duration, '10:00'),
  views: safeString(video.views, '1K'),
  category: safeString(video.category, 'videos'),
  videoId: safeString(video.videoId, 'dQw4w9WgXcQ'),
  slug: safeString(video.slug, `video-${index}`),
  url: safeString(video.url, '#')
}));

// Procesar asesores del área de forma defensiva
const rawAreaAdvisors = safeArray(videoData.areaAdvisors);
const safeAreaAdvisors = rawAreaAdvisors.map((advisor, index) => ({
  id: safeString(advisor.id, `advisor-${index}`),
  slug: safeString(advisor.slug, `asesor-${index}`),
  name: safeString(advisor.name, 'Asesor Inmobiliario'),
  title: safeString(advisor.title,
    language === 'es' ? 'Especialista Inmobiliario' :
    language === 'en' ? 'Real Estate Specialist' :
    'Spécialiste Immobilier'),
  avatar: safeString(advisor.avatar, 'https://i.pravatar.cc/150?img=1'),
  specialties: safeArray(advisor.specialties, ['Santo Domingo']),
  areas: safeArray(advisor.areas, [language === 'es' ? 'Propiedades' : 'Properties']),
  languages: safeArray(advisor.languages, [language === 'es' ? 'Español' : 'Spanish']),
  phone: safeString(advisor.phone, '+1 809 555 0100'),
  whatsapp: safeString(advisor.whatsapp, '18095550100'),
  rating: safeNumber(advisor.rating, 4.5),
  reviewCount: safeNumber(advisor.reviewCount, 10)
}));

// SEO seguro
const safeSeo = {
  title: safeString(safeGet(videoData, 'seo.title'), `${safeVideoData.title} - Video CLIC`),
  description: safeString(safeGet(videoData, 'seo.description'), safeVideoData.subtitle)
};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    breadcrumbVideos: 'Videos',
    description: 'Descripción',
    photoGalleryTitle: 'Galería de Fotos Exclusivas',
    similarPropertiesTitle: 'Propiedades similares disponibles',
    similarPropertiesSubtitle: 'Encuentra tu hogar ideal en las mejores zonas de Santo Domingo',
    relatedVideosTitle: 'Videos que te pueden interesar',
    relatedVideosSubtitle: 'Continúa explorando propiedades exclusivas',
    advisorsTitle: 'Asesores especializados en propiedades de lujo',
    ctaTitle: '¿Te gustó esta propiedad?',
    ctaSubtitle: 'Podemos mostrarte propiedades similares disponibles en las mejores zonas',
    ctaButton1: 'Agenda una visita',
    ctaButton2: 'Ver propiedades en',
    views: 'vistas',
    duration: 'Duración',
    published: 'Publicado el',
    location: 'Ubicación',
    propertyType: 'Tipo de propiedad'
  },
  en: {
    breadcrumbVideos: 'Videos',
    description: 'Description',
    photoGalleryTitle: 'Exclusive Photo Gallery',
    similarPropertiesTitle: 'Similar properties available',
    similarPropertiesSubtitle: 'Find your ideal home in the best areas of Santo Domingo',
    relatedVideosTitle: 'Videos that might interest you',
    relatedVideosSubtitle: 'Continue exploring exclusive properties',
    advisorsTitle: 'Advisors specialized in luxury properties',
    ctaTitle: 'Did you like this property?',
    ctaSubtitle: 'We can show you similar properties available in the best areas',
    ctaButton1: 'Schedule a visit',
    ctaButton2: 'View properties in',
    views: 'views',
    duration: 'Duration',
    published: 'Published on',
    location: 'Location',
    propertyType: 'Property type'
  },
  fr: {
    breadcrumbVideos: 'Vidéos',
    description: 'Description',
    photoGalleryTitle: 'Galerie de Photos Exclusives',
    similarPropertiesTitle: 'Propriétés similaires disponibles',
    similarPropertiesSubtitle: 'Trouvez votre maison idéale dans les meilleures zones de Santo Domingo',
    relatedVideosTitle: 'Vidéos qui pourraient vous intéresser',
    relatedVideosSubtitle: 'Continuez à explorer des propriétés exclusives',
    advisorsTitle: 'Conseillers spécialisés en propriétés de luxe',
    ctaTitle: 'Cette propriété vous a plu?',
    ctaSubtitle: 'Nous pouvons vous montrer des propriétés similaires disponibles dans les meilleures zones',
    ctaButton1: 'Planifier une visite',
    ctaButton2: 'Voir les propriétés à',
    views: 'vues',
    duration: 'Durée',
    published: 'Publié le',
    location: 'Emplacement',
    propertyType: 'Type de propriété'
  }
};

const text = TEXTS[language] || TEXTS.es;

// URLs según idioma
const routes = {
  es: {
    contact: '/contacto',
    properties: '/comprar',
    videosBase: '/videos'
  },
  en: {
    contact: '/en/contact',
    properties: '/en/buy',
    videosBase: '/en/videos'
  },
  fr: {
    contact: '/fr/contact',
    properties: '/fr/acheter',
    videosBase: '/fr/videos'
  }
};

const currentRoutes = routes[language] || routes.es;

// Función para formatear fecha
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
    }
    
    const months = {
      es: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
      en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      fr: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre']
    };
    
    const monthNames = months[language] || months.es;
    return `${date.getDate()} de ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
  } catch (error) {
    return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
  }
}

console.log('✅ VideosSingleLayout preparado con validación defensiva:', {
  language,
  categorySlug,
  videoSlug,
  title: safeVideoData.title,
  similarPropertiesCount: safeSimilarProperties.length,
  relatedVideosCount: safeRelatedVideos.length,
  photoGalleryCount: safePhotoGallery.length,
  advisorsCount: safeAreaAdvisors.length
});
---

<Layout 
  title={safeSeo.title}
  description={safeSeo.description}
  language={language}
>
  <!-- Breadcrumbs -->
  <section class="bg-gray-50 py-4">
    <div class="container mx-auto px-4">
      <nav class="text-sm text-gray-600">
        <a href={currentRoutes.videosBase} class="hover:text-[#f04e00]">{text.breadcrumbVideos}</a>
        <span class="mx-2">/</span>
        <a href={`${currentRoutes.videosBase}/${safeVideoData.categorySlug}`} class="hover:text-[#f04e00]">
          {safeVideoData.category}
        </a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{safeVideoData.title}</span>
      </nav>
    </div>
  </section>

  <!-- Video Section -->
  <section class="py-8">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <!-- Title and metadata -->
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">
          {safeVideoData.title}
        </h1>
        <p class="text-xl text-gray-600 mb-6">{safeVideoData.subtitle}</p>
        
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-8">
          <span class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            {safeVideoData.views} {text.views}
          </span>
          <span class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            {formatDate(safeVideoData.publishedAt)}
          </span>
          <span class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            {safeVideoData.location}
          </span>
          <span class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            {safeVideoData.propertyType}
          </span>
        </div>

        <!-- Video Embed -->
        <div class="aspect-video bg-black rounded-xl overflow-hidden shadow-2xl mb-8">
          <iframe 
            src={`https://www.youtube.com/embed/${safeVideoData.videoId}`}
            title={safeVideoData.title}
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="w-full h-full"
          ></iframe>
        </div>

        <!-- Description -->
        <div class="prose prose-lg max-w-none mb-12">
          <h2 class="text-2xl font-bold mb-4">{text.description}</h2>
          <div class="whitespace-pre-line text-gray-700">{safeVideoData.description}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Photo Gallery -->
  {safeArray(safePhotoGallery).length > 0 && (
    <section class="py-12 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">
          {text.photoGalleryTitle}
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {safeArray(safePhotoGallery).map((photo, index) => (
            <div class="group cursor-pointer" key={index}>
              <div class="aspect-[4/3] overflow-hidden rounded-lg shadow-md group-hover:shadow-xl transition-shadow">
                <img 
                  src={photo.url} 
                  alt={photo.caption}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </div>
              <p class="mt-2 text-sm text-gray-600 text-center">{photo.caption}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Similar Properties -->
  {safeArray(safeSimilarProperties).length > 0 && (
    <PropertyCarousel 
      title={text.similarPropertiesTitle}
      subtitle={text.similarPropertiesSubtitle}
      properties={safeSimilarProperties}
      viewAllLink={`${currentRoutes.properties}/villa/santo-domingo?zona=norte`}
      language={language}
    />
  )}

  <!-- Related Videos -->
  {safeArray(safeRelatedVideos).length > 0 && (
    <VideoGallery 
      videos={safeRelatedVideos}
      title={text.relatedVideosTitle}
      subtitle={text.relatedVideosSubtitle}
      language={language}
    />
  )}

  <!-- Area Advisors -->
  {safeArray(safeAreaAdvisors).length > 0 && (
    <AreaAdvisors 
      advisors={safeAreaAdvisors}
      title={text.advisorsTitle}
      location="Santo Domingo Norte"
      language={language}
    />
  )}

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-r from-[#f04e00] to-[#ff7a3d]">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
        {text.ctaTitle}
      </h2>
      <p class="text-xl text-white/90 mb-8 max-w-2xl mx-auto">
        {text.ctaSubtitle}
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a 
          href={currentRoutes.contact} 
          class="inline-block px-8 py-3 bg-white text-[#f04e00] rounded-lg hover:bg-gray-100 transition-colors font-medium"
        >
          {text.ctaButton1}
        </a>
        <a 
          href={`${currentRoutes.properties}/villa/${safeVideoData.location.toLowerCase().replace(/,.*/, '').replace(/\s+/g, '-')}`}
          class="inline-block px-8 py-3 bg-white/20 text-white border border-white rounded-lg hover:bg-white/30 transition-colors font-medium"
        >
          {text.ctaButton2} {safeVideoData.location.split(',')[0]}
        </a>
      </div>
    </div>
  </section>
</Layout>