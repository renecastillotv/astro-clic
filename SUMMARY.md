# CLIC Inmobiliaria - Arquitectura Completa del Sistema

## √çndice
1. [Visi√≥n General](#visi√≥n-general)
2. [Arquitectura de Base de Datos](#arquitectura-de-base-de-datos)
3. [Sistema de Edge Functions](#sistema-de-edge-functions)
4. [Sistema Multiidioma](#sistema-multiidioma)
5. [Tipos de P√°ginas y Layouts](#tipos-de-p√°ginas-y-layouts)
6. [Flujo de Datos](#flujo-de-datos)
7. [Sistema de Tags y B√∫squeda](#sistema-de-tags-y-b√∫squeda)
8. [Gu√≠a para Desarrollar un CRM](#gu√≠a-para-desarrollar-un-crm)

---

## Visi√≥n General

**CLIC Inmobiliaria** es una plataforma inmobiliaria multi-pa√≠s con arquitectura serverless construida con:

- **Frontend**: Astro.js (SSR/SSG)
- **Backend**: Supabase Edge Functions (Deno)
- **Base de Datos**: PostgreSQL (Supabase)
- **Idiomas Soportados**: Espa√±ol (es), Ingl√©s (en), Franc√©s (fr)
- **Pa√≠ses Activos**: Rep√∫blica Dominicana (DOM), Panam√° (PAN), M√©xico (MEX)

### Caracter√≠sticas Principales

- üåç **Multi-pa√≠s y multi-dominio**: Cada pa√≠s tiene su propio dominio o subdominio
- üåê **Multiidioma completo**: Contenido traducido en 3 idiomas
- üè¢ **Sistema de Tags jer√°rquico**: Categorizaci√≥n avanzada por pa√≠s, ciudad, sector, tipo de propiedad
- üìä **SEO Avanzado**: Schema.org, hreflang, Open Graph autom√°tico
- üîÑ **Data real/fake configurable**: Campo `real_data` controla si mostrar n√∫meros reales o ficticios
- üìù **CMS completo**: Art√≠culos, videos, testimonios, asesores
- üè° **Propiedades con m√∫ltiples precios**: Venta, alquiler, temporal, amueblado
- ‚≠ê **Favoritos compartidos**: Sistema colaborativo de listas favoritas
- üìû **Contact submissions con tracking**: UTM, fbclid, gclid completo

---

## Arquitectura de Base de Datos

### Tablas Principales del Sistema

#### 1. `countries` - Pa√≠ses y Configuraci√≥n
**Prop√≥sito**: Gesti√≥n multi-pa√≠s con configuraci√≥n personalizada por dominio.

**Campos Importantes**:
```typescript
{
  id: number                    // ID √∫nico del pa√≠s
  name: string                  // Nombre del pa√≠s (ej: "Rep√∫blica Dominicana")
  code: string                  // C√≥digo ISO (ej: "DOM", "PAN", "MEX")
  country_tag_id: number        // FK ‚Üí tags (tag de pa√≠s)
  subdomain: string             // Subdominio (ej: "pa", "mx")
  custom_domain: string         // Dominio personalizado (ej: "clicinmobiliaria.com")
  currency: string              // Moneda principal ("DOP", "USD", "MXN")
  timezone: string              // Zona horaria
  real_data: boolean            // ‚ö†Ô∏è IMPORTANTE: true = datos reales, false = datos ficticios
  active: boolean               // Pa√≠s activo o no
  config: JSONB                 // Configuraci√≥n completa del pa√≠s
}
```

**Campo `config` (JSONB)**:
```json
{
  "contact": { "phone": "", "email": "", "address": "" },
  "social": {
    "company": { "facebook": "", "instagram": "", "youtube": "" }
  },
  "legal": {
    "company_name": "CLIC Inmobiliaria",
    "company_full_name": "CLIC DOM SRL",
    "logo_url": ""
  },
  "features": {
    "header": {
      "sections": {
        "comprar": { "urls": { "es": "/comprar", "en": "/buy", "fr": "/acheter" } }
      }
    }
  },
  "footer_links": {
    "properties_by_zone": [
      { "label": { "es": "...", "en": "...", "fr": "..." }, "urls": { ... } }
    ]
  },
  "translations": {
    "es": { "search_placeholder": "Buscar propiedades..." },
    "en": { "search_placeholder": "Search properties..." }
  }
}
```

**Relaciones**:
- `country_tag_id` ‚Üí `tags.id` (tag de categor√≠a "pais")

---

#### 2. `tags` - Sistema de Etiquetas Jer√°rquico
**Prop√≥sito**: Sistema universal de categorizaci√≥n para propiedades, contenido y ubicaciones.

**Campos**:
```typescript
{
  id: number                    // ID √∫nico
  slug: string                  // Slug en espa√±ol (ej: "punta-cana")
  slug_en: string               // Slug en ingl√©s (ej: "punta-cana")
  slug_fr: string               // Slug en franc√©s (ej: "punta-cana")
  category: string              // Categor√≠a del tag (ver abajo)
  display_name: string          // Nombre display espa√±ol
  display_name_en: string       // Nombre display ingl√©s
  display_name_fr: string       // Nombre display franc√©s
  parent_id: number             // FK ‚Üí tags.id (jerarqu√≠a)
  active: boolean               // Tag activo
  priority: number              // Orden de visualizaci√≥n
}
```

**Categor√≠as de Tags (`category`)**:
- `pais` - Pa√≠s (ej: Rep√∫blica Dominicana, Panam√°)
- `provincia` - Provincia/Estado (ej: Santo Domingo, La Altagracia)
- `ciudad` - Ciudad (ej: Punta Cana, Santiago)
- `sector` - Sector/Vecindario (ej: B√°varo, Naco)
- `categoria` - Tipo de propiedad (ej: Apartamento, Villa, Casa)
- `caracteristica` - Caracter√≠sticas (ej: Piscina, Vista al mar)
- `proyecto` - Proyectos (ej: Torre en construcci√≥n)
- `asesor` - Agentes inmobiliarios
- `custom` - Tags personalizados

**Jerarqu√≠a de Tags**:
```
Pa√≠s (pais)
  ‚îî‚îÄ Provincia (provincia)
      ‚îî‚îÄ Ciudad (ciudad)
          ‚îî‚îÄ Sector (sector)

Ejemplo:
Rep√∫blica Dominicana (pais)
  ‚îî‚îÄ La Altagracia (provincia)
      ‚îî‚îÄ Punta Cana (ciudad)
          ‚îî‚îÄ B√°varo (sector)
```

**Relaciones**:
- `parent_id` ‚Üí `tags.id` (auto-referencia para jerarqu√≠a)
- Usados en `property_tags`, `content_tags`, `popular_items`

---

#### 3. `properties` - Propiedades Inmobiliarias
**Prop√≥sito**: Tabla central de todas las propiedades en venta/alquiler.

**Campos Clave**:
```typescript
{
  id: number                              // ID √∫nico
  code: string                            // C√≥digo interno (ej: "CLIC-001")
  name: string                            // Nombre de la propiedad
  description: text                       // Descripci√≥n completa
  slug_url: string                        // URL slug √∫nica

  // PRECIOS Y OPERACIONES - Sistema Multi-precio
  sale_price: decimal                     // Precio de venta
  sale_currency: string                   // Moneda de venta ("USD", "DOP")
  rental_price: decimal                   // Precio alquiler mensual
  rental_currency: string
  temp_rental_price: decimal              // Alquiler temporal (diario/semanal)
  temp_rental_currency: string
  furnished_rental_price: decimal         // Alquiler amueblado
  furnished_rental_currency: string
  furnished_sale_price: decimal           // Venta amueblada
  furnished_sale_currency: string

  // CARACTER√çSTICAS F√çSICAS
  bedrooms: integer                       // Habitaciones
  bathrooms: decimal                      // Ba√±os (permite .5 para medio ba√±o)
  parking_spots: integer                  // Estacionamientos
  built_area: decimal                     // √Årea construida (m¬≤)
  land_area: decimal                      // √Årea de terreno (m¬≤)

  // UBICACI√ìN Y COORDENADAS
  exact_coordinates: point                // Coordenadas exactas (PostgreSQL POINT)
  show_exact_location: boolean            // Mostrar ubicaci√≥n exacta o aproximada

  // IM√ÅGENES
  main_image_url: string                  // Imagen principal
  gallery_images_url: text                // URLs separadas por comas

  // ESTADO Y VISIBILIDAD
  property_status: string                 // "Publicada", "Vendida", "Retirada", "Borrador"
  availability: integer                   // 1 = disponible, 0 = no disponible

  // PROYECTO
  is_project: boolean                     // ¬øEs un proyecto?
  delivery_date: date                     // Fecha de entrega (para proyectos)
  project_detail_id: number               // FK ‚Üí project_details

  // AGENTE
  agent_id: number                        // FK ‚Üí agents (asesor principal)

  // AUDITOR√çA
  created_at: timestamptz
  updated_at: timestamptz
  views: integer                          // Contador de vistas
}
```

**Relaciones Importantes**:
```sql
properties
  ‚îú‚îÄ property_categories (many-to-many) ‚Üí property_categories
  ‚îú‚îÄ cities (FK) ‚Üí cities
  ‚îú‚îÄ sectors (FK) ‚Üí sectors
  ‚îú‚îÄ agents (FK) ‚Üí agents
  ‚îú‚îÄ property_images (1-to-many) ‚Üí property_images
  ‚îú‚îÄ property_amenities (1-to-many) ‚Üí property_amenities
  ‚îî‚îÄ property_tags (many-to-many) ‚Üí tags
```

**Consulta SELECT t√≠pica** (usado en edge function):
```typescript
const selectQuery = `
  id, code, name, description, agent_id, slug_url,
  sale_price, sale_currency, rental_price, rental_currency,
  temp_rental_price, temp_rental_currency,
  furnished_rental_price, furnished_rental_currency,
  bedrooms, bathrooms, parking_spots, built_area, land_area,
  main_image_url, gallery_images_url, property_status, is_project,
  delivery_date, project_detail_id,
  exact_coordinates, show_exact_location,
  property_categories(name, description),
  cities(name, coordinates, provinces(name, coordinates)),
  sectors(name, coordinates),
  property_images(url, title, description, is_main, sort_order),
  property_amenities(amenity_id, value, amenities(name, icon, category))
`;
```

---

#### 4. `property_tags` - Relaci√≥n Propiedades-Tags
**Prop√≥sito**: Tabla pivote many-to-many entre propiedades y tags.

```typescript
{
  id: number                    // ID √∫nico
  property_id: number           // FK ‚Üí properties.id
  tag_id: number                // FK ‚Üí tags.id
  created_at: timestamptz
}
```

**Uso en B√∫squeda**:
```sql
-- Buscar propiedades con tags espec√≠ficos
SELECT p.*
FROM properties p
JOIN property_tags pt ON pt.property_id = p.id
WHERE pt.tag_id IN (1, 5, 10)  -- IDs de tags
  AND p.availability = 1
  AND p.property_status = 'Publicada'
```

---

#### 5. `cities`, `provinces`, `sectors` - Ubicaciones
**Prop√≥sito**: Sistema jer√°rquico de ubicaciones geogr√°ficas.

**Tabla `provinces`**:
```typescript
{
  id: number
  name: string                  // Nombre de la provincia
  coordinates: point            // Coordenadas centrales
  country_id: number            // FK ‚Üí countries.id
}
```

**Tabla `cities`**:
```typescript
{
  id: number
  name: string
  coordinates: point
  province_id: number           // FK ‚Üí provinces.id
}
```

**Tabla `sectors`**:
```typescript
{
  id: number
  name: string
  coordinates: point
  city_id: number               // FK ‚Üí cities.id
}
```

**Jerarqu√≠a**:
```
Country ‚Üí Province ‚Üí City ‚Üí Sector
   ‚Üì         ‚Üì         ‚Üì       ‚Üì
  DOM   ‚Üí La Altagracia ‚Üí Punta Cana ‚Üí B√°varo
```

---

#### 6. `agents` - Asesores Inmobiliarios
**Prop√≥sito**: Gesti√≥n de agentes de bienes ra√≠ces.

```typescript
{
  id: number
  first_name: string
  last_name: string
  email: string
  phone: string
  whatsapp: string
  bio: text
  photo_url: string
  specialties: string[]         // Array de especialidades
  languages: string[]           // Array de idiomas
  active: boolean
  slug: string                  // Slug para URL

  // Estad√≠sticas (controladas por real_data)
  total_sales: integer          // Total de ventas
  properties_sold: integer      // Propiedades vendidas
  avg_rating: decimal           // Calificaci√≥n promedio
}
```

**Relaci√≥n con `properties`**:
- Una propiedad tiene un `agent_id` (agente principal)
- Un agente puede tener m√∫ltiples propiedades

---

#### 7. `content_articles` - Art√≠culos del Blog
**Prop√≥sito**: Sistema de blog/contenido multiidioma.

```typescript
{
  id: number
  title: string                 // T√≠tulo en espa√±ol
  slug: string                  // Slug en espa√±ol
  excerpt: text                 // Extracto corto
  content: text                 // Contenido HTML completo
  featured_image: string        // Imagen destacada

  // Multiidioma
  content_en: JSONB             // { title, slug, excerpt, content }
  content_fr: JSONB
  slug_en: string
  slug_fr: string

  // Categor√≠a y Tags
  category_id: number           // FK ‚Üí content_categories.id

  // Metadatos
  author_id: number             // FK ‚Üí agents.id
  published_at: timestamptz
  updated_at: timestamptz
  views: integer
  read_time_minutes: integer
  featured: boolean
  status: string                // "published", "draft", "archived"
}
```

**Relaci√≥n con Tags**:
```sql
-- Tabla pivote
content_tags
  ‚îú‚îÄ content_id (FK ‚Üí content_articles.id)
  ‚îú‚îÄ tag_id (FK ‚Üí tags.id)
  ‚îî‚îÄ content_type: 'article' | 'video' | 'testimonial'
```

---

#### 8. `content_categories` - Categor√≠as de Contenido
**Prop√≥sito**: Categorizar art√≠culos, videos, testimonios.

```typescript
{
  id: number
  name: string                  // Nombre en espa√±ol
  slug: string
  description: text

  // Multiidioma
  name_en: string
  name_fr: string
  slug_en: string
  slug_fr: string

  // Configuraci√≥n
  content_type: string          // 'article', 'video', 'testimonial'
  active: boolean
  priority: integer             // Orden de visualizaci√≥n
}
```

---

#### 9. `content_videos` - Videos
**Prop√≥sito**: Gesti√≥n de contenido en video (YouTube, Vimeo, etc).

```typescript
{
  id: number
  title: string
  slug: string
  description: text
  video_url: string             // URL del video
  thumbnail: string             // Miniatura
  duration_seconds: integer

  // Multiidioma
  content_en: JSONB
  content_fr: JSONB

  category_id: number
  published_at: timestamptz
  views: integer
  featured: boolean
}
```

---

#### 10. `content_testimonials` - Testimonios
**Prop√≥sito**: Rese√±as y testimonios de clientes.

```typescript
{
  id: number
  client_name: string
  client_position: string       // Ej: "Propietario", "Inversionista"
  client_avatar: string
  excerpt: text                 // Testimonio corto
  full_testimonial: text        // Testimonio completo
  rating: integer               // 1-5 estrellas

  // Multiidioma
  content_en: JSONB
  content_fr: JSONB

  // Ubicaci√≥n del cliente
  client_location: string

  // Propiedad relacionada (opcional)
  property_id: number           // FK ‚Üí properties.id

  featured: boolean
  published_at: timestamptz
}
```

---

#### 11. `contact_submissions` - Env√≠os del Formulario de Contacto
**Prop√≥sito**: Almacenar todos los contactos del sitio web con tracking completo.

```typescript
{
  id: uuid                      // UUID √∫nico

  // Informaci√≥n del contacto (REQUERIDOS)
  nombre: string                // Nombre completo
  telefono: string              // Tel√©fono
  email: string                 // Email
  tipo_servicio: enum           // 'asesor' | 'vender' | 'desarrollo' | 'comprar' | 'otro'

  // Informaci√≥n adicional (OPCIONALES)
  mensaje: text                 // Mensaje del usuario
  preferencia_contacto: string  // Cu√°ndo contactar (default: 'asap')

  // Tracking de marketing
  ip_address: string
  user_agent: string
  referer: string

  // Par√°metros UTM completos
  utm_source: string            // Ej: "google", "facebook"
  utm_medium: string            // Ej: "cpc", "organic"
  utm_campaign: string          // Ej: "verano-2024"
  utm_content: string
  utm_term: string

  // Otros par√°metros de tracking
  ref_param: string             // Par√°metro ref= personalizado
  fbclid: string                // Facebook Click ID
  gclid: string                 // Google Click ID

  // Tracking data completo (JSONB)
  tracking_data: JSONB          // Objeto con todos los datos de tracking

  // Estado y workflow
  status: enum                  // 'pendiente' | 'contactado' | 'en_proceso' | 'completado' | 'descartado'

  // Timestamps
  created_at: timestamptz
  updated_at: timestamptz       // Auto-actualizado con trigger
}
```

**√çndices de Performance**:
```sql
idx_contact_submissions_email           -- B√∫squeda por email
idx_contact_submissions_telefono        -- B√∫squeda por tel√©fono
idx_contact_submissions_tipo_servicio   -- Filtro por tipo
idx_contact_submissions_status          -- Filtro por estado
idx_contact_submissions_created_at      -- Orden cronol√≥gico
idx_contact_submissions_utm_source      -- An√°lisis de fuentes
idx_contact_submissions_utm_campaign    -- An√°lisis de campa√±as
idx_contact_submissions_tracking_data   -- B√∫squeda en JSON (GIN index)
```

**Row Level Security (RLS)**:
- INSERT: Permitido para usuarios an√≥nimos (formulario p√∫blico)
- SELECT: Solo usuarios autenticados
- UPDATE: Solo usuarios autenticados

---

#### 12. `favorite_visitors` - Visitantes de Listas Compartidas
**Prop√≥sito**: Tracking de visitantes en listas de favoritos compartidas.

```typescript
{
  id: bigserial                 // ID √∫nico
  list_id: string               // ID de la lista compartida
  visitor_device_id: string     // ID √∫nico del dispositivo del visitante
  visitor_alias: string         // Alias/nombre del visitante
  joined_at: timestamptz        // Cu√°ndo se uni√≥
  last_seen: timestamptz        // √öltima actividad
}
```

**Constraint √∫nico**: `(list_id, visitor_device_id)` - Un dispositivo solo puede unirse una vez

---

#### 13. `favorite_reactions` - Reacciones a Propiedades
**Prop√≥sito**: Sistema de likes, dislikes y comentarios en listas compartidas.

```typescript
{
  id: bigserial
  list_id: string               // ID de la lista compartida
  property_id: uuid             // FK ‚Üí properties.id
  visitor_device_id: string     // ID del dispositivo que reacciona
  visitor_alias: string         // Nombre del visitante
  reaction_type: enum           // 'like' | 'dislike' | 'comment'
  comment_text: text            // Texto del comentario (si reaction_type = 'comment')
  created_at: timestamptz
}
```

**Constraint √∫nico**: `(list_id, property_id, visitor_device_id, reaction_type)`
- Un visitante solo puede dar un like por propiedad
- Un visitante solo puede dar un dislike por propiedad
- Un visitante puede dejar m√∫ltiples comentarios (sin unique constraint en comments)

**RLS**: Acceso p√∫blico (lectura/escritura permitida para todos)

---

#### 14. `popular_items` - Items Destacados por Pa√≠s
**Prop√≥sito**: Gestionar secciones de "b√∫squedas populares" o "propiedades destacadas" por pa√≠s.

```typescript
{
  id: number
  country_tag_id: number        // FK ‚Üí tags.id (tag de pa√≠s)
  category: enum                // 'categoria' | 'ciudad' | 'sector' | 'asesor' | 'proyecto' | 'custom'
  title: string                 // T√≠tulo en espa√±ol
  subtitle: string              // Subt√≠tulo en espa√±ol
  url: string                   // URL relativa
  image_url: string             // Imagen destacada

  // Multiidioma
  content_en: JSONB             // { title, subtitle, url }
  content_fr: JSONB

  // Configuraci√≥n
  active: boolean
  priority: integer             // Orden de visualizaci√≥n
  created_at: timestamptz
}
```

**Uso**: El edge function `content-backend` consulta estos items para mostrar en homepage y footers.

---

#### 15. `curated_listings` - Listados Curados
**Prop√≥sito**: Colecciones especiales de propiedades (ej: "Propiedades frente al mar", "Lujo en Punta Cana").

```typescript
{
  id: number
  title: string                 // T√≠tulo en espa√±ol
  slug: string                  // Slug para URL
  description: text
  featured_image: string

  // Multiidioma
  content_en: JSONB             // { title, slug, description }
  content_fr: JSONB

  // Tags asociados
  // Se relaciona con tags para filtrar propiedades

  active: boolean
  featured: boolean
  priority: integer
  created_at: timestamptz
}
```

**Relaci√≥n con propiedades**: Se usa el sistema de tags para filtrar propiedades que pertenecen a un curated listing.

---

## Sistema de Edge Functions

### Arquitectura de Edge Functions

Las Edge Functions est√°n organizadas en 3 sistemas principales:

1. **`content-backend`** - Sistema modular de contenido (art√≠culos, videos, testimonios, asesores, contacto, vender, favoritos)
2. **`backend`** - Sistema de propiedades (b√∫squeda, single property, carousel)
3. **`v2`** - Sistema de b√∫squeda avanzada (property-search, projects, similar-properties)

---

### Edge Function Principal: `content-backend`

**Ubicaci√≥n**: `edge/content-backend/index.ts`

**Prop√≥sito**: Router principal que maneja todas las rutas de contenido multiidioma.

#### Rutas Registradas

```typescript
const CONTENT_ROUTES = {
  // ESPA√ëOL
  'articulos': { type: 'articles', handler: handleArticles },
  'videos': { type: 'videos', handler: handleVideos },
  'testimonios': { type: 'testimonials', handler: handleTestimonials },
  'asesores': { type: 'advisors', handler: handleAdvisors },
  'contacto': { type: 'contact', handler: handleContact },
  'vender': { type: 'sell', handler: handleSell },
  'rentas-vacacionales': { type: 'vacation-rentals', handler: handleVacationRentals },
  'listados-de': { type: 'curated-listings', handler: handleCuratedListings },
  'favoritos': { type: 'favorites', handler: handleFavorites },

  // INGL√âS
  'articles': { type: 'articles', handler: handleArticles },
  'advisors': { type: 'advisors', handler: handleAdvisors },
  'sell': { type: 'sell', handler: handleSell },
  'favorites': { type: 'favorites', handler: handleFavorites },

  // FRANC√âS
  'temoignages': { type: 'testimonials', handler: handleTestimonials },
  'vendre': { type: 'sell', handler: handleSell },
  'favoris': { type: 'favorites', handler: handleFavorites }
};
```

#### Flujo de una Request

```
1. Request: GET /content-backend/articulos/categoria/bienes-raices
                                ‚Üì
2. parseContentPath() ‚Üí { language: 'es', contentSegments: ['articulos', 'categoria', 'bienes-raices'] }
                                ‚Üì
3. getContentRouteInfo() ‚Üí { type: 'articles', handler: handleArticles, remainingSegments: ['categoria', 'bienes-raices'] }
                                ‚Üì
4. detectCountryAndDomain() ‚Üí { country: { code: 'DOM', ... }, realDomain: 'https://clicinmobiliaria.com' }
                                ‚Üì
5. getBaseContentData() ‚Üí { globalConfig, hotItems, countryTag }
                                ‚Üì
6. handleArticles(params) ‚Üí Ejecuta l√≥gica espec√≠fica de art√≠culos
                                ‚Üì
7. enrichSEO() ‚Üí Agrega hreflang, structured_data, open_graph, twitter_card
                                ‚Üì
8. Response JSON con toda la data procesada
```

---

### Handler: `sell-handler.ts`

**Prop√≥sito**: Genera datos para la p√°gina de "Vender mi Propiedad".

**Funcionalidad clave**: Usa el campo `real_data` del pa√≠s para decidir si mostrar datos reales o ficticios.

```typescript
// Obtener configuraci√≥n del pa√≠s
const hideRealData = !baseData.country.real_data;

// Si real_data = false, generar n√∫meros ficticios
if (hideRealData) {
  stats.topAgents = stats.topAgents.map(agent => ({
    ...agent,
    totalSales: faker.number.int({ min: 30000000, max: 120000000 }),
    propertiesSold: faker.number.int({ min: 15, max: 80 }),
    avgDaysOnMarket: faker.number.int({ min: 20, max: 70 })
  }));
}
```

**Datos que retorna**:
- `stats`: Estad√≠sticas de mercado (ventas, propiedades activas, d√≠as promedio)
- `topAgents`: Agentes l√≠deres (con datos reales o ficticios)
- `services`: Servicios premium ofrecidos
- `testimonials`: Testimonios de clientes
- `faqs`: Preguntas frecuentes
- `seo`: Metadatos SEO completos

---

### Handler: `articles-handler.ts`

**Prop√≥sito**: Maneja art√≠culos del blog con soporte multiidioma.

**Tipos de p√°ginas que maneja**:
1. **articles-main**: P√°gina principal de art√≠culos
2. **articles-category**: Art√≠culos filtrados por categor√≠a
3. **articles-single**: Art√≠culo individual

**L√≥gica de detecci√≥n**:
```typescript
if (contentSegments.length === 0) {
  // P√°gina principal: /articulos
  return handleMainArticles();
}

const firstSegment = contentSegments[0];
const categoryExists = await checkIfCategoryExists(firstSegment);

if (categoryExists && contentSegments.length === 1) {
  // Categor√≠a: /articulos/inversiones
  return handleCategoryArticles(category);
}

// Single article: /articulos/guia-comprar-punta-cana
return handleSingleArticle(slug);
```

**Procesamiento multiidioma**:
```typescript
function processMultilingualContent(item, language, contentField = 'content') {
  if (language === 'en' && item.content_en) {
    const contentEn = JSON.parse(item.content_en);
    return { title: contentEn.title, excerpt: contentEn.excerpt, ... };
  }
  // Fallback a espa√±ol
  return { title: item.title, excerpt: item.excerpt, ... };
}
```

---

### Handler: `curated-listings-handler.ts`

**Prop√≥sito**: Genera listados curados de propiedades (colecciones especiales).

**Flujo**:
```
1. Recibe slug: "propiedades-frente-al-mar"
2. Busca en tabla curated_listings
3. Obtiene tags asociados al curated listing
4. Consulta propiedades que tengan esos tags
5. Retorna propiedades + metadatos del curated listing
```

**Diferencia con b√∫squeda normal**:
- Curated listings: Colecci√≥n pre-definida con t√≠tulo/descripci√≥n/imagen
- B√∫squeda: Filtrado din√°mico por tags

---

### Handler: `country-detector.ts`

**Prop√≥sito**: Detectar pa√≠s y dominio desde la request.

**L√≥gica de detecci√≥n**:
```typescript
1. Modo testing: ?country=DOM ‚Üí Forzar pa√≠s
2. Custom domain: clicinmobiliaria.com ‚Üí DOM
3. Subdomain: pa.clicinmobiliaria.com ‚Üí PAN
4. Default: Rep√∫blica Dominicana
```

**Consultas a DB**:
```sql
-- Buscar por custom_domain
SELECT id, name, code, country_tag_id, subdomain, custom_domain, currency, timezone, real_data
FROM countries
WHERE custom_domain = 'clicinmobiliaria.com' AND active = true;

-- Buscar por subdomain
SELECT ... FROM countries WHERE subdomain = 'pa' AND active = true;
```

**‚ö†Ô∏è IMPORTANTE**: Este handler **SIEMPRE** debe incluir `real_data` en el SELECT para que funcione correctamente el sistema de datos reales/ficticios.

---

### Handler: `advisors-handler.ts`

**Prop√≥sito**: Gestiona p√°ginas de asesores (listado y perfil individual).

**Datos que consulta**:
```sql
SELECT
  id, first_name, last_name, email, phone, whatsapp,
  bio, photo_url, specialties, languages, active, slug,
  total_sales, properties_sold, avg_rating
FROM agents
WHERE active = true
```

**Multiidioma en bio**:
```typescript
// Si el agente tiene content_en/content_fr
if (language === 'en' && agent.content_en) {
  const contentEn = JSON.parse(agent.content_en);
  agent.bio = contentEn.bio;
}
```

---

### Handler: `favorites-handler.ts`

**Prop√≥sito**: Sistema de favoritos compartidos entre usuarios.

**Funcionalidades**:
1. Crear lista de favoritos compartida
2. Agregar/quitar propiedades de la lista
3. Compartir lista con otros usuarios
4. Ver reacciones (likes, dislikes, comments) de otros

**Tablas involucradas**:
- `favorite_visitors`: Qui√©n accede a la lista
- `favorite_reactions`: Reacciones a propiedades

**Flujo de uso**:
```
Usuario A crea lista ‚Üí Obtiene ID: "abc123"
Usuario A comparte link: /favoritos/abc123
Usuario B accede ‚Üí Se registra en favorite_visitors
Usuario B da like a propiedad ‚Üí Inserta en favorite_reactions
Usuario A ve reacciones de todos los visitantes
```

---

## Sistema Multiidioma

### Estrategia de Traducci√≥n

El sistema soporta **3 niveles de multiidioma**:

#### Nivel 1: URLs y Rutas
```
Espa√±ol:  /articulos/guia-comprar-casa
Ingl√©s:   /en/articles/buying-house-guide
Franc√©s:  /fr/articles/guide-achat-maison
```

#### Nivel 2: Contenido en Base de Datos

**Estrategia A: Campos separados**
```sql
-- Tabla: content_articles
title VARCHAR          -- "Gu√≠a para Comprar"
slug VARCHAR           -- "guia-comprar"
slug_en VARCHAR        -- "buying-guide"
slug_fr VARCHAR        -- "guide-achat"
```

**Estrategia B: JSONB**
```sql
-- Tabla: content_articles
content_en JSONB       -- { "title": "...", "excerpt": "...", "content": "..." }
content_fr JSONB       -- { "title": "...", "excerpt": "...", "content": "..." }
```

#### Nivel 3: Configuraci√≥n Global (JSONB en `countries.config`)

```json
{
  "translations": {
    "es": {
      "search_placeholder": "Buscar propiedades...",
      "contact_us": "Cont√°ctanos"
    },
    "en": {
      "search_placeholder": "Search properties...",
      "contact_us": "Contact us"
    },
    "fr": {
      "search_placeholder": "Rechercher des propri√©t√©s...",
      "contact_us": "Contactez-nous"
    }
  }
}
```

---

### Procesamiento de Contenido Multiidioma

**Funci√≥n helper universal** (usada en todos los handlers):
```typescript
function processMultilingualContent(item, language, contentField = 'content') {
  let processed = {};

  if (language === 'en' && item[`${contentField}_en`]) {
    const contentEn = typeof item[`${contentField}_en`] === 'string'
      ? JSON.parse(item[`${contentField}_en`])
      : item[`${contentField}_en`];
    processed = { ...contentEn };
  } else if (language === 'fr' && item[`${contentField}_fr`]) {
    const contentFr = typeof item[`${contentField}_fr`] === 'string'
      ? JSON.parse(item[`${contentField}_fr`])
      : item[`${contentField}_fr`];
    processed = { ...contentFr };
  }

  // Retornar con fallback a espa√±ol
  return {
    title_display: processed.title || item.title || '',
    description_display: processed.description || item.description || '',
    excerpt_display: processed.excerpt || item.excerpt || ''
  };
}
```

---

### Detecci√≥n de Idioma

**Desde la URL**:
```typescript
function parseContentPath(pathAfterContentBackend) {
  const segments = pathAfterContentBackend.split('/').filter(s => s);

  let language = 'es';  // Default espa√±ol
  let contentSegments = [...segments];

  if (segments.length > 0) {
    const firstSegment = segments[0];
    if (firstSegment === 'en' || firstSegment === 'fr') {
      language = firstSegment;
      contentSegments = segments.slice(1);  // Remover prefijo de idioma
    }
  }

  return { language, contentSegments };
}
```

**Ejemplos**:
```
/content-backend/articulos        ‚Üí language: 'es', segments: ['articulos']
/content-backend/en/articles      ‚Üí language: 'en', segments: ['articles']
/content-backend/fr/temoignages   ‚Üí language: 'fr', segments: ['temoignages']
```

---

### Hreflang Autom√°tico

El sistema genera autom√°ticamente etiquetas hreflang para SEO:

```typescript
function buildHreflangUrls(contentSegments, language, trackingString, globalConfig, domainInfo) {
  const languages = ['es', 'en', 'fr'];
  const routeTranslations = {
    'articulos': { en: 'articles', fr: 'articles' },
    'vender': { en: 'sell', fr: 'vendre' }
  };

  const hreflangObject = {};

  languages.forEach(targetLang => {
    let translatedSegments = contentSegments.map(segment => {
      if (targetLang === 'es') return segment;
      const translation = routeTranslations[segment];
      return translation?.[targetLang] || segment;
    });

    let path = translatedSegments.join('/');
    if (targetLang !== 'es') path = targetLang + '/' + path;

    hreflangObject[targetLang] = baseDomain + '/' + path + trackingString;
  });

  return hreflangObject;
}
```

**Output**:
```json
{
  "es": "https://clicinmobiliaria.com/articulos/guia-comprar",
  "en": "https://clicinmobiliaria.com/en/articles/buying-guide",
  "fr": "https://clicinmobiliaria.com/fr/articles/guide-achat"
}
```

---

## Tipos de P√°ginas y Layouts

### Estructura de Layouts en Astro

Todos los layouts extienden de `Layout.astro` (layout base).

```
Layout.astro (Base)
  ‚îú‚îÄ HomepageLayout.astro
  ‚îú‚îÄ PropertyListLayout.astro
  ‚îú‚îÄ SinglePropertyLayout.astro
  ‚îú‚îÄ ArticlesMainLayout.astro
  ‚îú‚îÄ ArticlesSingleLayout.astro
  ‚îú‚îÄ ArticlesCategoryLayout.astro
  ‚îú‚îÄ VideosMainLayout.astro
  ‚îú‚îÄ VideosSingleLayout.astro
  ‚îú‚îÄ TestimonialsMainLayout.astro
  ‚îú‚îÄ AdvisorsLayout.astro
  ‚îú‚îÄ SingleAdvisorLayout.astro
  ‚îú‚îÄ ContactLayout.astro
  ‚îú‚îÄ SellLayout.astro
  ‚îú‚îÄ FavoritesLayout.astro
  ‚îú‚îÄ SharedFavoritesLayout.astro
  ‚îú‚îÄ CuratedListingsLayout.astro
  ‚îú‚îÄ CuratedListingsSingleLayout.astro
  ‚îî‚îÄ VacationRentalsLayout.astro
```

---

### Layout Base: `Layout.astro`

**Prop√≥sito**: Layout ra√≠z que define estructura HTML, estilos globales, y metadatos SEO.

**Props que recibe**:
```typescript
interface Props {
  seo?: {
    title: string
    description: string
    canonical_url: string
    keywords?: string
    hreflang?: { es: string, en: string, fr: string }
    structured_data?: object
    open_graph?: object
    twitter_card?: object
  }
  globalConfig?: object
  language?: 'es' | 'en' | 'fr'
}
```

**Responsabilidades**:
- Inyectar `<title>`, `<meta description>`, canonical
- Generar hreflang links
- Inyectar Schema.org JSON-LD
- Cargar estilos globales (`global.css`, `utilities.css`)
- Renderizar header y footer

---

### SinglePropertyLayout.astro

**Prop√≥sito**: Renderizar p√°gina de una propiedad individual.

**Data que recibe** (del edge function):
```typescript
{
  property: {
    id, name, description, slug_url,
    price_display: "US$350,000",        // Ya formateado
    operation_display: "Venta",         // Ya traducido
    bedrooms, bathrooms, parking_spots,
    built_area, land_area,
    processed_images: {
      main_image, gallery_images, final_images
    },
    exact_coordinates: { lat, lng },
    property_categories: [...],
    cities: { name, provinces: { name } },
    sectors: { name },
    property_amenities: [...]
  },
  agent: {
    main: { first_name, last_name, photo_url, whatsapp, ... },
    properties_count: 25,
    cocaptors: [...]                    // Co-asesores
  },
  related_content: {
    similar_properties: [...],
    articles: [...],
    videos: [...],
    faqs: [...],
    testimonials: [...]
  },
  project_details: { ... },             // Si is_project = true
  seo: { ... }
}
```

**Componentes que usa**:
- `PropertyHero.astro` - Hero con im√°genes en carousel
- `PropertyDetails.astro` - Tabla de caracter√≠sticas (habitaciones, ba√±os, etc)
- `PropertyDescription.astro` - Descripci√≥n HTML completa
- `PropertyAmenities.astro` - Grid de amenidades con iconos
- `PropertyLocation.astro` - Mapa con coordenadas
- `PropertyVideos.astro` - Videos embebidos
- `PropertyFAQs.astro` - Preguntas frecuentes
- `PropertySimilar.astro` - Propiedades similares
- `AgentWidget.astro` - Sidebar con info del asesor
- `CalculatorWidget.astro` - Calculadora de hipoteca

---

### PropertyListLayout.astro

**Prop√≥sito**: Listado de propiedades con filtros y paginaci√≥n.

**Data que recibe**:
```typescript
{
  properties: [...],                    // Array de propiedades
  pagination: {
    page: 1,
    totalPages: 10,
    total: 320,
    hasNext: true,
    hasPrev: false
  },
  filters: {
    tags: [...],                        // Tags activos
    priceRange: { min: 0, max: 1000000 },
    bedrooms: 3,
    operationType: 'sale'
  },
  searchTags: {                         // Tags disponibles para filtros
    tags: {
      provincia: [...],
      ciudad: [...],
      sector: [...],
      categoria: [...]
    },
    currencies: { available: ['USD', 'DOP'], default: 'USD' }
  },
  seo: { ... }
}
```

**Componentes principales**:
- `PropertyList.astro` - Grid de propiedades
  - Prop `maxColumns` (3 o 4) para controlar columnas
- `SearchFilters.astro` - Sidebar con filtros
- `Pagination.astro` - Navegaci√≥n entre p√°ginas

---

### ArticlesSingleLayout.astro

**Prop√≥sito**: Art√≠culo individual del blog.

**Data que recibe**:
```typescript
{
  article: {
    id, title, subtitle, excerpt, content,
    featuredImage, publishedAt, updatedAt,
    readTime: "5 min",
    category: "Inversiones",
    tags: [...],
    author: {
      name, avatar, position, bio, phone, whatsapp, email
    }
  },
  relatedArticles: [...],               // Art√≠culos relacionados
  category: {
    name, slug, description
  },
  seo: { ... }
}
```

**Secciones**:
- Hero con imagen destacada
- Breadcrumbs
- Contenido HTML completo
- Autor del art√≠culo
- Art√≠culos relacionados
- Compartir en redes sociales

---

### ArticlesMainLayout.astro

**Prop√≥sito**: P√°gina principal del blog con art√≠culos destacados.

**Data que recibe**:
```typescript
{
  featuredArticles: [...],              // Art√≠culos destacados (featured = true)
  recentArticles: [...],                // Art√≠culos recientes
  categories: [...],                    // Categor√≠as disponibles
  pagination: { ... },
  seo: { ... }
}
```

---

### ArticlesCategoryLayout.astro

**Prop√≥sito**: Art√≠culos filtrados por categor√≠a (ej: /articulos/inversiones).

Similar a ArticlesMainLayout pero con art√≠culos de una sola categor√≠a.

---

### SellLayout.astro

**Prop√≥sito**: P√°gina de "Vender mi Propiedad" con servicios y asesores.

**Data que recibe**:
```typescript
{
  stats: {
    totalSales: 50000000,               // Total vendido (real o fake)
    activeProperties: 250,
    avgDaysOnMarket: 45,
    satisfactionRate: 98
  },
  topAgents: [...],                     // Agentes l√≠deres (con stats reales o fake)
  services: [                           // Servicios premium
    { icon: 'chart-line', title: 'An√°lisis de Mercado', description: '...' },
    { icon: 'dollar-sign', title: 'Tasaci√≥n y Estrategia de Precio', description: '...' }
  ],
  testimonials: [...],                  // Testimonios de vendedores
  faqs: [...],
  marketHighlights: {
    topCities: [...],
    topSectors: [...],
    categories: {...}
  },
  seo: { ... }
}
```

**Secciones importantes**:
- Hero con CTA "Vender mi Propiedad"
- Servicios premium (6 cards con iconos)
- Agentes l√≠deres (con glassmorphism en fondo oscuro)
- Estad√≠sticas de mercado
- Testimonios
- FAQs

**‚ö†Ô∏è Campo `real_data` en acci√≥n**:
```typescript
// En sell-handler.ts
const hideRealData = !baseData.country.real_data;

if (hideRealData) {
  stats.topAgents = stats.topAgents.map(agent => ({
    ...agent,
    totalSales: faker.number.int({ min: 30000000, max: 120000000 }),  // N√∫meros falsos
    propertiesSold: faker.number.int({ min: 15, max: 80 })
  }));
}
```

---

### CuratedListingsSingleLayout.astro

**Prop√≥sito**: Listado curado con sidebar y descripci√≥n.

**Diferencia con PropertyListLayout**:
- Tiene sidebar con info del curated listing
- Usa `maxColumns={3}` en PropertyList (3 columnas en vez de 4)
- Muestra descripci√≥n y metadata del curated listing

**Data que recibe**:
```typescript
{
  curatedListing: {
    id, title, description, featuredImage, slug
  },
  properties: [...],
  pagination: { ... },
  tags: [...],                          // Tags asociados al curated listing
  seo: { ... }
}
```

---

### ContactLayout.astro

**Prop√≥sito**: Formulario de contacto.

**Funcionalidad**:
- Formulario con campos: nombre, tel√©fono, email, tipo_servicio, mensaje
- Captura autom√°tica de tracking (UTM params, fbclid, gclid)
- Env√≠a a edge function `contact-submission`
- Guarda en tabla `contact_submissions`

**Tracking autom√°tico**:
```typescript
// JavaScript en el layout
const urlParams = new URLSearchParams(window.location.search);
const trackingData = {
  utm_source: urlParams.get('utm_source'),
  utm_medium: urlParams.get('utm_medium'),
  utm_campaign: urlParams.get('utm_campaign'),
  utm_content: urlParams.get('utm_content'),
  utm_term: urlParams.get('utm_term'),
  ref: urlParams.get('ref'),
  fbclid: urlParams.get('fbclid'),
  gclid: urlParams.get('gclid'),
  referer: document.referrer,
  user_agent: navigator.userAgent
};

// Enviar junto con el formulario
```

---

## Flujo de Datos

### Flujo Completo: Desde Request hasta Render

#### Ejemplo: Usuario visita `/articulos/inversiones/guia-comprar-punta-cana`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. BROWSER REQUEST                                              ‚îÇ
‚îÇ    GET https://clicinmobiliaria.com/articulos/inversiones/      ‚îÇ
‚îÇ        guia-comprar-punta-cana?utm_source=google                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. ASTRO ROUTING (src/pages/[...slug].astro)                   ‚îÇ
‚îÇ    Captura: slug = ['articulos', 'inversiones',                 ‚îÇ
‚îÇ                     'guia-comprar-punta-cana']                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. FETCH TO EDGE FUNCTION                                       ‚îÇ
‚îÇ    const response = await fetch(                                ‚îÇ
‚îÇ      'https://pacewqgypevfgjmdsorz.supabase.co/functions/v1/    ‚îÇ
‚îÇ       content-backend/articulos/inversiones/                    ‚îÇ
‚îÇ       guia-comprar-punta-cana?utm_source=google'                ‚îÇ
‚îÇ    );                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. EDGE FUNCTION: content-backend/index.ts                      ‚îÇ
‚îÇ    - parseContentPath() ‚Üí language: 'es', segments:             ‚îÇ
‚îÇ      ['articulos', 'inversiones', 'guia-comprar-punta-cana']    ‚îÇ
‚îÇ    - detectCountryAndDomain() ‚Üí country: DOM                    ‚îÇ
‚îÇ    - getContentRouteInfo() ‚Üí handler: handleArticles           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. HANDLER: articles-handler.ts                                 ‚îÇ
‚îÇ    - Detecta: 2 segments ‚Üí Categor√≠a + Slug                    ‚îÇ
‚îÇ    - Query 1: Buscar categor√≠a "inversiones"                   ‚îÇ
‚îÇ    - Query 2: Buscar art√≠culo con slug "guia-comprar-punta-cana"‚îÇ
‚îÇ    - Query 3: Art√≠culos relacionados (misma categor√≠a)          ‚îÇ
‚îÇ    - Query 4: Tags del art√≠culo                                 ‚îÇ
‚îÇ    - processMultilingualContent() ‚Üí Traducir si language != es ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. ENRICH SEO: enrichSEO()                                      ‚îÇ
‚îÇ    - buildHreflangUrls() ‚Üí { es: '...', en: '...', fr: '...' } ‚îÇ
‚îÇ    - generateArticlesSchema() ‚Üí Schema.org Article              ‚îÇ
‚îÇ    - generateOpenGraph() ‚Üí OG tags                              ‚îÇ
‚îÇ    - generateTwitterCard() ‚Üí Twitter card                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. RESPONSE JSON                                                ‚îÇ
‚îÇ    {                                                             ‚îÇ
‚îÇ      pageType: 'articles-single',                               ‚îÇ
‚îÇ      article: { title, content, author, ... },                  ‚îÇ
‚îÇ      relatedArticles: [...],                                    ‚îÇ
‚îÇ      category: { name: 'Inversiones', ... },                    ‚îÇ
‚îÇ      seo: {                                                      ‚îÇ
‚îÇ        title: 'Gu√≠a para Comprar en Punta Cana | CLIC',        ‚îÇ
‚îÇ        hreflang: { es: '...', en: '...', fr: '...' },           ‚îÇ
‚îÇ        structured_data: { @type: 'Article', ... }               ‚îÇ
‚îÇ      },                                                          ‚îÇ
‚îÇ      globalConfig: { contact, social, features, ... },          ‚îÇ
‚îÇ      language: 'es',                                            ‚îÇ
‚îÇ      trackingString: '?utm_source=google'                       ‚îÇ
‚îÇ    }                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. ASTRO COMPONENT: [...slug].astro                             ‚îÇ
‚îÇ    - Detecta pageType: 'articles-single'                        ‚îÇ
‚îÇ    - Selecciona layout: ArticlesSingleLayout                    ‚îÇ
‚îÇ    - Pasa data como prop                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 9. RENDER: ArticlesSingleLayout.astro                           ‚îÇ
‚îÇ    - Extrae article, seo, relatedArticles de props              ‚îÇ
‚îÇ    - Renderiza hero con featuredImage                           ‚îÇ
‚îÇ    - Renderiza content HTML                                     ‚îÇ
‚îÇ    - Renderiza sidebar con autor y art√≠culos relacionados       ‚îÇ
‚îÇ    - Layout.astro inyecta SEO (hreflang, Schema.org, etc)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 10. HTML FINAL AL BROWSER                                       ‚îÇ
‚îÇ     <html>                                                       ‚îÇ
‚îÇ       <head>                                                     ‚îÇ
‚îÇ         <title>Gu√≠a para Comprar en Punta Cana | CLIC</title>  ‚îÇ
‚îÇ         <link rel="alternate" hreflang="es" href="..." />       ‚îÇ
‚îÇ         <link rel="alternate" hreflang="en" href="..." />       ‚îÇ
‚îÇ         <script type="application/ld+json">                     ‚îÇ
‚îÇ           { "@type": "Article", ... }                           ‚îÇ
‚îÇ         </script>                                                ‚îÇ
‚îÇ       </head>                                                    ‚îÇ
‚îÇ       <body>...</body>                                          ‚îÇ
‚îÇ     </html>                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Flujo de B√∫squeda de Propiedades

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usuario entra a: /comprar/punta-cana/apartamentos              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Edge Function: backend/index.ts                                 ‚îÇ
‚îÇ - Parsea: ['comprar', 'punta-cana', 'apartamentos']            ‚îÇ
‚îÇ - Detecta: B√∫squeda por tags                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ search-tags-handler.ts                                          ‚îÇ
‚îÇ - Convierte slugs a tag IDs:                                   ‚îÇ
‚îÇ   "punta-cana" ‚Üí tag_id: 45 (ciudad)                           ‚îÇ
‚îÇ   "apartamentos" ‚Üí tag_id: 12 (categoria)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ property-search.ts: searchPropertiesByTags()                    ‚îÇ
‚îÇ - Inyecta autom√°ticamente country_tag_id (DOM)                 ‚îÇ
‚îÇ - Query:                                                        ‚îÇ
‚îÇ   SELECT p.* FROM properties p                                  ‚îÇ
‚îÇ   JOIN property_tags pt ON pt.property_id = p.id               ‚îÇ
‚îÇ   WHERE pt.tag_id IN (45, 12, [country_tag])                   ‚îÇ
‚îÇ     AND p.availability = 1                                      ‚îÇ
‚îÇ     AND p.property_status = 'Publicada'                         ‚îÇ
‚îÇ   ORDER BY p.created_at DESC                                    ‚îÇ
‚îÇ   LIMIT 32 OFFSET 0                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Retorna:                                                        ‚îÇ
‚îÇ {                                                                ‚îÇ
‚îÇ   properties: [...],  // 32 propiedades                        ‚îÇ
‚îÇ   pagination: { page: 1, totalPages: 8, total: 245 },          ‚îÇ
‚îÇ   tags: [                                                       ‚îÇ
‚îÇ     { id: 45, slug: 'punta-cana', category: 'ciudad' },        ‚îÇ
‚îÇ     { id: 12, slug: 'apartamentos', category: 'categoria' }    ‚îÇ
‚îÇ   ]                                                              ‚îÇ
‚îÇ }                                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PropertyListLayout.astro renderiza:                             ‚îÇ
‚îÇ - Breadcrumbs: Inicio > Comprar > Punta Cana > Apartamentos    ‚îÇ
‚îÇ - Filtros (sidebar): Precio, Habitaciones, Ba√±os               ‚îÇ
‚îÇ - Grid de propiedades (4 columnas)                             ‚îÇ
‚îÇ - Paginaci√≥n                                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Sistema de Tags y B√∫squeda

### Arquitectura de Tags

El sistema de tags es el **n√∫cleo** de la b√∫squeda y categorizaci√≥n.

#### Jerarqu√≠a Completa

```
Nivel 1: Pa√≠s (pais)
  ‚îú‚îÄ Rep√∫blica Dominicana (DOM)
  ‚îú‚îÄ Panam√° (PAN)
  ‚îî‚îÄ M√©xico (MEX)

Nivel 2: Provincia (provincia)
  ‚îú‚îÄ La Altagracia
  ‚îú‚îÄ Distrito Nacional
  ‚îî‚îÄ Santiago

Nivel 3: Ciudad (ciudad)
  ‚îú‚îÄ Punta Cana
  ‚îú‚îÄ Santo Domingo
  ‚îî‚îÄ Santiago

Nivel 4: Sector (sector)
  ‚îú‚îÄ B√°varo
  ‚îú‚îÄ Naco
  ‚îî‚îÄ Los Jardines

Paralelo: Categor√≠as de Propiedad (categoria)
  ‚îú‚îÄ Apartamento
  ‚îú‚îÄ Villa
  ‚îú‚îÄ Casa
  ‚îú‚îÄ Penthouse
  ‚îî‚îÄ Proyecto

Paralelo: Caracter√≠sticas (caracteristica)
  ‚îú‚îÄ Piscina
  ‚îú‚îÄ Vista al mar
  ‚îú‚îÄ Cerca de la playa
  ‚îî‚îÄ Amueblado
```

---

### B√∫squeda por Tags: Inyecci√≥n Autom√°tica de Pa√≠s

**Problema**: Los usuarios buscan por ciudad/sector, pero necesitamos filtrar por pa√≠s autom√°ticamente.

**Soluci√≥n**: Inyecci√≥n autom√°tica del `country_tag_id`.

```typescript
// property-search.ts
async searchPropertiesByTags(tagIds, countryTagId, page = 1, limit = 32) {
  // ‚úÖ INYECCI√ìN AUTOM√ÅTICA DEL TAG DE PA√çS
  let finalTagIds = [...tagIds];
  let countryInjected = false;

  // Verificar si ya incluye el tag de pa√≠s
  const hasCountryTag = tagIds.some(id => {
    // Verificar en DB si es tag de categor√≠a "pais"
  });

  if (!hasCountryTag && countryTagId) {
    finalTagIds.push(countryTagId);  // Agregar pa√≠s autom√°ticamente
    countryInjected = true;
  }

  // Query con todos los tags (incluido pa√≠s)
  const query = `
    SELECT DISTINCT p.*
    FROM properties p
    JOIN property_tags pt ON pt.property_id = p.id
    WHERE pt.tag_id IN (${finalTagIds.join(',')})
      AND p.availability = 1
      AND p.property_status = 'Publicada'
  `;
}
```

**Resultado**: Usuario busca "Punta Cana + Apartamentos" ‚Üí Sistema agrega autom√°ticamente "Rep√∫blica Dominicana".

---

### URLs Amigables con Tags

**Formato**: `/{operacion}/{ubicacion}/{categoria}`

**Ejemplos**:
```
/comprar/punta-cana/apartamentos
/alquilar/santo-domingo/casas
/venta/bavaro/villas-de-lujo
```

**Procesamiento**:
```typescript
// search-tags-handler.ts
async function validateTags(slugs, countryTag, language) {
  const { data: tags } = await supabase
    .from('tags')
    .select('id, slug, category, display_name')
    .in('slug', slugs);

  // Convertir slugs a tag IDs
  const tagIds = tags.map(t => t.id);

  return { validTags: tags, tagIds };
}
```

---

### Search Tags Handler

**Prop√≥sito**: Generar filtros disponibles para la b√∫squeda.

**Retorna**:
```typescript
{
  tags: {
    provincia: [
      { id: 1, slug: 'la-altagracia', display_name: 'La Altagracia' },
      { id: 2, slug: 'distrito-nacional', display_name: 'Distrito Nacional' }
    ],
    ciudad: [
      { id: 10, slug: 'punta-cana', display_name: 'Punta Cana' },
      { id: 11, slug: 'santo-domingo', display_name: 'Santo Domingo' }
    ],
    sector: [...],
    categoria: [
      { id: 20, slug: 'apartamento', display_name: 'Apartamento' },
      { id: 21, slug: 'villa', display_name: 'Villa' }
    ]
  },
  currencies: {
    available: ['USD', 'DOP'],
    default: 'USD',
    rates: { USD: 1, DOP: 58.5 }
  },
  priceRanges: {
    sale: {
      USD: [
        { min: 0, max: 100000, label: 'Menos de US$100K' },
        { min: 100000, max: 250000, label: 'US$100K - US$250K' }
      ],
      DOP: [...]
    },
    rental: {...}
  }
}
```

**Uso**: El frontend usa este objeto para renderizar filtros en sidebar.

---

## Gu√≠a para Desarrollar un CRM

Si quieres crear un CRM para gestionar este sistema inmobiliario, aqu√≠ est√° todo lo que necesitas saber:

---

### 1. Autenticaci√≥n y Roles

**Tabla sugerida**: `users` (ya existe en Supabase Auth)

```sql
-- Extender auth.users con perfil
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  role VARCHAR CHECK (role IN ('admin', 'agent', 'manager', 'viewer')),
  agent_id INTEGER REFERENCES agents(id),  -- Vincular con tabla agents
  permissions JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Roles sugeridos**:
- `admin`: Acceso completo (gesti√≥n de pa√≠ses, configuraciones, usuarios)
- `manager`: Gesti√≥n de propiedades, agentes, contenido
- `agent`: Gesti√≥n de sus propias propiedades y leads
- `viewer`: Solo lectura (para clientes o inversionistas)

---

### 2. Dashboard Principal

**M√©tricas clave a mostrar**:

```sql
-- Total de propiedades activas
SELECT COUNT(*) FROM properties
WHERE availability = 1 AND property_status = 'Publicada';

-- Propiedades por estado
SELECT property_status, COUNT(*)
FROM properties
GROUP BY property_status;

-- Contactos recibidos (√∫ltimos 30 d√≠as)
SELECT COUNT(*) FROM contact_submissions
WHERE created_at >= NOW() - INTERVAL '30 days';

-- Contactos por estado
SELECT status, COUNT(*)
FROM contact_submissions
GROUP BY status;

-- Vistas de propiedades (top 10)
SELECT id, name, views
FROM properties
ORDER BY views DESC
LIMIT 10;

-- Propiedades por agente
SELECT
  a.first_name || ' ' || a.last_name AS agent_name,
  COUNT(p.id) AS total_properties,
  SUM(CASE WHEN p.property_status = 'Publicada' THEN 1 ELSE 0 END) AS active
FROM agents a
LEFT JOIN properties p ON p.agent_id = a.id
GROUP BY a.id, agent_name;
```

---

### 3. M√≥dulo: Gesti√≥n de Propiedades

**Funcionalidades**:
- ‚úÖ Crear/Editar/Eliminar propiedades
- ‚úÖ Cambiar estado (Publicada, Vendida, Retirada, Borrador)
- ‚úÖ Asignar agente principal
- ‚úÖ Gestionar galer√≠a de im√°genes
- ‚úÖ Asignar tags (ubicaci√≥n, categor√≠a, caracter√≠sticas)
- ‚úÖ Configurar m√∫ltiples precios (venta, alquiler, temporal, amueblado)
- ‚úÖ Ver historial de cambios (auditor√≠a)
- ‚úÖ Duplicar propiedad

**Queries importantes**:

```sql
-- Crear propiedad
INSERT INTO properties (
  code, name, description, slug_url,
  sale_price, sale_currency,
  bedrooms, bathrooms, built_area,
  agent_id, property_status, availability
) VALUES (
  'CLIC-2025-001', 'Villa en B√°varo', 'Descripci√≥n...', '/villa-bavaro',
  350000, 'USD',
  3, 2.5, 180,
  5, 'Publicada', 1
) RETURNING id;

-- Asignar tags a propiedad
INSERT INTO property_tags (property_id, tag_id)
VALUES
  (123, 45),  -- Punta Cana (ciudad)
  (123, 12),  -- Villa (categoria)
  (123, 67);  -- Piscina (caracteristica)

-- Actualizar im√°genes
UPDATE properties
SET main_image_url = 'https://...',
    gallery_images_url = 'https://...,https://...,https://...'
WHERE id = 123;
```

---

### 4. M√≥dulo: Gesti√≥n de Contactos (Leads)

**Funcionalidades**:
- ‚úÖ Ver todos los contactos (tabla con filtros)
- ‚úÖ Filtrar por estado, tipo_servicio, fecha, utm_source
- ‚úÖ Cambiar estado (pendiente ‚Üí contactado ‚Üí en_proceso ‚Üí completado)
- ‚úÖ Asignar contacto a un agente
- ‚úÖ Ver tracking completo (UTM params, referer, IP)
- ‚úÖ Exportar a CSV/Excel
- ‚úÖ Integraci√≥n con WhatsApp (link directo)

**Query para dashboard de leads**:

```sql
-- Contactos pendientes (√∫ltimos 7 d√≠as)
SELECT
  id, nombre, telefono, email, tipo_servicio,
  utm_source, utm_campaign,
  created_at
FROM contact_submissions
WHERE status = 'pendiente'
  AND created_at >= NOW() - INTERVAL '7 days'
ORDER BY created_at DESC;

-- Estad√≠sticas de conversi√≥n por fuente
SELECT
  utm_source,
  COUNT(*) AS total_leads,
  SUM(CASE WHEN status = 'completado' THEN 1 ELSE 0 END) AS converted,
  ROUND(
    SUM(CASE WHEN status = 'completado' THEN 1 ELSE 0 END)::DECIMAL / COUNT(*) * 100,
    2
  ) AS conversion_rate
FROM contact_submissions
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY utm_source
ORDER BY total_leads DESC;
```

---

### 5. M√≥dulo: Gesti√≥n de Agentes

**Funcionalidades**:
- ‚úÖ Crear/Editar/Desactivar agentes
- ‚úÖ Ver propiedades asignadas a cada agente
- ‚úÖ Ver estad√≠sticas de ventas
- ‚úÖ Gestionar bio multiidioma (content_en, content_fr)
- ‚úÖ Subir foto de perfil
- ‚úÖ Asignar especialidades y idiomas

**Estad√≠sticas de agente**:

```sql
-- Dashboard de un agente
SELECT
  a.id,
  a.first_name || ' ' || a.last_name AS name,
  a.total_sales,
  a.properties_sold,
  COUNT(p.id) AS active_properties,
  SUM(CASE WHEN p.property_status = 'Vendida' THEN 1 ELSE 0 END) AS sold_properties,
  AVG(p.sale_price) AS avg_price
FROM agents a
LEFT JOIN properties p ON p.agent_id = a.id
WHERE a.id = 5
GROUP BY a.id;
```

**‚ö†Ô∏è Control de datos reales/ficticios**:

```sql
-- Al mostrar estad√≠sticas de ventas, verificar real_data
SELECT c.real_data
FROM countries c
WHERE c.code = 'DOM';

-- Si real_data = false, generar n√∫meros ficticios en el backend
```

---

### 6. M√≥dulo: Gesti√≥n de Contenido (CMS)

**Art√≠culos**:
- ‚úÖ Crear/Editar/Publicar/Archivar art√≠culos
- ‚úÖ Editor WYSIWYG (TinyMCE, Tiptap, etc.)
- ‚úÖ Gestionar traducciones (content_en, content_fr)
- ‚úÖ Asignar categor√≠a y tags
- ‚úÖ SEO: Meta title, meta description, slug personalizado
- ‚úÖ Programar publicaci√≥n (published_at futuro)
- ‚úÖ Previsualizar antes de publicar

**Videos**:
- Similar a art√≠culos
- Campo adicional: `video_url` (YouTube, Vimeo)
- Auto-detectar duraci√≥n y thumbnail

**Testimonios**:
- Formulario simple con rating (1-5 estrellas)
- Vincular con propiedad (opcional)
- Traducci√≥n de testimonio

---

### 7. M√≥dulo: Configuraci√≥n Multi-Pa√≠s

**Funcionalidades**:
- ‚úÖ Gestionar pa√≠ses activos
- ‚úÖ Editar configuraci√≥n JSONB (contact, social, legal, features)
- ‚úÖ Configurar dominios y subdominios
- ‚úÖ **Toggle `real_data`** (IMPORTANTE para ocultar/mostrar datos reales)
- ‚úÖ Gestionar traducciones globales
- ‚úÖ Configurar moneda y timezone

**Interface sugerida para editar config JSONB**:

```typescript
// CRM Frontend - Form de configuraci√≥n
interface CountryConfigForm {
  contact: {
    phone: string;
    email: string;
    address: string;
  };
  social: {
    company: {
      facebook: string;
      instagram: string;
      youtube: string;
    };
  };
  legal: {
    company_name: string;
    company_full_name: string;
    logo_url: string;
  };
  // ... resto de campos
}

// Guardar en DB
UPDATE countries
SET config = '{ "contact": { ... }, "social": { ... } }'::jsonb
WHERE code = 'DOM';
```

---

### 8. M√≥dulo: Gesti√≥n de Tags

**Funcionalidades**:
- ‚úÖ Crear/Editar/Eliminar tags
- ‚úÖ Vista jer√°rquica (√°rbol de tags)
- ‚úÖ Asignar parent_id (para jerarqu√≠a)
- ‚úÖ Gestionar traducciones (slug_en, slug_fr, display_name_en, display_name_fr)
- ‚úÖ Activar/Desactivar tags
- ‚úÖ Reordenar (priority)

**Query para √°rbol de tags**:

```sql
-- Tags jer√°rquicos (pa√≠s ‚Üí provincia ‚Üí ciudad ‚Üí sector)
WITH RECURSIVE tag_tree AS (
  -- Nivel 1: Pa√≠ses
  SELECT
    id, slug, display_name, category, parent_id,
    1 AS level,
    ARRAY[id] AS path
  FROM tags
  WHERE category = 'pais' AND active = true

  UNION ALL

  -- Niveles hijos
  SELECT
    t.id, t.slug, t.display_name, t.category, t.parent_id,
    tt.level + 1,
    tt.path || t.id
  FROM tags t
  JOIN tag_tree tt ON t.parent_id = tt.id
  WHERE t.active = true
)
SELECT * FROM tag_tree
ORDER BY path;
```

---

### 9. M√≥dulo: Reportes y Anal√≠ticas

**Reportes sugeridos**:

**A. Reporte de Conversi√≥n de Leads**:
```sql
SELECT
  DATE_TRUNC('month', created_at) AS mes,
  tipo_servicio,
  COUNT(*) AS total_leads,
  SUM(CASE WHEN status = 'completado' THEN 1 ELSE 0 END) AS completados,
  ROUND(
    SUM(CASE WHEN status = 'completado' THEN 1 ELSE 0 END)::DECIMAL / COUNT(*) * 100,
    2
  ) AS tasa_conversion
FROM contact_submissions
WHERE created_at >= NOW() - INTERVAL '6 months'
GROUP BY mes, tipo_servicio
ORDER BY mes DESC;
```

**B. Reporte de ROI por Canal de Marketing**:
```sql
SELECT
  utm_source,
  utm_campaign,
  COUNT(*) AS total_leads,
  SUM(CASE WHEN status = 'completado' THEN 1 ELSE 0 END) AS ventas,
  -- Puedes agregar campo 'commission' o 'revenue' en contact_submissions
  SUM(tracking_data->>'revenue')::DECIMAL AS revenue_total
FROM contact_submissions
WHERE utm_source IS NOT NULL
GROUP BY utm_source, utm_campaign
ORDER BY revenue_total DESC NULLS LAST;
```

**C. Reporte de Propiedades M√°s Vistas**:
```sql
SELECT
  p.id,
  p.name,
  p.slug_url,
  p.views,
  p.property_status,
  a.first_name || ' ' || a.last_name AS agent_name
FROM properties p
LEFT JOIN agents a ON a.id = p.agent_id
ORDER BY p.views DESC
LIMIT 50;
```

**D. Tiempo Promedio en Mercado (Days on Market)**:
```sql
SELECT
  AVG(
    EXTRACT(DAY FROM (
      CASE
        WHEN property_status = 'Vendida' THEN updated_at
        ELSE NOW()
      END - created_at
    ))
  ) AS avg_days_on_market
FROM properties
WHERE availability = 1;
```

---

### 10. Integraciones Recomendadas para el CRM

**WhatsApp Business API**:
- Enviar mensajes autom√°ticos a leads
- Integraci√≥n con `contact_submissions.telefono`

**Email Marketing (Mailchimp, SendGrid)**:
- Sincronizar contactos autom√°ticamente
- Campa√±as segmentadas por `tipo_servicio`, `utm_source`

**Google Analytics / Facebook Pixel**:
- Tracking de conversiones
- Sincronizar con `utm_*` y `fbclid`/`gclid`

**Zapier / Make.com**:
- Automatizar workflows (ej: Nuevo contacto ‚Üí Notificar en Slack ‚Üí Asignar a agente)

**Supabase Realtime**:
- Notificaciones en tiempo real cuando llega nuevo contacto
- Dashboard live con WebSockets

---

### 11. Permisos y RLS (Row Level Security)

**Ejemplo de pol√≠tica para agentes**:

```sql
-- Los agentes solo pueden ver/editar sus propias propiedades
CREATE POLICY "Agents can view their own properties"
ON properties
FOR SELECT
TO authenticated
USING (
  agent_id = (
    SELECT agent_id FROM user_profiles
    WHERE id = auth.uid()
  )
);

-- Los managers pueden ver todas las propiedades
CREATE POLICY "Managers can view all properties"
ON properties
FOR SELECT
TO authenticated
USING (
  (SELECT role FROM user_profiles WHERE id = auth.uid()) = 'manager'
  OR
  (SELECT role FROM user_profiles WHERE id = auth.uid()) = 'admin'
);
```

---

## Resumen de Campos Cr√≠ticos

### Campo `real_data` en `countries`

**¬øQu√© hace?**
- `true`: Mostrar datos reales (ventas reales, estad√≠sticas reales de agentes)
- `false`: Mostrar datos ficticios (n√∫meros generados con Faker.js)

**¬øD√≥nde se usa?**
- `sell-handler.ts`: Estad√≠sticas de agentes l√≠deres
- `advisors-handler.ts`: Total de ventas de cada asesor
- Homepage: Estad√≠sticas de mercado

**¬øPor qu√© existe?**
- Privacidad: No revelar n√∫meros reales de ventas si el pa√≠s no lo permite
- Testing: Usar datos ficticios en staging sin afectar producci√≥n
- Marketing: Mostrar n√∫meros "aspiracionales" en pa√≠ses nuevos

**‚ö†Ô∏è IMPORTANTE**: Siempre incluir `real_data` en los SELECT de la tabla `countries`.

```sql
-- ‚úÖ CORRECTO
SELECT id, name, code, real_data FROM countries WHERE code = 'DOM';

-- ‚ùå INCORRECTO (faltar√≠a real_data)
SELECT id, name, code FROM countries WHERE code = 'DOM';
```

---

### Campo `slug_url` en `properties`

**¬øQu√© hace?**
- URL amigable para SEO (ej: `/mystic-bay-a-solo-2min-de-playa-gorda`)

**Variantes de b√∫squeda** (implementadas en `property-search.ts`):
```typescript
const searchVariants = [
  searchPath,                           // "mystic-bay-..."
  `/${searchPath}`,                     // "/mystic-bay-..."
  `/property/${searchPath}`,            // "/property/mystic-bay-..."
  `/properties/${searchPath}`,          // "/properties/mystic-bay-..."
  `${searchPath}/`                      // "mystic-bay-.../"
];
```

---

### Campos de precio en `properties`

**Sistema multi-precio**:
- `sale_price` / `sale_currency`: Venta
- `rental_price` / `rental_currency`: Alquiler mensual
- `temp_rental_price` / `temp_rental_currency`: Alquiler temporal (diario/semanal)
- `furnished_rental_price` / `furnished_rental_currency`: Alquiler amueblado
- `furnished_sale_price` / `furnished_sale_currency`: Venta amueblada

**Prioridad de visualizaci√≥n** (definida en `calculatePriceAndOperation()`):
```
1. sale_price (Venta)
2. furnished_sale_price (Venta Amueblada)
3. rental_price (Alquiler)
4. furnished_rental_price (Alquiler Amueblado)
5. temp_rental_price (Temporal)
6. "Consultar precio" (si no hay ninguno)
```

---

### Campo `property_status` en `properties`

**Valores posibles**:
- `Publicada`: Visible en b√∫squedas
- `Vendida`: Vendida (se puede mostrar como "Vendida" en single page)
- `Retirada`: Propiedad retirada del mercado
- `Borrador`: No visible, en edici√≥n

**Filtro en b√∫squedas**:
```sql
WHERE property_status = 'Publicada' AND availability = 1
```

---

### Campo `tracking_data` (JSONB) en `contact_submissions`

**Estructura sugerida**:
```json
{
  "page_url": "https://clicinmobiliaria.com/comprar/punta-cana/apartamentos",
  "user_agent": "Mozilla/5.0...",
  "ip_address": "192.168.1.1",
  "referer": "https://google.com",
  "utm_params": {
    "utm_source": "google",
    "utm_medium": "cpc",
    "utm_campaign": "verano-2024",
    "utm_content": "ad-variant-a",
    "utm_term": "apartamentos punta cana"
  },
  "click_ids": {
    "fbclid": "...",
    "gclid": "..."
  },
  "device": {
    "type": "mobile",
    "browser": "Chrome",
    "os": "Android"
  }
}
```

**B√∫squeda en JSONB**:
```sql
-- Buscar leads de campa√±a espec√≠fica
SELECT * FROM contact_submissions
WHERE tracking_data->'utm_params'->>'utm_campaign' = 'verano-2024';

-- Buscar leads de Facebook
SELECT * FROM contact_submissions
WHERE tracking_data->'click_ids'->>'fbclid' IS NOT NULL;
```

---

## Conclusi√≥n

Este documento cubre:
- ‚úÖ Todas las tablas principales y sus relaciones
- ‚úÖ Sistema completo de Edge Functions
- ‚úÖ Flujo de datos desde request hasta render
- ‚úÖ Sistema multiidioma (3 idiomas)
- ‚úÖ Sistema de tags jer√°rquico
- ‚úÖ B√∫squeda avanzada con inyecci√≥n autom√°tica de pa√≠s
- ‚úÖ Gu√≠a completa para construir un CRM
- ‚úÖ Queries SQL √∫tiles para reportes
- ‚úÖ Explicaci√≥n del campo `real_data` y su importancia

**Pr√≥ximos pasos para desarrollar CRM**:
1. Elegir stack (Next.js + Supabase, o React + Supabase)
2. Implementar autenticaci√≥n (Supabase Auth)
3. Crear m√≥dulos en este orden:
   - Dashboard (m√©tricas b√°sicas)
   - Gesti√≥n de propiedades
   - Gesti√≥n de contactos/leads
   - Gesti√≥n de agentes
   - Configuraci√≥n de pa√≠ses
   - CMS (art√≠culos, videos)
   - Reportes y anal√≠ticas

**Contacto para dudas**:
- Equipo CLIC Inmobiliaria
- Email: info@clicinmobiliaria.com
- WhatsApp: +1 809 487 2542

---

*Documento generado con Claude Code*
*√öltima actualizaci√≥n: 2025-10-25*
